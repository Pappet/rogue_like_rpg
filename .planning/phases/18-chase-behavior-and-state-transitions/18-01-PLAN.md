---
phase: 18-chase-behavior-and-state-transitions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ecs/systems/ai_system.py
  - game_states.py
  - tests/verify_chase_behavior.py
autonomous: true

must_haves:
  truths:
    - "A hostile NPC within perception range with LOS to the player transitions from WANDER or IDLE to CHASE"
    - "The message log shows 'The [name] notices you!' exactly once when an NPC first enters CHASE state"
    - "An NPC in CHASE state moves one greedy Manhattan step toward the player each enemy turn"
    - "After N turns without LOS to the player, the NPC returns to WANDER state"
    - "AI state tracks last-known player position as tile coordinates, not entity IDs"
  artifacts:
    - path: "ecs/systems/ai_system.py"
      provides: "Chase detection, pursuit, and lose-sight fallback in AISystem"
      contains: "_chase"
    - path: "game_states.py"
      provides: "Updated AISystem.process() call passing player_entity"
      contains: "player_entity"
    - path: "tests/verify_chase_behavior.py"
      provides: "Verification tests for CHAS-01 through CHAS-05 and SAFE-01"
      exports: ["test_hostile_npc_transitions_to_chase_on_seeing_player", "test_notices_message_fires_once", "test_chase_npc_moves_toward_player", "test_npc_reverts_to_wander_after_losing_sight", "test_chase_data_stores_coordinates_not_entity_ids"]
  key_links:
    - from: "ecs/systems/ai_system.py"
      to: "services/visibility_service.py"
      via: "VisibilityService.compute_visibility() for NPC FOV"
      pattern: "VisibilityService\\.compute_visibility"
    - from: "ecs/systems/ai_system.py"
      to: "ecs/components.py"
      via: "ChaseData component add/remove on state transitions"
      pattern: "ChaseData"
    - from: "game_states.py"
      to: "ecs/systems/ai_system.py"
      via: "player_entity passed as 4th arg to process()"
      pattern: "self\\.player_entity"
---

<objective>
Implement chase behavior for hostile NPCs: FOV-based player detection, WANDER/IDLE-to-CHASE state transition with "notices you" message, greedy Manhattan pursuit, and lose-sight fallback to WANDER after N turns.

Purpose: This is the final phase of v1.2 AI Infrastructure. It gives hostile NPCs the ability to detect and pursue the player, making combat encounters emerge from exploration rather than being purely static.
Output: Working chase AI in ai_system.py, updated call site in game_states.py, verification tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-chase-behavior-and-state-transitions/18-RESEARCH.md
@ecs/systems/ai_system.py
@ecs/components.py
@game_states.py
@services/visibility_service.py
@ecs/systems/visibility_system.py
@tests/verify_wander_behavior.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement chase detection, pursuit, and lose-sight in AISystem</name>
  <files>ecs/systems/ai_system.py, game_states.py</files>
  <action>
**ai_system.py changes:**

1. Add imports at the top:
   - `from ecs.components import ChaseData, Name, Stats, Alignment` (add to existing import line)
   - `from services.visibility_service import VisibilityService`
   - `from map.tile import SpriteLayer` (needed for transparency function)

2. Add module constant: `LOSE_SIGHT_TURNS = 3`

3. Update `process()` signature to accept `player_entity=None` as 4th parameter:
   ```python
   def process(self, turn_system, map_container, player_layer, player_entity=None):
   ```
   At the top of process(), resolve player position:
   ```python
   player_pos = None
   if player_entity is not None:
       try:
           player_pos = esper.component_for_entity(player_entity, Position)
       except KeyError:
           pass
   ```
   Pass `player_pos` to `_dispatch()`.

4. Update `_dispatch()` signature to accept `player_pos`:
   ```python
   def _dispatch(self, ent, behavior, pos, map_container, claimed_tiles, player_pos):
   ```
   Add detection block BEFORE the match statement:
   - Only for `behavior.alignment == Alignment.HOSTILE` and `player_pos is not None`
   - Only when `behavior.state in (AIState.WANDER, AIState.IDLE)`
   - Call `self._can_see_player(pos, stats, player_pos, map_container)` where stats = `esper.component_for_entity(ent, Stats)`
   - On detection: set `behavior.state = AIState.CHASE`, add `ChaseData(last_known_x=player_pos.x, last_known_y=player_pos.y)`, dispatch `"log_message"` event with `f"The {name.name} notices you!"` where name = `esper.component_for_entity(ent, Name)`
   - The match statement then naturally routes to the CHASE case (state was just updated)

   Update match arms:
   - CHASE case: call `self._chase(ent, behavior, pos, map_container, claimed_tiles, player_pos)` instead of `pass`
   - All other cases unchanged

5. Add `_can_see_player(self, pos, stats, player_pos, map_container)` method:
   - Build transparency function via `self._make_transparency_func(pos.layer, map_container)`
   - Call `VisibilityService.compute_visibility((pos.x, pos.y), stats.perception, is_transparent)`
   - Return `(player_pos.x, player_pos.y) in visible`

6. Add `_make_transparency_func(self, layer_idx, map_container)` method:
   - Copy the factory pattern from `visibility_system.py` exactly:
   ```python
   def _make_transparency_func(self, layer_idx, map_container):
       def is_transparent(x, y):
           if 0 <= layer_idx < len(map_container.layers):
               layer = map_container.layers[layer_idx]
               if 0 <= y < len(layer.tiles) and 0 <= x < len(layer.tiles[y]):
                   tile = layer.tiles[y][x]
                   if not tile.transparent:
                       return False
                   if tile.sprites.get(SpriteLayer.GROUND) == "#":
                       return False
                   return True
           return False
       return is_transparent
   ```

7. Add `_chase(self, ent, behavior, pos, map_container, claimed_tiles, player_pos)` method:
   - Get `chase_data = esper.component_for_entity(ent, ChaseData)` and `stats = esper.component_for_entity(ent, Stats)`
   - **Sight check:** If `player_pos is not None`, compute FOV via `_can_see_player()`. If player visible: update `chase_data.last_known_x/y` to player's current position, reset `chase_data.turns_without_sight = 0`. If NOT visible: increment `chase_data.turns_without_sight`. If `>= LOSE_SIGHT_TURNS`: set `behavior.state = AIState.WANDER`, remove ChaseData via `esper.remove_component(ent, ChaseData)`, return.
   - **Greedy Manhattan step:** Target is `(chase_data.last_known_x, chase_data.last_known_y)`. Compute dx, dy. Build candidate list: prefer axis with larger abs delta first, then the other axis. For each candidate `(step_x, step_y)`: skip if zero, compute `(nx, ny)`, skip if in `claimed_tiles`, skip if not `_is_walkable()`, skip if `_get_blocker_at()` returns truthy. On first valid step: add to `claimed_tiles`, mutate `pos.x = nx`, `pos.y = ny`, return.
   - Player tile is treated as blocked (player has Blocker component -- `_get_blocker_at` will catch this). NPC stays adjacent, does not step onto player tile.

**game_states.py change:**

Update the AISystem call site (line ~321) to pass `self.player_entity`:
```python
self.ai_system.process(self.turn_system, self.map_container, player_layer, self.player_entity)
```
  </action>
  <verify>
Run `python -c "from ecs.systems.ai_system import AISystem; print('import ok')"` to confirm no syntax/import errors.
Grep ai_system.py for `_chase`, `_can_see_player`, `_make_transparency_func`, `LOSE_SIGHT_TURNS` to confirm all methods exist.
Grep game_states.py for `player_entity` in the ai_system.process call.
  </verify>
  <done>
AISystem has working _chase(), _can_see_player(), _make_transparency_func() methods. Detection block in _dispatch() transitions HOSTILE WANDER/IDLE NPCs to CHASE with "notices you" message. Chase movement uses greedy Manhattan step. Lose-sight counter reverts to WANDER after 3 turns. game_states.py passes player_entity to AISystem.process().
  </done>
</task>

<task type="auto">
  <name>Task 2: Add verification tests for chase behavior</name>
  <files>tests/verify_chase_behavior.py</files>
  <action>
Create `tests/verify_chase_behavior.py` following the exact structure of `tests/verify_wander_behavior.py`.

Use the same imports plus: `ChaseData, Name, Stats` from components, `VisibilityService` not needed directly (tested through AISystem).

Reuse `make_walkable_map()` helper (copy from verify_wander_behavior.py). Use a larger map (10x10) for chase tests so perception range works properly with open floor.

**Important:** The `process()` call now takes 4 args: `ai_sys.process(turn, map_c, player_layer=0, player_entity=player)`.

Tests to write:

1. `test_hostile_npc_transitions_to_chase_on_seeing_player` (CHAS-01, CHAS-03):
   - Create hostile NPC at (3,3) in WANDER state with perception=5
   - Create player entity at (5,3) on same layer (with Position, Stats, Blocker — player is a blocker)
   - Run one AI turn
   - Assert: NPC's `AIBehaviorState.state == AIState.CHASE`
   - Assert: `esper.has_component(npc, ChaseData)` is True

2. `test_notices_message_fires_once` (CHAS-04):
   - Register a handler for `"log_message"` event that appends to a list: `messages = []` then `esper.set_handler("log_message", lambda msg: messages.append(msg))`
   - Create hostile NPC at (3,3) WANDER, perception=5
   - Create player at (5,3) with Position, Stats, Blocker
   - Run AI turn 1 -> assert exactly one message containing "notices you" in messages list
   - Clear messages. Manually set turn back to ENEMY_TURN via `turn.end_player_turn()`
   - Run AI turn 2 -> assert zero new "notices you" messages (NPC is already in CHASE, detection block skipped)

3. `test_chase_npc_moves_toward_player` (CHAS-02):
   - Create hostile NPC at (2,5) already in CHASE state with ChaseData(last_known_x=8, last_known_y=5)
   - Create player at (8,5) with Position, Stats, Blocker
   - Give NPC perception=5 (player visible at distance 6 — out of range, so NPC chases last_known position)
   - Run one AI turn
   - Assert: NPC position moved closer to target. Specifically `pos.x == 3` and `pos.y == 5` (one step east toward target)

4. `test_npc_reverts_to_wander_after_losing_sight` (CHAS-05):
   - Use a map with a wall column separating NPC and player so LOS is blocked
   - Create NPC at (2,2) in CHASE state with `ChaseData(last_known_x=8, last_known_y=2, turns_without_sight=2)` (already lost sight for 2 turns)
   - Create player at (8,2) with Position, Stats, Blocker
   - Place wall tiles in a column at x=4 from y=1 to y=3 to block LOS
   - Run one AI turn -> turns_without_sight increments to 3 >= LOSE_SIGHT_TURNS
   - Assert: `behavior.state == AIState.WANDER`
   - Assert: `esper.has_component(npc, ChaseData)` is False

5. `test_chase_data_stores_coordinates_not_entity_ids` (SAFE-01):
   - Create NPC and player. Run AI turn so NPC transitions to CHASE.
   - Get ChaseData from NPC.
   - Assert: `chase_data.last_known_x == player_pos.x` and `chase_data.last_known_y == player_pos.y`
   - Assert: ChaseData has no attribute named `player_entity` or `target_entity` (via `hasattr` check)
   - This confirms coordinate-only storage per SAFE-01.

6. `test_friendly_npc_does_not_chase` (implicit from CHAS-01 — only HOSTILE):
   - Create FRIENDLY NPC at (3,3) WANDER, perception=5
   - Create player at (5,3) with Position, Stats, Blocker
   - Run AI turn
   - Assert: NPC state is still WANDER (not CHASE)
  </action>
  <verify>
Run `python -m pytest tests/verify_chase_behavior.py -v` — all 6 tests must pass.
  </verify>
  <done>
All 6 verification tests pass, covering CHAS-01 through CHAS-05 and SAFE-01. Tests confirm: hostile detection triggers CHASE transition, "notices you" fires exactly once, chase movement reduces distance to target, lose-sight counter reverts to WANDER, ChaseData stores coordinates only, friendly NPCs are unaffected.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/verify_chase_behavior.py -v` — all 6 tests pass
2. `python -m pytest tests/verify_wander_behavior.py -v` — all existing wander tests still pass (no regression)
3. `python -c "from ecs.systems.ai_system import AISystem"` — clean import
4. Grep ai_system.py for LOSE_SIGHT_TURNS, _chase, _can_see_player, _make_transparency_func — all present
</verification>

<success_criteria>
- CHAS-01: Hostile NPC within perception range with LOS transitions to CHASE (test 1)
- CHAS-02: Chase NPC takes greedy Manhattan step toward player (test 3)
- CHAS-03: WANDER/IDLE to CHASE transition works (test 1)
- CHAS-04: "Notices you" message fires exactly once (test 2)
- CHAS-05: NPC reverts to WANDER after LOSE_SIGHT_TURNS without LOS (test 4)
- SAFE-01: ChaseData stores coordinates, not entity IDs (test 5)
- No regression in existing wander tests
</success_criteria>

<output>
After completion, create `.planning/phases/18-chase-behavior-and-state-transitions/18-01-SUMMARY.md`
</output>
