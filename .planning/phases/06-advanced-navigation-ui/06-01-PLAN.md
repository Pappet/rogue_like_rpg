---
phase: 06-advanced-navigation-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - map/map_container.py
  - game_states.py
  - ecs/systems/visibility_system.py
autonomous: true
must_haves:
  truths:
    - "Tiles visited long ago become FORGOTTEN when returning to a map"
    - "Tiles recently visited remain SHROUDED when returning"
    - "Map transitions trigger aging calculation"
  artifacts:
    - path: "map/map_container.py"
      provides: "Map aging logic (on_exit, on_enter)"
  key_links:
    - from: "game_states.py"
      to: "map/map_container.py"
      via: "transition_map calls on_exit/on_enter"
---

<objective>
Implement "Lazy Map Aging" where maps degrade in memory when the player is away.
Instead of simulating inactive maps, calculate decay based on time passed upon return.

Purpose: Create a dynamic world where old information becomes unreliable.
Output: Updated MapContainer with aging logic and integrated map transition hooks.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-advanced-navigation-ui/06-RESEARCH.md
@map/map_container.py
@game_states.py
@ecs/systems/visibility_system.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Aging Logic to MapContainer</name>
  <files>map/map_container.py</files>
  <action>
    Add `last_visited_turn: int` (default 0) to `MapContainer.__init__`.
    
    Implement `on_exit(self, current_turn: int)`:
    - Update `self.last_visited_turn = current_turn`.
    - Iterate all tiles: if VISIBLE, downgrade to SHROUDED and set `rounds_since_seen = 0`.
    
    Implement `on_enter(self, current_turn: int, memory_threshold: int)`:
    - Calculate `turns_passed = current_turn - self.last_visited_turn`.
    - If `turns_passed > 0`:
      - Iterate all tiles: if SHROUDED, add `turns_passed` to `rounds_since_seen`.
      - If `rounds_since_seen > memory_threshold`, set to FORGOTTEN.
  </action>
  <verify>
    Create a test script `tests/verify_aging.py`:
    - Create a MapContainer with some SHROUDED tiles.
    - Call `on_exit(10)`.
    - Call `on_enter(20, threshold=5)`.
    - Assert SHROUDED tiles with prior age > 5 become FORGOTTEN.
  </verify>
  <done>MapContainer handles lazy aging correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate Aging into Map Transitions</name>
  <files>game_states.py</files>
  <action>
    In `Game.transition_map`:
    1. Calculate `memory_threshold` (max intelligence * 5) from player stats (or default 10 if no stats).
    2. Before freezing current map, call `self.map_container.on_exit(self.turn_system.round_counter)`.
    3. After retrieving `new_map`, call `new_map.on_enter(self.turn_system.round_counter, memory_threshold)`.
    
    Ensure `turn_system` is accessible and has valid `round_counter`.
  </action>
  <verify>
    Run the game, transition between maps, and observe console logs (add print debugs if needed) verifying aging hooks are called.
  </verify>
  <done>Moving between maps triggers aging logic.</done>
</task>

<task type="auto">
  <name>Task 3: Harmonize VisibilitySystem</name>
  <files>ecs/systems/visibility_system.py</files>
  <action>
    Update `VisibilitySystem` to ensure consistency with MapContainer aging.
    - Currently, it resets VISIBLE->SHROUDED every frame. Ensure this doesn't conflict with `on_exit`.
    - Ensure `rounds_since_seen` is incremented correctly for SHROUDED tiles in the active map (already likely done, just verify logic matches).
    - Use the same `memory_threshold` formula (max_intel * 5).
  </action>
  <verify>
    Play the game. Stand still for >50 turns (spacebar). 
    Verify previously seen areas (now shrouded) become FORGOTTEN if they exceed the threshold.
  </verify>
  <done>Active map aging matches inactive map aging.</done>
</task>

</tasks>

<verification>
- [ ] Test script `tests/verify_aging.py` passes.
- [ ] In-game: Leave map, wait 100 turns on another map, return -> old map should be largely FORGOTTEN.
- [ ] In-game: Active aging works (shrouded tiles fade to black).
</verification>

<success_criteria>
- Map memory degrades consistently whether the player is present or absent.
- Intelligence stat affects memory duration.
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-navigation-ui/06-01-SUMMARY.md`
</output>
