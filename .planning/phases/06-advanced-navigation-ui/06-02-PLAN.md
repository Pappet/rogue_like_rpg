---
phase: 06-advanced-navigation-ui
plan: 02
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - game_states.py
  - main.py
  - config.py
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Pressing M opens the World Map"
    - "World Map shows discovered tiles (SHROUDED/FORGOTTEN)"
    - "Returning to Game does not reset turn counter"
  artifacts:
    - path: "game_states.py"
      provides: "WorldMapState"
      exports: ["WorldMapState"]
  key_links:
    - from: "main.py"
      to: "game_states.py"
      via: "GameStates.WORLD_MAP"
---

<objective>
Implement a World Map UI to visualize discovered areas.
Ensure game state (turns, entities) persists when switching to/from the map view.

Purpose: Provide navigation context and fix state persistence issues.
Output: Working World Map modal and robust state switching.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-advanced-navigation-ui/06-RESEARCH.md
@game_states.py
@main.py
@config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Game State Persistence</name>
  <files>game_states.py</files>
  <action>
    Refactor `Game.startup` to prevent re-initialization of critical systems (TurnSystem, MapContainer, etc.) when returning from other states.
    
    Logic:
    - Check if `persist` contains `turn_system`. If so, use it. If not, create new `TurnSystem` and add to `persist`.
    - Ensure `map_container` and other services are retrieved correctly from `persist`.
    - Only re-init systems that need fresh state (e.g., UI might need reset, but game logic shouldn't).
  </action>
  <verify>
    Add print debug to `TurnSystem.__init__`. Run game, switch to Title (if possible) or just verify round counter persists across map transitions (wait, map transitions don't leave Game state).
    We need a new state to test this properly, which Task 2 provides.
    For now, verify logic by inspection or unit test if possible.
  </verify>
  <done>Game state resumes correctly after interruption.</done>
</task>

<task type="auto">
  <name>Task 2: Implement WorldMapState</name>
  <files>game_states.py, config.py</files>
  <action>
    1. Add `WORLD_MAP` to `GameStates` enum (or just use string "WORLD_MAP" in main.py, but consistence is better).
    2. Create `WorldMapState(GameState)` class in `game_states.py`.
       - `startup(persist)`: retrieve `map_container`.
       - `draw(surface)`: 
         - Generate minimap surface (scaled down, e.g., 4x4 pixels per tile).
         - Iterate `map_container.tiles`:
           - VISIBLE -> White/Light Grey
           - SHROUDED -> Dark Grey
           - FORGOTTEN -> Very Dark Grey / Blue Tint
           - UNEXPLORED -> Black (skip drawing)
         - Center the minimap on screen.
       - `get_event(event)`:
         - Key M or ESC -> `self.done = True`, `self.next_state = "GAME"`.
  </action>
  <verify>
    Can't verify fully until registered in Task 3.
  </verify>
  <done>WorldMapState class exists and renders map data.</done>
</task>

<task type="auto">
  <name>Task 3: Register and Wire Up World Map</name>
  <files>main.py, game_states.py</files>
  <action>
    1. In `main.py`, add `WorldMapState` to `self.states` dict with key "WORLD_MAP".
    2. In `Game.handle_player_input` (or `get_event`), add check for `pygame.K_m`.
       - If pressed: `self.next_state = "WORLD_MAP"`, `self.done = True`.
    
    Ensure `persist` dictionary is passed correctly between states.
  </action>
  <verify>
    Run game.
    1. Explore some area.
    2. Press M -> World Map appears showing explored area.
    3. Press M/ESC -> Return to game.
    4. Verify turn counter hasn't reset (check console logs or UI if available).
  </verify>
  <done>Player can toggle World Map.</done>
</task>

</tasks>

<verification>
- [ ] Game runs without crashing on M press.
- [ ] World Map visualizes correct tiles (verified by exploring a unique shape).
- [ ] Returning to game resumes exactly where left off (turn counter, entity positions).
</verification>

<success_criteria>
- World Map is functional and provides spatial awareness.
- Game state persistence is robust against state switching.
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-navigation-ui/06-02-SUMMARY.md`
</output>
