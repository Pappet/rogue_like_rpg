---
phase: 28-day-night-visual-cycle
plan: 03
type: execute
wave: 3
depends_on: [28-02]
files_modified: [ecs/systems/visibility_system.py, game_states.py, tests/verify_day_night.py]
autonomous: true

must_haves:
  truths:
    - "VisibilitySystem uses EffectiveStats.perception for FOV radius"
    - "Player FOV radius decreases at NIGHT and restores at DAY"
    - "Processors run in the correct order (Turn -> Equipment -> Visibility)"
  artifacts:
    - path: "tests/verify_day_night.py"
      provides: "Automated verification of day/night mechanics"
  key_links:
    - from: "ecs/systems/visibility_system.py"
      to: "ecs/components.py"
      via: "EffectiveStats component"
---

<objective>
Complete the Day/Night cycle implementation by wiring perception changes into the visibility system and verifying the entire flow with automated tests.

Purpose: Ensure the passage of time has a tangible mechanical impact on gameplay (FOV).
Output: A time-aware VisibilitySystem and comprehensive verification tests.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-day-night-visual-cycle/28-02-SUMMARY.md
@.planning/phases/28-day-night-visual-cycle/28-RESEARCH.md
@ecs/systems/visibility_system.py
@game_states.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update VisibilitySystem and Processor Order</name>
  <files>ecs/systems/visibility_system.py, game_states.py</files>
  <action>
    1. In `ecs/systems/visibility_system.py`, update `VisibilitySystem.process`:
       - When calculating `radius` for an entity with `Stats`, check if it has `EffectiveStats`.
       - If `EffectiveStats` is present, use `EffectiveStats.perception`.
       - Fallback to `stats.perception` if `EffectiveStats` is missing.
    2. In `game_states.py`, update `Game.startup`:
       - Reorder `esper.add_processor` calls to ensure correct dependency flow.
       - Recommended order: `TurnSystem`, `EquipmentSystem`, `VisibilitySystem`, `MovementSystem`, `CombatSystem`, `DeathSystem`.
       - This ensures time advances, stats update based on time/gear, and visibility reflects the new stats in a single frame.
  </action>
  <verify>Check VisibilitySystem logic and game_states.py processor order.</verify>
  <done>FOV radius correctly responds to EffectiveStats changes immediately.</done>
</task>

<task type="auto">
  <name>Task 2: Create Verification Tests</name>
  <files>tests/verify_day_night.py</files>
  <action>
    Create `tests/verify_day_night.py` to:
    1. Setup a WorldClockService and EquipmentSystem.
    2. Verify perception is at base level during DAY.
    3. Advance clock to NIGHT.
    4. Verify perception is reduced (e.g., 0.5x base).
    5. Advance clock back to DAY.
    6. Verify perception is restored.
    7. Setup a VisibilitySystem and verify FOV radius changes accordingly.
  </action>
  <verify>Run `python tests/verify_day_night.py` and ensure all tests pass.</verify>
  <done>Day/Night mechanics are verified and regression-tested.</done>
</task>

</tasks>

<verification>
- `python tests/verify_day_night.py` passes.
- Manual check: Wait for nightfall in-game and observe FOV shrinking.
- Manual check: Use an item that gives perception and verify it's also affected by the night multiplier (e.g., base 10 + 2 from item = 12; night = 6).
</verification>

<success_criteria>
- FOV radius correctly reflects time-of-day.
- Multipliers are applied correctly to total perception.
- Perception never drops below 1.
</success_criteria>

<output>
After completion, create `.planning/phases/28-day-night-visual-cycle/28-03-SUMMARY.md`
</output>
