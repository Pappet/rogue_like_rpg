---
phase: 28-day-night-visual-cycle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [config.py, ecs/systems/equipment_system.py, game_states.py]
autonomous: true

must_haves:
  truths:
    - "DN_SETTINGS exist in config.py with multipliers for each phase"
    - "EquipmentSystem computes perception using the time-based multiplier"
  artifacts:
    - path: "config.py"
      provides: "DN_SETTINGS dictionary"
    - path: "ecs/systems/equipment_system.py"
      provides: "Time-aware stat computation"
  key_links:
    - from: "ecs/systems/equipment_system.py"
      to: "services/world_clock_service.py"
      via: "phase property"
---

<objective>
Define the visual and mechanical properties of each time phase and ensure they are applied to entity stats via the EquipmentSystem.

Purpose: Translate time-of-day into gameplay-affecting stat modifiers (perception).
Output: Configured day/night settings and a time-aware EquipmentSystem.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-day-night-visual-cycle/28-RESEARCH.md
@config.py
@ecs/systems/equipment_system.py
@game_states.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define DN_SETTINGS in config.py</name>
  <files>config.py</files>
  <action>
    Add a `DN_SETTINGS` dictionary to `config.py`.
    Include settings for "day", "dawn", "dusk", and "night".
    Each setting should have:
    - "tint": A tuple (R, G, B, A)
    - "light": Float multiplier for ambient light (e.g. 1.0 for day, 0.4 for night)
    - "perception": Float multiplier for player perception (e.g. 1.0 for day, 0.5 for night)
    
    Example:
    DN_SETTINGS = {
        "day":   {"tint": (0, 0, 0, 0),     "light": 1.0, "perception": 1.0},
        "dawn":  {"tint": (255, 200, 150, 60), "light": 0.8, "perception": 0.8},
        "dusk":  {"tint": (150, 100, 200, 80), "light": 0.7, "perception": 0.7},
        "night": {"tint": (0, 0, 40, 140),     "light": 0.4, "perception": 0.5},
    }
  </action>
  <verify>Check config.py for the new dictionary.</verify>
  <done>DN_SETTINGS is available for other systems.</done>
</task>

<task type="auto">
  <name>Task 2: Update EquipmentSystem with time-of-day multipliers</name>
  <files>ecs/systems/equipment_system.py, game_states.py</files>
  <action>
    1. Update `EquipmentSystem.__init__` in `ecs/systems/equipment_system.py` to accept a `world_clock` reference.
    2. In `EquipmentSystem.process`, fetch the current `phase` from `world_clock`.
    3. Look up the `perception` multiplier from `DN_SETTINGS[phase]`.
    4. Apply the multiplier to the final `perception` value (after equipment bonuses) using `max(1, int(perception * multiplier))`.
    5. Update `Game.startup` in `game_states.py` to pass `self.world_clock` when instantiating `EquipmentSystem`.
  </action>
  <verify>Ensure EquipmentSystem reads world_clock.phase and applies multiplier from DN_SETTINGS.</verify>
  <done>EffectiveStats.perception correctly reflects the time-of-day multiplier.</done>
</task>

</tasks>

<verification>
- `config.py` contains `DN_SETTINGS`.
- `EquipmentSystem` uses `world_clock.phase` to adjust perception.
- `Game.startup` passes `world_clock` to `EquipmentSystem`.
</verification>

<success_criteria>
- EquipmentSystem computes a perception value that changes based on world time.
- Perception never drops below 1.
</success_criteria>

<output>
After completion, create `.planning/phases/28-day-night-visual-cycle/28-01-SUMMARY.md`
</output>
