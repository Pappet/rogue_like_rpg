---
phase: 28-day-night-visual-cycle
plan: 02
type: execute
wave: 2
depends_on: [28-01]
files_modified: [services/render_service.py, game_states.py]
autonomous: true

must_haves:
  truths:
    - "RenderService can apply a semi-transparent color tint to a surface"
    - "The game viewport is tinted based on the current world clock phase"
  artifacts:
    - path: "services/render_service.py"
      provides: "apply_viewport_tint method"
  key_links:
    - from: "game_states.py"
      to: "services/render_service.py"
      via: "apply_viewport_tint call in draw()"
---

<objective>
Implement the visual atmosphere by applying a color tint to the game viewport based on the current world time.

Purpose: Provide visual feedback for the passage of time (DAWN/DAY/DUSK/NIGHT).
Output: A functional tinting system in RenderService integrated into the main draw loop.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-day-night-visual-cycle/28-01-SUMMARY.md
@.planning/phases/28-day-night-visual-cycle/28-RESEARCH.md
@services/render_service.py
@game_states.py
@config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add apply_viewport_tint to RenderService</name>
  <files>services/render_service.py</files>
  <action>
    1. Update `RenderService.__init__` to initialize `self.tint_surface = None`.
    2. Add `apply_viewport_tint(self, surface, tint_color, viewport_rect)` method.
    3. Inside `apply_viewport_tint`:
       - Check if `self.tint_surface` matches `viewport_rect` size. If not, recreate it using `pygame.Surface((viewport_rect.width, viewport_rect.height), pygame.SRCALPHA)`.
       - Fill `self.tint_surface` with `tint_color`.
       - Blit `self.tint_surface` onto `surface` at `(viewport_rect.x, viewport_rect.y)`.
  </action>
  <verify>Check RenderService for the new method and surface handling.</verify>
  <done>RenderService can efficiently apply a tint to the viewport.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate tinting into Game.draw</name>
  <files>game_states.py</files>
  <action>
    1. In `Game.draw`, before resetting the clip (after rendering entities and debug overlay), calculate the current tint.
    2. Get `phase` from `self.world_clock`.
    3. Look up `tint_color` from `DN_SETTINGS[phase]`.
    4. Call `self.render_service.apply_viewport_tint(surface, tint_color, viewport_rect)`.
    5. Ensure this happens while the clip is still set to `viewport_rect`.
  </action>
  <verify>Run the game and verify that the viewport changes color based on the current world time.</verify>
  <done>The game world is visually tinted according to the time of day.</done>
</task>

</tasks>

<verification>
- Viewport displays a dark blue tint at NIGHT.
- Viewport displays a warm tint at DAWN/DUSK.
- UI (sidebar, message log) remains untinted and readable.
</verification>

<success_criteria>
- The atmosphere changes correctly as time advances.
- No significant performance degradation in the draw loop.
</success_criteria>

<output>
After completion, create `.planning/phases/28-day-night-visual-cycle/28-02-SUMMARY.md`
</output>
