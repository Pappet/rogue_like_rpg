---
phase: 07-layered-rendering-and-structure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/map_service.py
  - services/render_service.py
  - ecs/systems/render_system.py
  - game_states.py
autonomous: true
must_haves:
  truths:
    - "Village map has visible walls at (8,8) to (12,12) with a gap at (10,10)"
    - "House map has outer walls (10x10) and an interior wall with a door"
    - "Layers above the player are not rendered"
    - "Layers below the player are rendered darker"
    - "Entities on lower layers are rendered darker"
    - "Entities on higher layers are not rendered"
  artifacts:
    - path: "services/map_service.py"
      contains: "create_village_scenario"
    - path: "services/render_service.py"
      contains: "player_layer"
    - path: "ecs/systems/render_system.py"
      contains: "player_layer"
  key_links:
    - from: "game_states.py"
      to: "services/render_service.py"
      via: "render_map call with player_layer"
    - from: "game_states.py"
      to: "ecs/systems/render_system.py"
      via: "process call with player_layer"
---

<objective>
Implement selective layer rendering (depth effect) and add structural elements to maps.
Purpose: Enhance visual depth and create recognizable building structures.
Output: Updated map generation and rendering logic.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@services/map_service.py
@services/render_service.py
@ecs/systems/render_system.py
@game_states.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Map Structures</name>
  <files>services/map_service.py</files>
  <action>
    Update `create_village_scenario` in `services/map_service.py`:
    1. **Village Map (20x20):**
       - Add walls ('#', transparent=False) to create a building footprint.
       - Walls at x=8 and x=12 (y from 8 to 12).
       - Walls at y=8 and y=12 (x from 8 to 12).
       - Create a gap (floor '.') at (10, 10) for the door.
       - Ensure (10, 10) is walkable/transparent.
    2. **House Map (10x10):**
       - Add outer walls ('#', transparent=False) at the perimeter (x=0, x=9, y=0, y=9).
       - Add an interior dividing wall at x=5 (y from 1 to 8).
       - Create a gap (floor '.') at (5, 5) for the interior door.
  </action>
  <verify>
    Run `python3 main.py` and navigate to the Village map.
    Check if walls exist at expected coordinates using `print` debug or visual inspection.
  </verify>
  <done>
    Village map has walls around (8,8)-(12,12) with a gap at (10,10).
    House map has outer walls and an interior wall at x=5 with a gap at (5,5).
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Selective Layer Rendering</name>
  <files>services/render_service.py</files>
  <action>
    Update `render_map` in `services/render_service.py`:
    1. Add `player_layer` parameter to the method signature.
    2. Modify the layer loop to only iterate through layers `i` where `0 <= i <= player_layer`.
    3. Calculate darkening factor: `factor = 1.0 - (player_layer - i) * 0.3`.
    4. Apply `factor` to the color of the rendered tiles (both ground and sprites).
       - Ensure factor is clamped (e.g., max(0.1, factor)) to prevent full black if desired, though formula `1 - 0.3*diff` is safe for diff < 3.
  </action>
  <verify>
    Check `render_map` signature.
  </verify>
  <done>
    `render_map` accepts `player_layer` and renders only appropriate layers with darkening.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Entity Rendering and Integration</name>
  <files>ecs/systems/render_system.py, game_states.py</files>
  <action>
    1. **Update `RenderSystem` in `ecs/systems/render_system.py`:**
       - Update `process` method to accept `player_layer` (or `player_entity` to derive it).
       - Filter entities: Only render if `entity.position.layer <= player_layer`.
       - Apply darkening factor to entity color: `factor = 1.0 - (player_layer - entity.layer) * 0.3`.
    
    2. **Update Integration in `game_states.py`:**
       - In `Game.draw`, retrieve `player_layer` from `self.player_entity`.
       - Pass `player_layer` to `self.render_service.render_map`.
       - Pass `player_layer` to `self.render_system.process`.
  </action>
  <verify>
    Run `python3 main.py`.
    1. Move player to a higher layer (e.g., balcony or upstairs).
    2. Verify lower layers are visible but darker.
    3. Verify higher layers (when on ground) are NOT visible.
    4. Verify entities follow the same visibility rules.
  </verify>
  <done>
    Game runs without errors.
    Depth effect is visible.
    Entities and map layers respect `player_layer`.
  </done>
</task>

</tasks>

<verification>
- [ ] Run the game.
- [ ] Navigate to the "House" (portal at 10,10 in Village).
- [ ] Verify walls around the house in Village.
- [ ] Enter House. Verify outer walls and interior wall.
- [ ] Go upstairs in House. Verify ground floor is visible but darker.
- [ ] Go to Balcony (from upstairs). Verify Village ground is visible but darker.
</verification>

<success_criteria>
- [ ] Village map has structure (8,8) to (12,12).
- [ ] House map has 10x10 outer walls and interior wall.
- [ ] Rendering respects player layer (higher layers hidden).
- [ ] Lower layers are darkened.
</success_criteria>

<output>
After completion, create `.planning/phases/07-layered-rendering-and-structure/07-01-SUMMARY.md`
</output>
