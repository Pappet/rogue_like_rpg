---
phase: 04-combat-feedback
plan: 04
type: execute
wave: 3
depends_on: [04-03]
files_modified:
  - ecs/systems/death_system.py
  - ecs/components.py
  - main.py
autonomous: true
must_haves:
  truths:
    - "Monsters die when HP <= 0"
    - "Dead monsters become corpses (change sprite/color)"
    - "Corpses do not block movement"
    - "Corpses render below living entities"
  artifacts:
    - path: "ecs/systems/death_system.py"
      provides: "DeathSystem class"
    - path: "ecs/components.py"
      contains: "class Corpse"
  key_links:
    - from: "CombatSystem"
      to: "DeathSystem"
      via: "HP check or event"
---

<objective>
Implement Death System and Corpse Handling.
Purpose: Handle entity death cleanly and persistent remains.
Output: Corpses on the ground, monsters removed from turn order.
</objective>

<context>
@ecs/systems/combat_system.py
@config.py
@.planning/phases/04-combat-feedback/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Implement Death System</name>
  <files>ecs/systems/death_system.py, ecs/components.py, main.py</files>
  <action>
    1.  Create `ecs/components.py`: Add `Corpse` tag component (optional, or just use lack of Fighter/AI). Adding `Corpse` component is good for identification.
    2.  Create `ecs/systems/death_system.py`:
        -   Class `DeathSystem`.
        -   Method `process()` or Event Handler for "entity_died" (if CombatSystem dispatches it). 
        -   *Alternative:* `process()` iterates all `Fighter`s with `hp <= 0`.
        -   Logic:
            -   Log message ("Orc dies!").
            -   Remove `Blocker`, `Fighter`, `AI` components.
            -   Update `Renderable`: Set char to "%", color to Dark Red, `layer` to `SpriteLayer.CORPSES`.
            -   Change `Name` to "Remains of X".
            -   Add `Corpse` component.
    3.  Register `DeathSystem` in `main.py`.
  </action>
  <verify>Kill Orc. Verify it turns into corpse and you can walk over it.</verify>
  <done>Death logic implemented.</done>
</task>

<task type="checkpoint:human-verify">
  <what-built>Combat and Death Loop</what-built>
  <how-to-verify>
    1.  Run game.
    2.  Find Orc.
    3.  Bump attack until dead.
    4.  Verify messages appear.
    5.  Verify Orc becomes corpse (sprite changes, layer drops).
    6.  Verify player can walk onto corpse tile.
  </how-to-verify>
  <resume-signal>Combat feels correct.</resume-signal>
</task>

</tasks>

<verification>
- [ ] Dead entities become non-blocking corpses.
- [ ] Render order correct (corpses under entities).
</verification>

<success_criteria>
- Full combat loop from attack to death works.
</success_criteria>

<output>
After completion, create `.planning/phases/04-combat-feedback/04-04-SUMMARY.md`
</output>
