---
phase: 04-combat-feedback
plan: 04
type: execute
wave: 3
depends_on: [04-03]
files_modified:
  - ecs/systems/death_system.py
  - ecs/components.py
  - main.py
autonomous: true
must_haves:
  truths:
    - "Monsters die when HP <= 0"
    - "System responds to 'entity_died' event"
    - "Dead monsters become corpses (change sprite/color)"
    - "Corpses do not block movement"
    - "Corpses render below living entities"
  artifacts:
    - path: "ecs/systems/death_system.py"
      provides: "DeathSystem class with on_entity_died handler"
    - path: "ecs/components.py"
      contains: "class Corpse"
  key_links:
    - from: "CombatSystem (Event)"
      to: "DeathSystem (Handler)"
      via: "esper.dispatch('entity_died')"
---

<objective>
Implement Death System and Corpse Handling using Event Callbacks.
Purpose: Handle entity death cleanly through a decoupled event system.
Output: Corpses on the ground, monsters removed from turn order.
</objective>

<context>
@ecs/systems/combat_system.py
@config.py
@.planning/phases/04-combat-feedback/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Implement Death System with Event Handler</name>
  <files>ecs/systems/death_system.py, ecs/components.py, main.py</files>
  <action>
    1.  Create `ecs/components.py`: Add `Corpse` tag component.
    2.  Create `ecs/systems/death_system.py`:
        -   Class `DeathSystem(esper.Processor)`.
        -   **Event Handler (MANDATORY):**
            -   In `__init__` or `startup`, register handler: `esper.set_handler("entity_died", self.on_entity_died)`.
        -   Method `on_entity_died(entity)`:
            -   Log message ("[color=orange]Orc[/color] dies!").
            -   Remove `Blocker` and `AI` components from the entity. (Also remove `Stats` if present/appropriate).
            -   Update `Renderable`: Set char to "%", color to Dark Red, `layer` to `SpriteLayer.CORPSES`.
            -   Update `Name` to "Remains of [Original Name]".
            -   Add `Corpse` component.
    3.  Register `DeathSystem` in `main.py`. Ensure it is initialized so it can register its handler.
  </action>
  <verify>Kill Orc. Verify `on_entity_died` is called and Orc turns into a corpse.</verify>
  <done>Death logic implemented via event handler.</done>
</task>

<task type="checkpoint:human-verify">
  <what-built>Combat and Death Loop</what-built>
  <how-to-verify>
    1.  Run game.
    2.  Find Orc and attack until dead.
    3.  Verify "Orc dies!" message appears in log.
    4.  Verify Orc becomes corpse (char changes to %).
    5.  Verify player can walk onto corpse tile.
  </how-to-verify>
  <resume-signal>Combat and death loop working as expected.</resume-signal>
</task>

</tasks>

<verification>
- [ ] Dead entities become non-blocking corpses.
- [ ] Death logic triggered by 'entity_died' event.
- [ ] Render order correct (corpses under entities).
</verification>

<success_criteria>
- Full combat loop from attack to death works using event system.
</success_criteria>

<output>
After completion, create `.planning/phases/04-combat-feedback/04-04-SUMMARY.md`
</output>
