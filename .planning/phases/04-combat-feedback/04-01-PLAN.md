---
phase: 04-combat-feedback
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - config.py
  - main.py
  - ecs/systems/ui_system.py
  - ui/message_log.py
autonomous: true
must_haves:
  truths:
    - "A message log area appears at the bottom of the screen"
    - "Systems can dispatch 'log_message' events"
    - "Messages appear in the log with specified colors"
    - "Old messages scroll up/out"
  artifacts:
    - path: "ui/message_log.py"
      provides: "MessageLog class with add_message and render methods"
    - path: "config.py"
      contains: "LOG_HEIGHT"
  key_links:
    - from: "esper.dispatch('log_message')"
      to: "MessageLog.add_message"
      via: "Event Handler in UI/Game"
---

<objective>
Implement the Message Log UI and Event System to provide textual feedback to the player.
Purpose: Allow the game to communicate events (attacks, damage, death) to the player.
Output: A scrolling text log at the bottom of the screen.
</objective>

<context>
@.planning/phases/04-combat-feedback/04-RESEARCH.md
@ecs/systems/ui_system.py
@main.py
@config.py
</context>

<tasks>

<task type="auto">
  <name>Configure Layout and Create MessageLog Class</name>
  <files>config.py, ui/message_log.py</files>
  <action>
    1.  Modify `config.py`: Add `LOG_HEIGHT = 140`.
    2.  Create `ui/message_log.py`:
        -   Class `MessageLog`
        -   Attributes: `messages` (list of `(text, color)`), `rect` (pygame.Rect), `font` (pygame.font).
        -   Method `add_message(text, color)`: Appends to list, trims to max length (e.g., 50).
        -   Method `draw(surface)`: Blits text from bottom up within `rect`.
        -   Support "rich text" parsing if easy, or just `(text, color)` tuples for now. (Simple tuple list is sufficient for start, per Research Plan 01).
  </action>
  <verify>Check `config.py` has LOG_HEIGHT. Check `ui/message_log.py` exists.</verify>
  <done>Configuration and class structure ready.</done>
</task>

<task type="auto">
  <name>Integrate Message Log into UI System</name>
  <files>main.py, ecs/systems/ui_system.py</files>
  <action>
    1.  Update `main.py`: Adjust `Camera` viewport height to `SCREEN_HEIGHT - HEADER_HEIGHT - LOG_HEIGHT`.
    2.  Update `UISystem` in `ecs/systems/ui_system.py`:
        -   Initialize `MessageLog` instance.
        -   Define `log_rect` area (bottom of screen, left of sidebar).
        -   Register event handler for "log_message" to call `message_log.add_message`.
        -   In `process()`, call `message_log.draw(surface)`.
        -   Draw a border/background for the log area.
  </action>
  <verify>Run game. Ensure map is not squashed (camera viewport updated). See empty log area.</verify>
  <done>UI System renders the log area and listens for events.</done>
</task>

<task type="checkpoint:human-verify">
  <what-built>Message Log UI and Event Connection</what-built>
  <how-to-verify>
    1.  Run `python3 main.py`.
    2.  Verify a new black/dark box appears at the bottom left (under map).
    3.  (Ideally) Temporarily add `esper.dispatch("log_message", text="Welcome!", color=(255, 255, 255))` in `main.py` or `Game.startup` to see text.
  </how-to-verify>
  <resume-signal>Log appears and layout looks correct.</resume-signal>
</task>

</tasks>

<verification>
- [ ] Log area visible.
- [ ] Map rendering respects new viewport (doesn't overlap log).
- [ ] "log_message" event adds text to screen.
</verification>

<success_criteria>
- Log UI is visible.
- Text can be added via `esper.dispatch`.
</success_criteria>

<output>
After completion, create `.planning/phases/04-combat-feedback/04-01-SUMMARY.md`
</output>
