---
phase: 04-combat-feedback
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - config.py
  - main.py
  - ecs/systems/ui_system.py
  - ui/message_log.py
autonomous: true
must_haves:
  truths:
    - "A message log area appears at the bottom of the screen"
    - "Systems can dispatch 'log_message' events"
    - "Messages appear in the log with specified colors"
    - "Rich text tags (e.g., [color=red]) are parsed correctly"
    - "Old messages scroll up/out"
  artifacts:
    - path: "ui/message_log.py"
      provides: "MessageLog class with add_message, render, and parse_rich_text"
    - path: "config.py"
      contains: "LOG_HEIGHT"
  key_links:
    - from: "esper.dispatch('log_message')"
      to: "MessageLog.add_message"
      via: "Event Handler in UI/Game"
---

<objective>
Implement the Message Log UI and Event System to provide textual feedback to the player.
Purpose: Allow the game to communicate events (attacks, damage, death) to the player with color coding.
Output: A scrolling text log at the bottom of the screen capable of displaying colored text.
</objective>

<context>
@.planning/phases/04-combat-feedback/04-RESEARCH.md
@ecs/systems/ui_system.py
@main.py
@config.py
</context>

<tasks>

<task type="auto">
  <name>Configure Layout and Create MessageLog with Rich Text Parser</name>
  <files>config.py, ui/message_log.py</files>
  <action>
    1.  Modify `config.py`: Add `LOG_HEIGHT = 140`.
    2.  Create `ui/message_log.py`:
        -   **Rich Text Parser (MANDATORY):**
            -   Implement `parse_rich_text(text: str) -> List[Tuple[str, Color]]`.
            -   Must support custom tags like `[color=red]Danger[/color]`.
            -   Example input: "You hit [color=red]Orc[/color] for [color=yellow]5[/color] damage."
            -   Output: `[("You hit ", WHITE), ("Orc", RED), (" for ", WHITE), ("5", YELLOW), (" damage.", WHITE)]`.
        -   **MessageLog Class:**
            -   Attributes: `messages` (list of parsed lines), `rect`, `font`.
            -   `add_message(text, color=None)`: Uses `parse_rich_text` to process input. If `color` provided, wraps text in that color tag before parsing (or overrides).
            -   `draw(surface)`: Blits text from bottom up within `rect`. Handles the list of (text, color) chunks for each line.
  </action>
  <verify>
    -   `config.py` has LOG_HEIGHT.
    -   `ui/message_log.py` has `parse_rich_text` function.
    -   Unit test/script: `parse_rich_text("Hello [color=red]World[/color]")` returns correct tuples.
  </verify>
  <done>MessageLog class and rich text parser implemented.</done>
</task>

<task type="auto">
  <name>Integrate Message Log into UI System</name>
  <files>main.py, ecs/systems/ui_system.py</files>
  <action>
    1.  Update `main.py`: Adjust `Camera` viewport height to `SCREEN_HEIGHT - HEADER_HEIGHT - LOG_HEIGHT`.
    2.  Update `UISystem` in `ecs/systems/ui_system.py`:
        -   Initialize `MessageLog` instance.
        -   Define `log_rect` area (bottom of screen).
        -   Register event handler for "log_message" to call `message_log.add_message`.
        -   In `process()`, call `message_log.draw(surface)`.
        -   Draw a border/background for the log area.
  </action>
  <verify>Run game. Ensure map is not squashed. See empty log area.</verify>
  <done>UI System renders the log area and listens for events.</done>
</task>

<task type="checkpoint:human-verify">
  <what-built>Message Log UI and Event Connection</what-built>
  <how-to-verify>
    1.  Run `python3 main.py`.
    2.  Verify a new black/dark box appears at the bottom.
    3.  (Ideally) Temporarily add `esper.dispatch("log_message", text="Welcome [color=green]Traveler[/color]!")` in `Game.startup`.
    4.  Verify "Traveler" appears in green.
  </how-to-verify>
  <resume-signal>Log appears, layout is correct, and colors work.</resume-signal>
</task>

</tasks>

<verification>
- [ ] Log area visible.
- [ ] Map viewport resized correctly.
- [ ] Rich text tags render as colors.
</verification>

<success_criteria>
- Log UI visible.
- Rich text parsing works.
</success_criteria>

<output>
After completion, create `.planning/phases/04-combat-feedback/04-01-SUMMARY.md`
</output>