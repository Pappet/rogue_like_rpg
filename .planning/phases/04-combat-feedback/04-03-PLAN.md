---
phase: 04-combat-feedback
plan: 03
type: execute
wave: 2
depends_on: [04-01, 04-02]
files_modified:
  - ecs/components.py
  - ecs/systems/action_system.py
  - ecs/systems/combat_system.py
  - main.py
autonomous: true
must_haves:
  truths:
    - "Bumping into an Orc triggers an attack"
    - "Message log shows damage dealt"
    - "Orc HP decreases"
    - "System dispatches 'entity_died' event when HP reaches zero"
  artifacts:
    - path: "ecs/systems/combat_system.py"
      provides: "CombatSystem class"
    - path: "ecs/components.py"
      contains: "class AttackIntent"
  key_links:
    - from: "CombatSystem"
      to: "esper.dispatch('entity_died')"
      via: "Death condition check"
    - from: "CombatSystem"
      to: "esper.dispatch('log_message')"
      via: "Attack resolution"
---

<objective>
Implement Bump Combat and Damage Calculation.
Purpose: Allow player to fight monsters and trigger death events.
Output: Working combat system with feedback and lifecycle events using Stats component.
</objective>

<context>
@ecs/systems/action_system.py
@ecs/components.py
@.planning/phases/04-combat-feedback/04-01-SUMMARY.md
@.planning/phases/04-combat-feedback/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create AttackIntent and Modify Action System</name>
  <files>ecs/components.py, ecs/systems/action_system.py</files>
  <action>
    1.  Modify `ecs/components.py`: Add `AttackIntent` component (`target_entity`).
    2.  Modify `ecs/systems/action_system.py`:
        -   In movement logic: If target tile has `Blocker`, check if target entity has `Stats`.
        -   If yes: Do NOT move. Create `AttackIntent(target_entity=target)` on acting entity.
  </action>
  <verify>Bump into Orc. Player should not move. Check (debug) if AttackIntent exists.</verify>
  <done>Bump triggers intent.</done>
</task>

<task type="auto">
  <name>Implement Combat System with Death Event Dispatch</name>
  <files>ecs/systems/combat_system.py, main.py</files>
  <action>
    1.  Create `ecs/systems/combat_system.py`:
        -   Class `CombatSystem(esper.Processor)`.
        -   `process()`: Iterate entities with `AttackIntent`.
        -   Get stats from `Stats` components (NOT `Fighter`) of attacker and target.
        -   Calculate damage: `max(0, attacker.power - target.defense)`.
        -   Subtract HP from target.
        -   Dispatch `log_message` with damage details.
        -   **Death Check (MANDATORY):**
            -   If `target_stats.hp <= 0`:
                -   `esper.dispatch("entity_died", entity=target_id)`
        -   Remove `AttackIntent`.
    2.  Register `CombatSystem` in `main.py`.
  </action>
  <verify>Bump Orc. See message in log. If Orc dies, verify (via print) that "entity_died" event would be dispatched.</verify>
  <done>Combat loop functional and dispatches death events using Stats.</done>
</task>

</tasks>

<verification>
- [ ] Bumping monster produces log message.
- [ ] Monster HP goes down.
- [ ] entity_died event is dispatched on fatal hit.
</verification>

<success_criteria>
- Combat mechanics working with Stats component.
- Lifecycle events (death) announced to system.
</success_criteria>

<output>
After completion, create `.planning/phases/04-combat-feedback/04-03-SUMMARY.md`
</output>
