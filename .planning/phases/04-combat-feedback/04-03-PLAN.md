---
phase: 04-combat-feedback
plan: 03
type: execute
wave: 2
depends_on: [04-01, 04-02]
files_modified:
  - ecs/components.py
  - ecs/systems/action_system.py
  - ecs/systems/combat_system.py
  - main.py
autonomous: true
must_haves:
  truths:
    - "Bumping into an Orc triggers an attack"
    - "Message log shows damage dealt"
    - "Orc HP decreases"
  artifacts:
    - path: "ecs/systems/combat_system.py"
      provides: "CombatSystem class"
    - path: "ecs/components.py"
      contains: "class AttackIntent"
  key_links:
    - from: "ActionSystem"
      to: "AttackIntent"
      via: "Component creation on bump"
    - from: "CombatSystem"
      to: "esper.dispatch('log_message')"
      via: "Attack resolution"
---

<objective>
Implement Bump Combat and Damage Calculation.
Purpose: Allow player to fight monsters.
Output: Working combat system with feedback.
</objective>

<context>
@ecs/systems/action_system.py
@ecs/components.py
@.planning/phases/04-combat-feedback/04-01-SUMMARY.md
@.planning/phases/04-combat-feedback/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create AttackIntent and Modify Action System</name>
  <files>ecs/components.py, ecs/systems/action_system.py</files>
  <action>
    1.  Modify `ecs/components.py`: Add `AttackIntent` component (`target_entity`, `damage` - optional, can be calculated in combat system).
    2.  Modify `ecs/systems/action_system.py`:
        -   In movement logic: If target tile has `Blocker`, check if entity has `Fighter`.
        -   If yes: Do NOT move. Create `AttackIntent` on acting entity.
        -   If no fighter: Block as usual.
  </action>
  <verify>Bump into Orc. Player should not move. Check (debug) if AttackIntent exists.</verify>
  <done>Bump triggers intent.</done>
</task>

<task type="auto">
  <name>Implement Combat System</name>
  <files>ecs/systems/combat_system.py, main.py</files>
  <action>
    1.  Create `ecs/systems/combat_system.py`:
        -   Class `CombatSystem(esper.Processor)`.
        -   `process()`: Iterate entities with `AttackIntent`.
        -   Get Attacker stats and Target stats (`Fighter` component).
        -   Calculate damage (Attacker Power - Target Defense).
        -   Subtract HP.
        -   `esper.dispatch("log_message", ...)` with colored text (e.g. "Player hits Orc for 3 damage!").
        -   Remove `AttackIntent`.
    2.  Register `CombatSystem` in `main.py` (add to world). Ensure it runs AFTER ActionSystem.
  </action>
  <verify>Bump Orc. See message in log. Orc HP reduces (verify via debug print or UI if connected).</verify>
  <done>Combat loop functional.</done>
</task>

</tasks>

<verification>
- [ ] Bumping monster produces log message.
- [ ] Monster HP goes down.
</verification>

<success_criteria>
- Combat mechanics working.
</success_criteria>

<output>
After completion, create `.planning/phases/04-combat-feedback/04-03-SUMMARY.md`
</output>
