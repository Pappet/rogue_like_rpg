---
phase: 22-debug-system-refinement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [ecs/systems/debug_render_system.py, game_states.py, tests/verify_phase_20.py]
autonomous: true

must_haves:
  truths:
    - "Debug overlay updates immediately when entering a new map."
    - "Debug FOV visualization matches AI visibility (walls block sight)."
    - "Debug labels and markers only show for entities on the player's current layer."
    - "Verification script tests/verify_phase_20.py runs without error."
  artifacts:
    - path: "ecs/systems/debug_render_system.py"
      provides: "Updated DebugRenderSystem with map sync and layer support"
    - path: "game_states.py"
      provides: "Wired map transition and draw calls"
  key_links:
    - from: "game_states.py"
      to: "ecs/systems/debug_render_system.py"
      via: "set_map and process calls"
---

<objective>
Fix stale debug data after map transitions, align transparency logic with AI systems, and repair outdated verification tests.

Purpose: Ensure the debug system remains a high-fidelity diagnostic tool across all game states and environments.
Output: Refined DebugRenderSystem and updated game loop integration.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@ecs/systems/debug_render_system.py
@game_states.py
@tests/verify_phase_20.py
</context>

<tasks>

<task type="auto">
  <name>Refactor DebugRenderSystem Logic</name>
  <files>ecs/systems/debug_render_system.py</files>
  <action>
    1. Add `set_map(self, map_container)` method to update the internal map reference.
    2. Implement `_is_transparent(self, x, y, layer)` helper:
       - Get tile from `map_container`.
       - Return False if tile is None or `tile.transparent` is False.
       - Return False if `tile.sprites.get(SpriteLayer.GROUND) == "#"`.
       - Otherwise return True.
    3. Update `process(self, surface, flags, player_layer)` signature.
    4. Update `_render_fov_overlay` to use `player_layer` in `get_tile` call instead of hardcoded 0.
    5. Update `_render_npc_fov` to use `_is_transparent` and only process NPCs where `pos.layer == player_layer`.
    6. Update `_render_ai_labels` and `_render_chase_targets` to only render entities where `pos.layer == player_layer`.
  </action>
  <verify>Code inspection confirms `set_map` exists and `#` wall check is implemented.</verify>
  <done>DebugRenderSystem handles map updates and respects layer/wall visibility.</done>
</task>

<task type="auto">
  <name>Integrate System Updates in Game State</name>
  <files>game_states.py</files>
  <action>
    1. In `Game.transition_map`, after assigning the new map to `self.map_container`, call `self.debug_render_system.set_map(self.map_container)`.
    2. In `Game.draw`, extract `player_layer` (e.g., from `self.persist["player_layer"]` or by querying the player entity's `Position` component).
    3. Update the call to `self.debug_render_system.process(surface, self.persist["debug_flags"], player_layer)`.
  </action>
  <verify>No runtime errors when toggling debug mode or transitioning maps.</verify>
  <done>Map transitions and draw calls are correctly wired to the debug system.</done>
</task>

<task type="auto">
  <name>Repair Verification Test</name>
  <files>tests/verify_phase_20.py</files>
  <action>
    Update `test_debug_render_system` to pass `flags={"player_fov": True}` and `player_layer=0` to the `system.process` call.
  </action>
  <verify>Run `python tests/verify_phase_20.py` and ensure it passes.</verify>
  <done>Verification test matches the updated system signature.</done>
</task>

</tasks>

<verification>
1. Start game, enable debug (F3).
2. Enter a portal/door to change maps (e.g., Village).
3. Verify debug FOV and AI markers update to the new map's entities and tiles.
4. Verify that `#` walls correctly block NPC FOV visualization in debug mode.
5. Run `python tests/verify_phase_20.py`.
</verification>

<success_criteria>
- DebugRenderSystem supports map transitions via `set_map`.
- Transparency logic handles `#` wall fallback consistent with AI.
- Debug system filters output by `player_layer`.
- Phase 20 verification test passes.
</success_criteria>

<output>
After completion, create `.planning/phases/22-debug-system-refinement/22-01-SUMMARY.md`
</output>
