---
phase: 23-item-entity-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [ecs/components.py, entities/entity_factory.py, services/party_service.py, entities/item_registry.py, assets/data/items.json, services/resource_loader.py, main.py]
autonomous: true

must_haves:
  truths:
    - "Item components (Portable, ItemMaterial, StatModifiers) are defined."
    - "Stats component includes base fields (base_power, base_defense, etc.)."
    - "Item templates are defined in items.json."
    - "ResourceLoader populates ItemRegistry on startup."
  artifacts:
    - path: "entities/item_registry.py"
      provides: "ItemRegistry and ItemTemplate"
    - path: "assets/data/items.json"
      provides: "Initial item data"
  key_links:
    - from: "services/resource_loader.py"
      to: "entities/item_registry.py"
      via: "ResourceLoader.load_items()"
---

<objective>
Establish the ECS component foundation for items and the data-driven registry system. This plan focuses on defining how items are described in data and how they are represented in the ECS world.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/23-item-entity-foundation/23-RESEARCH.md
@ecs/components.py
@entities/entity_factory.py
@services/party_service.py
@services/resource_loader.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ECS Components for Items and Effective Stats</name>
  <files>ecs/components.py, entities/entity_factory.py, services/party_service.py</files>
  <action>
    1. In `ecs/components.py`:
       - Update `Stats` component to include base fields for all primary stats (e.g., `base_hp`, `base_power`, `base_defense`, `base_mana`, `base_perception`, `base_intelligence`). Keep the existing fields as the 'effective' values.
       - Add `StatModifiers` component: `hp: int, power: int, defense: int, mana: int, perception: int, intelligence: int`.
       - Add `Portable` component: `weight: float` (kg).
       - Add `ItemMaterial` component: `material: str` (e.g., 'iron', 'wood', 'glass').
    2. Update `entities/entity_factory.py`:
       - In `EntityFactory.create()`, initialize both base and effective stat fields from the template data.
    3. Update `services/party_service.py`:
       - In `PartyService.create_initial_party()`, initialize both base and effective stat fields for the player.
  </action>
  <verify>Run `pytest` (if existing tests exist) or a small script to verify `Stats` can be created with new fields and `Portable`/`ItemMaterial` are available.</verify>
  <done>Stats component supports the Effective Stats pattern; new item components are defined.</done>
</task>

<task type="auto">
  <name>Task 2: Create Item Registry and Templates</name>
  <files>entities/item_registry.py, assets/data/items.json</files>
  <action>
    1. Create `entities/item_registry.py`:
       - Define `ItemTemplate` dataclass: `id, name, sprite, color, sprite_layer, weight, material, description, stats (dict)`.
       - Define `ItemRegistry` singleton class with `register()`, `get()`, `clear()`, and `all_ids()` methods (mirroring `EntityRegistry`).
    2. Create `assets/data/items.json`:
       - Define at least: `iron_sword`, `wooden_club`, `health_potion`.
       - Ensure `sprite_layer` is set to `ITEMS`.
       - `health_potion` should have a `weight` and `material: glass`, but maybe no `stats` modifiers for now (handled in Phase 26).
  </action>
  <verify>Check that `entities/item_registry.py` exists and `items.json` has valid JSON syntax.</verify>
  <done>Item templates and registry are implemented.</done>
</task>

<task type="auto">
  <name>Task 3: Implement Item Resource Loading</name>
  <files>services/resource_loader.py, main.py</files>
  <action>
    1. In `services/resource_loader.py`:
       - Implement `ResourceLoader.load_items(filepath)`.
       - It should parse `items.json`, validate required fields (id, name, sprite, sprite_layer, weight, material), and register `ItemTemplate` instances in `ItemRegistry`.
    2. In `main.py`:
       - Add `ResourceLoader.load_items("assets/data/items.json")` in `GameController.__init__`.
  </action>
  <verify>Run `python main.py` and ensure it starts without errors. Verify via logs or a temporary print that items are loaded.</verify>
  <done>Item data is loaded into the registry at startup.</done>
</task>

</tasks>

<verification>
1. Verify `Stats` component has `base_` fields.
2. Verify `ItemRegistry` contains the items defined in `items.json`.
3. Verify `ResourceLoader` doesn't crash on valid `items.json`.
</verification>

<success_criteria>
1. Item templates loaded from `assets/data/items.json` into `ItemRegistry`.
2. New ECS components (`Portable`, `ItemMaterial`, `StatModifiers`) are available for use.
3. `Stats` component supports the "Effective Stats" pattern with dual fields.
</success_criteria>

<output>
After completion, create `.planning/phases/23-item-entity-foundation/23-01-SUMMARY.md`
</output>
