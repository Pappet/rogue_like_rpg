---
phase: 23-item-entity-foundation
plan: 02
type: execute
wave: 2
depends_on: [23-01]
files_modified: [entities/item_factory.py, services/party_service.py, game_states.py, tests/verify_item_foundation.py]
autonomous: true

must_haves:
  truths:
    - "Items can be spawned on the ground."
    - "Carried items survive map transitions."
    - "get_entity_closure accurately identifies all items owned by the player."
  artifacts:
    - path: "entities/item_factory.py"
      provides: "Item creation logic"
    - path: "tests/verify_item_foundation.py"
      provides: "Automated test for item persistence"
  key_links:
    - from: "game_states.py"
      to: "services/party_service.py"
      via: "get_entity_closure()"
---

<objective>
Implement the item factory and ensure that items carried by the player persist across map transitions. This completes the foundation of the item system by making items "real" world objects that follow the player.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/23-item-entity-foundation/23-01-SUMMARY.md
@entities/item_registry.py
@services/party_service.py
@game_states.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Item Factory</name>
  <files>entities/item_factory.py</files>
  <action>
    1. Create `entities/item_factory.py`:
       - Implement `ItemFactory.create(world, template_id)` which creates an item entity with `Name`, `Renderable`, `Portable`, `ItemMaterial`, and `StatModifiers` (if applicable) based on the template. It should NOT have a `Position` by default.
       - Implement `ItemFactory.create_on_ground(world, template_id, x, y, layer)` which calls `create()` and adds a `Position` component.
  </action>
  <verify>Check if `entities/item_factory.py` exists and can be imported.</verify>
  <done>Item factory is implemented.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Transitive Closure for Map Transitions</name>
  <files>services/party_service.py, game_states.py</files>
  <action>
    1. In `services/party_service.py`:
       - Implement `get_entity_closure(world, root_entity)`:
         - Uses a set to collect `root_entity`.
         - Recursively (or via stack) finds all entities in `Inventory.items` for any entity already in the closure.
         - Returns a list of all gathered entity IDs.
    2. In `game_states.py`:
       - Update `Game.transition_map()`:
         - Replace `exclude_entities=[self.player_entity]` with `exclude_entities=get_entity_closure(self.world, self.player_entity)`.
  </action>
  <verify>Check that `get_entity_closure` is correctly imported and called in `game_states.py`.</verify>
  <done>Map transitions now preserve all items in the player's inventory closure.</done>
</task>

<task type="auto">
  <name>Task 3: Functional Verification of Item Foundation</name>
  <files>tests/verify_item_foundation.py</files>
  <action>
    1. Create `tests/verify_item_foundation.py`:
       - Initialize a minimal ECS world and MapService.
       - Create a player with an `Inventory`.
       - Create an item on the ground via `ItemFactory.create_on_ground()`.
       - "Pick up" the item manually (remove `Position`, add ID to player's `Inventory.items`).
       - Trigger a map transition.
       - Verify that the item entity still exists in the world and its components are intact.
       - Also verify that an item NOT in inventory is deleted during transition (normal `freeze` behavior).
  </action>
  <verify>Run `python tests/verify_item_foundation.py` and ensure all assertions pass.</verify>
  <done>Item foundation and persistence are verified.</done>
</task>

</tasks>

<verification>
1. Run `tests/verify_item_foundation.py`.
2. Check that an item spawned on ground is visible in-game (manually by adding one to `create_village_scenario` temporarily).
</verification>

<success_criteria>
1. Items placed on ground render correctly.
2. Carried items survive map transitions.
3. `get_entity_closure` correctly identifies all items to be preserved.
</success_criteria>

<output>
After completion, create `.planning/phases/23-item-entity-foundation/23-02-SUMMARY.md`
</output>
