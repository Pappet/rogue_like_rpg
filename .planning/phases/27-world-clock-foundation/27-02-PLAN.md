---
phase: 27-world-clock-foundation
plan: 02
type: execute
wave: 2
depends_on: [27-01]
files_modified: [ecs/components.py, ecs/systems/action_system.py, game_states.py, ecs/systems/ui_system.py]
autonomous: true

must_haves:
  truths:
    - "Map transitions (portals) advance the clock by travel_ticks"
    - "TurnSystem.round_counter stays in sync with WorldClock.total_ticks + 1"
    - "UI header displays Day, Time (HH:MM), and TOD phase"
  artifacts:
    - path: "ecs/components.py"
      contains: "travel_ticks: int = 0"
    - path: "ecs/systems/action_system.py"
      contains: "portal.travel_ticks"
  key_links:
    - from: "game_states.py"
      to: "services/world_clock_service.py"
      via: "clock.advance(travel_ticks) in transition_map"
    - from: "ecs/systems/action_system.py"
      to: "game_states.py"
      via: "change_map event with travel_ticks"
---

<objective>
Enable time-consuming travel between maps and display the current world time in the game header.

Purpose: Makes world navigation feel realistic and informs player of time-based mechanics.
Output: Updated Portal component, travel-time logic in ActionSystem, and enhanced UI header.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-world-clock-foundation/27-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Portal component and travel logic</name>
  <files>ecs/components.py, ecs/systems/action_system.py, game_states.py</files>
  <action>
    1. Update `ecs/components.py`: Add `travel_ticks: int = 0` to `Portal` dataclass.
    2. Update `ecs/systems/action_system.py`: In `ActionSystem.perform_action`, when handling "Enter Portal", extract `portal.travel_ticks` and include it in the `change_map` event payload as `"travel_ticks"`.
    3. Update `game_states.py`: Update `Game.transition_map` to:
       - Accept `travel_ticks` from `event_data` (default 0).
       - Call `self.world_clock.advance(travel_ticks)` before entering the new map.
       - Synchronize `self.turn_system.round_counter = self.world_clock.total_ticks + 1`.
  </action>
  <verify>Trigger a map transition with `travel_ticks > 0` and verify clock and round_counter jump accordingly.</verify>
  <done>Map transitions correctly consume time and keep turn counters in sync.</done>
</task>

<task type="auto">
  <name>Task 2: Update UI Header with clock info</name>
  <files>ecs/systems/ui_system.py</files>
  <action>
    1. Update `UISystem.__init__` to accept `world_clock`.
    2. Update `UISystem.draw_header`:
       - Display Day: `world_clock.day`.
       - Display Time: `HH:MM` derived from `world_clock.hour` and `world_clock.minute`.
       - Display Phase: `(DAWN)`, `(DAY)`, etc.
       - Adjust layout to prevent overlapping with Round info or stats.
  </action>
  <verify>Run the game and observe the header. It should show something like "Day 1 - 08:00 (DAY)".</verify>
  <done>Player can see the current world time and phase in the UI.</done>
</task>

</tasks>

<verification>
Verify that map travel correctly advances the clock.
Verify that the UI displays the correct time and phase.
</verification>

<success_criteria>
- Travel time is applied during map transitions.
- Round counter and WorldClock total ticks are synchronized.
- UI header shows human-readable time and phase.
</success_criteria>

<output>
After completion, create `.planning/phases/27-world-clock-foundation/27-02-SUMMARY.md`
</output>
