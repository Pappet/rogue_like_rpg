---
phase: 27-world-clock-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [config.py, services/world_clock_service.py, main.py, game_states.py, ecs/systems/turn_system.py]
autonomous: true

must_haves:
  truths:
    - "WorldClockService exists and tracks total_ticks"
    - "Clock advances by 1 tick when player ends turn"
    - "Clock state (total_ticks) persists through Game state transitions"
  artifacts:
    - path: "services/world_clock_service.py"
      provides: "Timekeeping logic"
    - path: "config.py"
      contains: "DAWN_START"
  key_links:
    - from: "ecs/systems/turn_system.py"
      to: "services/world_clock_service.py"
      via: "clock.advance(1) call"
---

<objective>
Implement the core WorldClock service and integrate it into the turn loop so that time advances with every action.

Purpose: Provides the foundation for day/night cycles and NPC schedules.
Output: WorldClockService class and turn-based time advancement.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-world-clock-foundation/27-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define constants and implement WorldClockService</name>
  <files>config.py, services/world_clock_service.py</files>
  <action>
    1. Add TOD constants to `config.py`:
       - `TICKS_PER_HOUR = 60`
       - `DAWN_START = 5`, `DAY_START = 8`, `DUSK_START = 18`, `NIGHT_START = 21`
    2. Create `services/world_clock_service.py` with `WorldClockService` class.
    3. Implement properties: `hour`, `day`, `minute`, `phase`.
    4. Implement `advance(amount=1)` which increments `total_ticks` and dispatches `"clock_tick"` event with state.
    5. Implement `get_state()` returning dict of time info.
  </action>
  <verify>Run a script to instantiate WorldClockService and verify 60 ticks = 1 hour, 1440 ticks = 1 day, and phases match boundaries.</verify>
  <done>WorldClockService correctly computes time units and phases from total_ticks.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate WorldClockService into Game state</name>
  <files>main.py, game_states.py</files>
  <action>
    1. In `main.py`, instantiate `WorldClockService` in `GameController.__init__` and add to `self.persist`.
    2. In `game_states.py`, update `Game.startup` to retrieve `world_clock` from `persist`.
    3. Pass `world_clock` reference to `TurnSystem` when initializing or updating it.
  </action>
  <verify>Inspect `GameController.persist` to ensure `world_clock` is present.</verify>
  <done>WorldClockService is persistent across game states.</done>
</task>

<task type="auto">
  <name>Task 3: Hook WorldClock into TurnSystem</name>
  <files>ecs/systems/turn_system.py</files>
  <action>
    1. Update `TurnSystem.__init__` to accept optional `world_clock`.
    2. Update `TurnSystem.end_player_turn` to call `self.world_clock.advance(1)` if clock is present.
  </action>
  <verify>End player turn in game and check if `world_clock.total_ticks` increments (can use debug print or check in next task's UI).</verify>
  <done>Player actions (movement, wait, etc.) advance world time.</done>
</task>

</tasks>

<verification>
Verify that total_ticks increases by 1 for every player turn taken.
Verify that hour increments after 60 ticks.
</verification>

<success_criteria>
- WorldClockService manages ticks/hours/days correctly.
- Time advances on each player turn.
- Time state persists through state switches (e.g., opening inventory).
</success_criteria>

<output>
After completion, create `.planning/phases/27-world-clock-foundation/27-01-SUMMARY.md`
</output>
