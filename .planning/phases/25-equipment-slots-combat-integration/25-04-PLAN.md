---
phase: 25-equipment-slots-combat-integration
plan: 04
type: execute
wave: 4
depends_on: [25-03]
files_modified: [ecs/systems/combat_system.py, assets/data/items.json]
autonomous: true

must_haves:
  truths:
    - "Damage in combat is calculated using effective power and defense."
    - "Equipping a weapon increases damage dealt."
    - "Equipping armor decreases damage taken."
  artifacts:
    - path: "ecs/systems/combat_system.py"
      provides: "Combat calculations using EffectiveStats"
    - path: "assets/data/items.json"
      provides: "Equippable items (Sword, Armor)"
  key_links:
    - from: "ecs/systems/combat_system.py"
      to: "ecs/components.py"
      via: "reading EffectiveStats"
---

<objective>
Integrate the equipment system with combat mechanics and provide actual equippable items for testing and gameplay.

Purpose: Completing the feedback loop where gear impacts gameplay outcomes.
Output: Integrated CombatSystem and test equipment.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-equipment-slots-combat-integration/25-03-SUMMARY.md
@ecs/systems/combat_system.py
@assets/data/items.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CombatSystem</name>
  <files>ecs/systems/combat_system.py</files>
  <action>
    Modify CombatSystem.process:
    1. Try to get EffectiveStats for attacker and target.
    2. Fall back to Stats if EffectiveStats is missing (for robust handling of non-player entities).
    3. Use effective_power and effective_defense for damage calculation: damage = max(0, power - defense).
  </action>
  <verify>Check calculation logic in CombatSystem.</verify>
  <done>CombatSystem uses EffectiveStats for damage and defense.</done>
</task>

<task type="auto">
  <name>Task 2: Add Equippable Items and Verify</name>
  <files>assets/data/items.json</files>
  <action>
    1. Add at least two equippable items to assets/data/items.json:
       - "iron_sword": main_hand, power: 5.
       - "leather_armor": body, defense: 3.
    2. Verify end-to-end:
       - Spawn items (manually or via village scenario).
       - Pick up, equip.
       - Attack a monster.
       - Check log for increased damage.
  </action>
  <verify>Manual verification of combat log output with and without equipment.</verify>
  <done>System is fully functional and verified with real data.</done>
</task>

</tasks>

<verification>
Ensure combat logs reflect the stat bonuses from equipped items.
</verification>

<success_criteria>
1. CombatSystem handles fallback to base Stats gracefully.
2. Weapon increases damage.
3. Armor decreases damage taken.
4. End-to-end flow (Pickup -> Inventory -> Equip -> Combat) works.
</success_criteria>

<output>
After completion, create `.planning/phases/25-equipment-slots-combat-integration/25-04-SUMMARY.md`
</output>
