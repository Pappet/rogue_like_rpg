---
phase: 25-equipment-slots-combat-integration
plan: 04
type: execute
wave: 4
depends_on: [25-03]
files_modified: [ecs/systems/combat_system.py, ecs/systems/action_system.py, ecs/systems/ui_system.py, assets/data/items.json]
autonomous: true

must_haves:
  truths:
    - "Damage in combat is calculated using effective power and defense."
    - "Action costs and HP/MP bars respect effective max values."
    - "Equipping gear affects combat outcomes correctly."
  artifacts:
    - path: "ecs/systems/combat_system.py"
      provides: "Combat calculations using EffectiveStats"
    - path: "ecs/systems/action_system.py"
      provides: "Mana checks using EffectiveStats"
    - path: "ecs/systems/ui_system.py"
      provides: "HP/MP bars using EffectiveStats"
    - path: "assets/data/items.json"
      provides: "Equippable items with modifiers"
---

<objective>
Integrate the equipment system with combat and action mechanics, and provide actual equippable items for testing and gameplay.

Purpose: Completing the feedback loop where gear impacts gameplay outcomes and resource management.
Output: Integrated Systems and test equipment.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-equipment-slots-combat-integration/25-03-SUMMARY.md
@ecs/systems/combat_system.py
@ecs/systems/action_system.py
@ecs/systems/ui_system.py
@assets/data/items.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Combat and Action Systems</name>
  <files>ecs/systems/combat_system.py, ecs/systems/action_system.py</files>
  <action>
    1. Modify CombatSystem.process:
       - Use EffectiveStats for power and defense.
       - Fall back to Stats if EffectiveStats is missing.
       - damage = max(0, attacker_power - target_defense).
    2. Modify ActionSystem.perform_action:
       - When checking mana costs or health costs, use EffectiveStats.max_mana and EffectiveStats.max_hp for any percentage-based logic or boundary checks.
  </action>
  <verify>Verify combat log and action execution with equipment.</verify>
  <done>Combat and Action systems respect equipment bonuses.</done>
</task>

<task type="auto">
  <name>Task 2: Update UI Bars</name>
  <files>ecs/systems/ui_system.py</files>
  <action>
    Update UISystem.draw_stats_bars:
    - When calculating fill percentage for HP and MP bars, use EffectiveStats.max_hp and EffectiveStats.max_mana.
    - Fall back to Stats if EffectiveStats is missing.
  </action>
  <verify>Equip an item that increases max HP and check if the HP bar ratio remains correct.</verify>
  <done>UI bars correctly reflect effective max values.</done>
</task>

<task type="auto">
  <name>Task 3: Add Equippable Items and Verify</name>
  <files>assets/data/items.json</files>
  <action>
    1. Add equippable items to assets/data/items.json:
       - "iron_sword": main_hand, power: 5.
       - "leather_armor": body, defense: 3.
       - "circlet": head, max_mana: 10.
    2. Verify end-to-end:
       - Spawn items, pick up, equip.
       - Observe sidebar updates (Power/Defense).
       - Attack a monster and check logs for increased damage.
       - Check if HP/MP bars handle increased max values.
  </action>
  <verify>Manual verification of combat log and UI output.</verify>
  <done>System is fully functional and verified with real data.</done>
</task>

</tasks>

<verification>
Ensure all core systems prioritize EffectiveStats over base Stats.
</verification>

<success_criteria>
1. CombatSystem uses effective values.
2. ActionSystem and UI respect effective max HP/MP.
3. Weapon increases damage; Armor decreases damage taken.
4. End-to-end flow works flawlessly.
</success_criteria>

<output>
After completion, create `.planning/phases/25-equipment-slots-combat-integration/25-04-SUMMARY.md`
</output>
