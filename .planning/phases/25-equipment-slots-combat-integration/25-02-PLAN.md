---
phase: 25-equipment-slots-combat-integration
plan: 02
type: execute
wave: 2
depends_on: [25-01]
files_modified: [ecs/systems/equipment_system.py, services/party_service.py, game_states.py]
autonomous: true

must_haves:
  truths:
    - "EffectiveStats are recomputed every frame based on equipped gear."
    - "New players start with necessary equipment components."
  artifacts:
    - path: "ecs/systems/equipment_system.py"
      provides: "EquipmentSystem processor"
    - path: "services/party_service.py"
      provides: "Player initialization with Equipment/EffectiveStats"
  key_links:
    - from: "ecs/systems/equipment_system.py"
      to: "ecs/components.py"
      via: "reading Stats and Equipment"
    - from: "game_states.py"
      to: "ecs/systems/equipment_system.py"
      via: "adding processor"
---

<objective>
Implement the EquipmentSystem to dynamically calculate EffectiveStats and integrate it into the player creation and main game loop.

Purpose: Providing the automated engine that translates equipped items into stat bonuses.
Output: EquipmentSystem and updated player initialization.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-equipment-slots-combat-integration/25-01-SUMMARY.md
@ecs/components.py
@services/party_service.py
@game_states.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement EquipmentSystem</name>
  <files>ecs/systems/equipment_system.py</files>
  <action>
    Create ecs/systems/equipment_system.py:
    1. Iterate over entities with both Stats and Equipment.
    2. Sum base_ fields from Stats.
    3. Sum StatModifiers from all items in Equipment.slots (if entity exists and has StatModifiers).
    4. Update (or create) the EffectiveStats component on the entity with the results.
    5. Handle safety checks (item entity exists, has components).
  </action>
  <verify>Check logic for stat summation.</verify>
  <done>EquipmentSystem correctly sums stats from base and equipment.</done>
</task>

<task type="auto">
  <name>Task 2: Update Player Setup and Registration</name>
  <files>services/party_service.py, game_states.py</files>
  <action>
    1. Update PartyService.create_initial_party in services/party_service.py to include Equipment() and EffectiveStats(...) with base values.
    2. Update Game.startup in game_states.py to initialize and register EquipmentSystem (esper.add_processor).
    3. Ensure EquipmentSystem is added to the removal list in startup to avoid duplicates.
  </action>
  <verify>Start the game and check if the player entity has Equipment and EffectiveStats components.</verify>
  <done>Player has equipment components and system is running.</done>
</task>

</tasks>

<verification>
Ensure EquipmentSystem runs without error and player components are present.
</verification>

<success_criteria>
1. EquipmentSystem correctly calculates totals.
2. Player entity initialized with empty Equipment slots.
3. Player entity initialized with EffectiveStats mirroring base Stats.
4. EquipmentSystem registered in game loop.
</success_criteria>

<output>
After completion, create `.planning/phases/25-equipment-slots-combat-integration/25-02-SUMMARY.md`
</output>
