---
phase: 25-equipment-slots-combat-integration
plan: 03
type: execute
wave: 3
depends_on: [25-02]
files_modified: [services/equipment_service.py, game_states.py, ecs/systems/ui_system.py]
autonomous: true

must_haves:
  truths:
    - "Player can equip/unequip an item by pressing E in the inventory."
    - "Equipped items are marked with (E) in the inventory."
    - "Equipped items appear in the sidebar."
    - "Sidebar displays Effective Power and Defense."
  artifacts:
    - path: "services/equipment_service.py"
      provides: "equip_item, unequip_item functions"
    - path: "ecs/systems/ui_system.py"
      provides: "Sidebar equipment and stat display"
  key_links:
    - from: "game_states.py"
      to: "services/equipment_service.py"
      via: "InventoryState input handling"
---

<objective>
Implement the business logic for equipping and unequipping items and update the UI to display the player's current loadout and effective stats.

Purpose: Allowing user interaction with the equipment system and providing visual feedback.
Output: Equipment service and updated UI/Input handling.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-equipment-slots-combat-integration/25-02-SUMMARY.md
@services/equipment_service.py
@game_states.py
@ecs/systems/ui_system.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Equipment Service</name>
  <files>services/equipment_service.py</files>
  <action>
    Create services/equipment_service.py:
    1. equip_item(world, entity, item_id):
       - Check if item has Equippable component.
       - Identify slot from Equippable.
       - Get Equipment component from entity.
       - If Equipment.slots[slot] == item_id:
         - call unequip_item(world, entity, slot) (Toggle off).
       - Else:
         - If Equipment.slots[slot] is not None:
           - Get Name of old_item_id.
           - Log "You unequip the [old item]."
         - Set Equipment.slots[slot] = item_id (Toggle on/Replace).
         - Log "You equip the [item]."
    2. unequip_item(world, entity, slot):
       - Get Equipment component.
       - If Equipment.slots[slot] is not None:
         - item_id = Equipment.slots[slot]
         - Get Name of item_id.
         - Set Equipment.slots[slot] = None.
         - Log "You unequip the [item]."
    Note: Items remain in Inventory.items regardless of equipment status.
  </action>
  <verify>Check logic for toggling and slot assignment.</verify>
  <done>Service correctly handles equipping and unequipping without moving items out of inventory list.</done>
</task>

<task type="auto">
  <name>Task 2: Update Inventory UI and Input</name>
  <files>game_states.py</files>
  <action>
    1. Update InventoryState.get_event:
       - Handle K_e and K_RETURN: Call equipment_service.equip_item(self.world, self.player_entity, selected_item_id).
    2. Update InventoryState.drop_item:
       - Before dropping, check if item is equipped in any slot; if so, unequip it first.
    3. Update InventoryState.draw:
       - For each item, check if its ID is present in any slot of the player's Equipment component.
       - If equipped, append " (E)" to the displayed item name.
  </action>
  <verify>Run the game, open inventory, press E on an item, and check for the (E) tag.</verify>
  <done>Inventory supports equipping via E/Enter and shows equipped status.</done>
</task>

<task type="auto">
  <name>Task 3: Update Sidebar UI</name>
  <files>ecs/systems/ui_system.py</files>
  <action>
    Update UISystem.draw_sidebar:
    1. Add an "Equipment" section below Actions.
    2. List all SlotTypes and the name of the equipped item or "â€”".
    3. Add "Power" and "Defense" displays to the sidebar, fetching values from the EffectiveStats component (falling back to Stats if missing).
  </action>
  <verify>Check sidebar for equipment list and effective stats.</verify>
  <done>Sidebar shows loadout and effective combat stats.</done>
</task>

</tasks>

<verification>
Verify that equipping an item toggles the (E) tag in inventory and updates the sidebar.
</verification>

<success_criteria>
1. Items stay in inventory but are marked as equipped.
2. Pressing E on an equipped item unequips it.
3. Sidebar displays all slots and effective stats (Power/Defense).
</success_criteria>

<output>
After completion, create `.planning/phases/25-equipment-slots-combat-integration/25-03-SUMMARY.md`
</output>
