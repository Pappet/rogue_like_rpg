---
phase: 25-equipment-slots-combat-integration
plan: 03
type: execute
wave: 3
depends_on: [25-02]
files_modified: [services/equipment_service.py, game_states.py, ecs/systems/ui_system.py]
autonomous: true

must_haves:
  truths:
    - "Player can equip an item by pressing E in the inventory."
    - "Player can unequip an item by pressing U in the inventory."
    - "Equipped items appear in the sidebar."
  artifacts:
    - path: "services/equipment_service.py"
      provides: "equip_item, unequip_item functions"
    - path: "ecs/systems/ui_system.py"
      provides: "Sidebar equipment display"
  key_links:
    - from: "game_states.py"
      to: "services/equipment_service.py"
      via: "InventoryState input handling"
---

<objective>
Implement the business logic for equipping and unequipping items and update the UI to display the player's current loadout.

Purpose: Allowing user interaction with the equipment system and providing visual feedback.
Output: Equipment service and updated UI/Input handling.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-equipment-slots-combat-integration/25-02-SUMMARY.md
@services/equipment_service.py
@game_states.py
@ecs/systems/ui_system.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Equipment Service</name>
  <files>services/equipment_service.py</files>
  <action>
    Create services/equipment_service.py:
    1. equip_item(world, entity, item_id):
       - Check if item is Equippable.
       - Identify slot.
       - If slot occupied, move old item ID back to Inventory.items.
       - Remove item_id from Inventory.items.
       - Set Equipment.slots[slot] = item_id.
       - Log "You equip the [item]."
    2. unequip_item(world, entity, slot):
       - Move item ID from Equipment.slots[slot] to Inventory.items.
       - Set Equipment.slots[slot] = None.
       - Log "You unequip the [item]."
  </action>
  <verify>Check logic for displacement and list movements.</verify>
  <done>Service correctly handles item movements between inventory and slots.</done>
</task>

<task type="auto">
  <name>Task 2: Update UI and Input</name>
  <files>game_states.py, ecs/systems/ui_system.py</files>
  <action>
    1. Update InventoryState.get_event in game_states.py:
       - Handle K_e: call equip_item on selected item.
       - Handle K_u: call unequip_item (maybe show a list of slots or just unequip if an item is selected that is also equipped? No, just add unequip logic). 
       - [Correction]: Equip logic is simpler from inventory. For unequip, if an item is selected in inventory and it happens to be equipped, that's ambiguous. 
       - [Decision]: Pressing E on an equippable item in inventory equips it. Pressing U on an equippable item in inventory unequips it if it's currently in a slot.
    2. Update UISystem.draw_sidebar in ecs/systems/ui_system.py:
       - Add an "Equipment" section below Actions.
       - List all SlotTypes and the name of the equipped item or "â€”".
  </action>
  <verify>Run the game, open inventory, press E on an item, and check the sidebar.</verify>
  <done>UI shows equipment and input triggers equip/unequip.</done>
</task>

</tasks>

<verification>
Verify that equipping an item removes it from the inventory list and puts it in the sidebar slot.
</verification>

<success_criteria>
1. equip_item handles displacement correctly.
2. Sidebar displays all 6 slots.
3. Inventory supports E and U keys.
</success_criteria>

<output>
After completion, create `.planning/phases/25-equipment-slots-combat-integration/25-03-SUMMARY.md`
</output>
