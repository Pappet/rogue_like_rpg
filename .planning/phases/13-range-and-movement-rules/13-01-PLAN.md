---
phase: 13-range-and-movement-rules
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ecs/systems/action_system.py
  - tests/verify_range_movement.py
autonomous: true

must_haves:
  truths:
    - "Investigation cursor movement range is limited to the player's perception stat"
    - "The cursor can move to SHROUDED (previously seen) tiles as well as VISIBLE tiles"
    - "The cursor can move to FORGOTTEN tiles"
    - "The cursor cannot move onto UNEXPLORED tiles"
    - "Phase 13 scope is cursor MOVEMENT rules only — confirm_action() behavior on non-VISIBLE tiles is deferred to Phase 14"
  artifacts:
    - path: "ecs/systems/action_system.py"
      provides: "Perception-derived range override and expanded tile access"
      contains: "stats.perception"
    - path: "tests/verify_range_movement.py"
      provides: "Verification tests for Phase 13 success criteria"
      min_lines: 50
  key_links:
    - from: "ecs/systems/action_system.py:start_targeting"
      to: "Stats.perception"
      via: "targeting.range = stats.perception for inspect mode"
      pattern: "targeting\\.range\\s*=\\s*stats\\.perception"
    - from: "ecs/systems/action_system.py:move_cursor"
      to: "VisibilityState.UNEXPLORED"
      via: "!= UNEXPLORED check instead of == VISIBLE"
      pattern: "visibility_state\\s*!=\\s*VisibilityState\\.UNEXPLORED"
    - from: "ecs/systems/action_system.py:confirm_action"
      to: "Phase 14"
      via: "confirm_action() still gates on == VISIBLE — intentionally unchanged in Phase 13 (movement-only scope). Phase 14 will update confirm_action() to handle SHROUDED tile inspection output."
      pattern: "== VisibilityState\\.VISIBLE"
---

<objective>
Make the investigation cursor respect perception-derived range and allow movement over explored tiles while blocking unexplored tiles.

Purpose: Implements INV-02 (perception-based range) and TILE-03 (unexplored tiles blocked) — the movement rules for investigation mode.
Output: Modified `action_system.py` with two surgical changes + new test file.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-range-and-movement-rules/13-RESEARCH.md
@ecs/systems/action_system.py
@tests/verify_action_wiring.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Override targeting range with perception stat and expand tile access</name>
  <files>ecs/systems/action_system.py</files>
  <action>
Two changes to `ecs/systems/action_system.py`:

**Change 1 — Perception-derived range in `start_targeting()` (around line 65):**

After the `Targeting(...)` constructor call (line 57-65) and BEFORE the `if action.targeting_mode == "auto":` block (line 67), add:

```python
if action.targeting_mode == "inspect":
    targeting.range = stats.perception
```

This overrides the hardcoded `range=action.range` (which is 10 from the Action definition) with the player's live perception stat. The `stats` variable is already bound at line 50 (mana check). Do NOT change `Action(range=10)` in `party_service.py` — leave the static fallback as-is.

**Change 2 — Expanded tile access in `move_cursor()` (lines 134-144):**

Replace the visibility check from:
```python
is_visible = False
for layer in self.map_container.layers:
    if 0 <= new_y < len(layer.tiles) and 0 <= new_x < len(layer.tiles[new_y]):
        if layer.tiles[new_y][new_x].visibility_state == VisibilityState.VISIBLE:
            is_visible = True
            break

if is_visible:
```

With:
```python
is_accessible = False
for layer in self.map_container.layers:
    if 0 <= new_y < len(layer.tiles) and 0 <= new_x < len(layer.tiles[new_y]):
        if layer.tiles[new_y][new_x].visibility_state != VisibilityState.UNEXPLORED:
            is_accessible = True
            break

if is_accessible:
```

This allows cursor movement onto VISIBLE, SHROUDED, and FORGOTTEN tiles while blocking UNEXPLORED. The `!= UNEXPLORED` formulation is preferred over an explicit allowlist because the intent is "any tile the player has ever seen."

**Intentional non-change — `confirm_action()` left as-is (Phase 14 scope):**
Do NOT change `confirm_action()` (lines ~152-161). It currently gates on `== VisibilityState.VISIBLE`, meaning confirmation on SHROUDED/FORGOTTEN tiles returns False. This is intentional scoping: Phase 13 covers cursor MOVEMENT rules only. Phase 14 will update `confirm_action()` to produce inspection output for SHROUDED tiles. Changing it here would create untested behavior with no UI to display results.

Do NOT change `find_potential_targets()` or `cycle_targets()` — those are combat-only functions.
  </action>
  <verify>
Run existing Phase 12 tests to confirm no regression:
```
python -m pytest tests/verify_action_wiring.py -v
```
All 7 tests must pass. Visually inspect `action_system.py` to confirm:
1. `targeting.range = stats.perception` appears between Targeting constructor and auto-mode block
2. `!= VisibilityState.UNEXPLORED` appears in `move_cursor()`
3. `confirm_action()` is unchanged
  </verify>
  <done>
`start_targeting()` sets `targeting.range` to `stats.perception` when `targeting_mode == "inspect"`. `move_cursor()` allows movement to any tile whose visibility_state is not UNEXPLORED. `confirm_action()` remains unchanged (Phase 14 handoff). All 7 existing Phase 12 tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create verification tests for Phase 13 range and movement rules</name>
  <files>tests/verify_range_movement.py</files>
  <action>
Create `tests/verify_range_movement.py` following the pattern established in `tests/verify_action_wiring.py` (same imports, same `make_stats()`, `MockTurnSystem`, path setup).

Create a helper `make_map_with_visibility(width, height, visibility_map)` that builds a MapContainer where tiles have specific visibility states. `visibility_map` is a 2D list of `VisibilityState` values.

**Test 1: `test_inspect_targeting_range_equals_perception`**
- Create player at (5,5) with `perception=3` in Stats.
- Create a 12x12 map, all tiles VISIBLE.
- Start targeting with Investigate action (`targeting_mode="inspect"`, `range=10`).
- Verify `targeting.range == 3` (perception overrode the Action's range=10).

**Test 2: `test_combat_targeting_range_unchanged`**
- Create player at (2,2) with `perception=3` in Stats.
- Create 5x5 VISIBLE map.
- Start targeting with a combat action (`targeting_mode="auto"`, `range=5`).
- Verify `targeting.range == 5` (perception does NOT override combat range).

**Test 3: `test_cursor_moves_to_shrouded_tile`**
- Create player at (2,2). 5x5 map where tile (3,2) is SHROUDED, rest VISIBLE.
- Start inspect targeting. Call `move_cursor(entity, 1, 0)`.
- Assert `targeting.target_x == 3, targeting.target_y == 2` (cursor moved onto SHROUDED tile).

**Test 4: `test_cursor_moves_to_forgotten_tile`**
- Same as Test 3 but tile (3,2) is FORGOTTEN.
- Assert cursor moved successfully.

**Test 5: `test_cursor_blocked_on_unexplored_tile`**
- Create player at (2,2). 5x5 map where tile (3,2) is UNEXPLORED, rest VISIBLE.
- Start inspect targeting. Call `move_cursor(entity, 1, 0)`.
- Assert `targeting.target_x == 2, targeting.target_y == 2` (cursor did NOT move).

**Test 6: `test_cursor_blocked_beyond_perception_range`**
- Create player at (2,2) with `perception=2`. 8x8 VISIBLE map.
- Start inspect targeting. Move cursor right 3 times: `move_cursor(entity, 1, 0)` x3.
- After 2 moves: `target_x == 4` (within range 2). After 3rd move: `target_x == 4` still (blocked by range).

**Test 7: `test_existing_phase12_tests_unbroken`**
- Import and run a quick sanity check: create Investigate action, start targeting, verify it starts successfully. This is a lightweight regression guard — the full Phase 12 suite runs separately.

Each test must: `reset_world()` at the start, create its own entities and map, assert specific values.
  </action>
  <verify>
```
python -m pytest tests/verify_range_movement.py -v
python -m pytest tests/verify_action_wiring.py tests/verify_range_movement.py -v
```
All Phase 13 tests pass. All Phase 12 tests still pass. Zero failures.
  </verify>
  <done>
7 tests in `tests/verify_range_movement.py` all pass, covering: perception overrides range for inspect mode, combat range unchanged, cursor moves to SHROUDED and FORGOTTEN tiles, cursor blocked on UNEXPLORED, cursor blocked beyond perception range.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/verify_range_movement.py -v` — all 7 tests pass
2. `python -m pytest tests/verify_action_wiring.py -v` — all 7 Phase 12 tests still pass (regression)
3. `grep -n "stats.perception" ecs/systems/action_system.py` — confirms perception override is present
4. `grep -n "UNEXPLORED" ecs/systems/action_system.py` — confirms tile access check uses != UNEXPLORED
</verification>

<success_criteria>
- Investigation cursor range is derived from player's perception stat (INV-02)
- Cursor can move to VISIBLE, SHROUDED, and FORGOTTEN tiles
- Cursor cannot move onto UNEXPLORED tiles (TILE-03)
- Combat targeting range is NOT affected by perception (no regression)
- confirm_action() is unchanged (Phase 14 scope)
- All 14 tests pass (7 Phase 12 + 7 Phase 13)
</success_criteria>

<output>
After completion, create `.planning/phases/13-range-and-movement-rules/13-01-SUMMARY.md`
</output>
