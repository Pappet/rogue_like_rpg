---
phase: 32-sleep-behavior-and-village-population
plan: 02
type: execute
wave: 1
depends_on: ["32-01"]
files_modified: [
  "ecs/components.py",
  "entities/entity_registry.py",
  "entities/entity_factory.py",
  "services/resource_loader.py",
  "ecs/systems/schedule_system.py",
  "assets/data/entities.json",
  "assets/data/schedules.json",
  "tests/verify_home_positions.py"
]
autonomous: true

must_haves:
  truths:
    - "NPCs move towards their home_pos when a SLEEP activity starts"
    - "NPCs only enter AIState.SLEEP (dimmed visual, no movement) once they reach home_pos"
    - "Home positions can be defined per entity template in entities.json"
    - "Schedules can use target_meta: 'home' to reference an NPC's home_pos"
  artifacts:
    - path: "tests/verify_home_positions.py"
      provides: "Automated verification of the sleep-at-home logic"
  key_links:
    - from: "ecs/systems/schedule_system.py"
      to: "ecs/components.py"
      via: "Activity.home_pos"
---

<objective>
Implement Home Positions and Schedule Refinement. This ensures NPCs don't just fall asleep wherever they happen to be when the clock hits bedtime, but instead navigate to their designated home (or bed) before transitioning to the SLEEP state.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@ecs/components.py
@ecs/systems/schedule_system.py
@entities/entity_factory.py
@services/resource_loader.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Infrastructure Updates (ECS, Registry, Factory, Loader)</name>
  <files>
    <file>ecs/components.py</file>
    <file>entities/entity_registry.py</file>
    <file>entities/entity_factory.py</file>
    <file>services/resource_loader.py</file>
  </files>
  <action>
    Update the infrastructure to support home positions:
    1. In `ecs/components.py`: Add `home_pos: Optional[Tuple[int, int]] = None` to the `Activity` component.
    2. In `entities/entity_registry.py`: Add `home_pos: Optional[Tuple[int, int]] = None` to the `EntityTemplate` dataclass.
    3. In `services/resource_loader.py`: In `load_entities`, parse `home_pos` from the JSON (as a list `[x, y]` if present) and pass it to the `EntityTemplate`.
    4. In `entities/entity_factory.py`: In `create`, pass the `home_pos` from the template into the `Activity` component if it exists.
  </action>
  <verify>Check that code compiles and entity templates can be loaded with home_pos.</verify>
  <done>Home position data is correctly flowed from JSON to the ECS Activity component.</done>
</task>

<task type="auto">
  <name>Task 2: ScheduleSystem Refinement</name>
  <files>
    <file>ecs/systems/schedule_system.py</file>
  </files>
  <action>
    Refine `ScheduleSystem.process` to handle home positions and delayed sleep:
    1. Resolve `target_pos`: If `current_entry.target_meta == "home"`, use `activity.home_pos` as the destination. Otherwise, use `current_entry.target_pos`.
    2. State Transition Logic:
       - If the `current_entry.activity` is "SLEEP":
         - If the entity is at the resolved `target_pos` (or `target_pos` is None), set `ai_state.state = AIState.SLEEP`.
         - Otherwise (still traveling), set `ai_state.state = AIState.IDLE` to allow the NPC to move via `PathData` but not exhibit "awake" behaviors like WANDER.
       - For all other activities, continue using the current mapping from activity string to `AIState`.
    3. Update `activity.target_pos` and `PathData` if the resolved `target_pos` has changed.
  </action>
  <verify>Review the logic in ScheduleSystem.process to ensure it correctly identifies when an NPC has reached home.</verify>
  <done>NPCs only transition to SLEEP state when they reach their destination.</done>
</task>

<task type="auto">
  <name>Task 3: Data Updates and Verification</name>
  <files>
    <file>assets/data/entities.json</file>
    <file>assets/data/schedules.json</file>
    <file>tests/verify_home_positions.py</file>
  </files>
  <action>
    1. Update `assets/data/entities.json`: Add a `home_pos` (e.g., `[10, 10]`) to the `villager` template.
    2. Create `tests/verify_home_positions.py`:
       - Spawn a Villager at `[5, 5]` with a home at `[10, 10]`.
       - Set clock to a time where the Villager should SLEEP.
       - Run `ScheduleSystem` and verify activity becomes "SLEEP" but `AIState` remains `IDLE` (or not `SLEEP`) while they are not at `[10, 10]`.
       - Simulate turns and verify they move towards `[10, 10]`.
       - Verify that once they reach `[10, 10]`, `AIState` becomes `SLEEP`.
  </action>
  <verify>Run `python -m pytest tests/verify_home_positions.py -v`</verify>
  <done>Functional verification passes, confirming NPCs navigate to home before sleeping.</done>
</task>

</tasks>

<verification>
Run all AI and schedule related tests:
- `python -m pytest tests/verify_sleep_mechanics.py`
- `python -m pytest tests/verify_home_positions.py`
- `python -m pytest tests/verify_schedule_system.py`
</verification>

<success_criteria>
1. NPCs move towards their home_pos before sleeping.
2. NPCs only enter AIState.SLEEP when at home_pos.
3. Home positions can be defined in data files.
</success_criteria>

<output>
After completion, create `.planning/phases/32-sleep-behavior-and-village-population/32-02-SUMMARY.md`
</output>
