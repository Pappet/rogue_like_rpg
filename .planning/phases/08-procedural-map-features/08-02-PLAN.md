---
phase: 08-procedural-map-features
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - services/map_service.py
autonomous: true
must_haves:
  truths:
    - "The village scenario uses procedural generation for its houses."
    - "The village ground layer has random terrain variety (e.g. grass, flowers)."
  artifacts:
    - path: "services/map_service.py"
      provides: "Terrain variety logic and refactored scenario"
      contains: ["apply_terrain_variety", "create_village_scenario"]
---

<objective>
Refactor the village scenario to use the new procedural house generator and add terrain variety to the ground layer.

Purpose: Demonstrate the modular map generation system and enhance environmental detail.
Output: A more diverse and procedurally generated Village map.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-procedural-map-features/08-01-SUMMARY.md
@services/map_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Terrain Variety</name>
  <files>services/map_service.py</files>
  <action>
    Update `services/map_service.py`:
    1. Implement `apply_terrain_variety(self, layer, chance, sprite_choices)`:
       - Iterates over all tiles in the given `MapLayer`.
       - If `random.random() < chance`:
         - Pick a random sprite from `sprite_choices` (e.g., [',', '"', '*']).
         - Set the tile's sprite at SpriteLayer.GROUND to the chosen character.
         - Ensure the tile remains walkable/transparent (terrain detail usually is).
  </action>
  <verify>
    Create `tests/verify_terrain.py`:
    1. Create a MapLayer filled with '.'.
    2. Call `apply_terrain_variety` with 1.0 chance and some symbols.
    3. Assert that the layer no longer contains only '.'.
    Run `python3 tests/verify_terrain.py`.
  </verify>
  <done>
    - `apply_terrain_variety` is implemented in MapService.
    - Test confirms random sprite distribution.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor Village Scenario</name>
  <files>services/map_service.py</files>
  <action>
    Refactor `create_village_scenario` in `services/map_service.py`:
    1. Instead of hardcoded loops for one house, create 2-3 houses.
    2. For each house:
       - Create a new `MapContainer` for the interior (e.g. 2 floors).
       - Call `add_house_to_map` to populate it.
       - Register the map (e.g., "House 1", "House 2").
       - On the `Village` map:
         - Draw the exterior shell (walls) using `draw_rectangle`.
         - Place a Portal entity on the `Village` map leading to the `House` map's interior.
         - Place a Portal entity inside the `House` map leading back to the `Village` map.
    3. Call `apply_terrain_variety` on the Village ground layer (Layer 0).
       - Use a chance (e.g., 0.1) and a variety of nature sprites (e.g., [',', '"', '*']).
    4. Clean up the old hardcoded house generation code.
  </action>
  <verify>
    Run the game or use a test script to check:
    - Village map has 2-3 rectangular houses.
    - Ground has variety (dots, quotes, asterisks).
    - Entering a house leads to a generated interior.
    - Stairs work within the house.
  </verify>
  <done>
    - `create_village_scenario` uses `add_house_to_map` for all buildings.
    - Multiple houses exist and are navigable.
    - Terrain variety is applied to the world.
  </done>
</task>

</tasks>

<verification>
Run the existing tests and perform a visual check by running `main.py` if possible, or use a scripted check for map contents.
</verification>

<success_criteria>
- The village map contains multiple houses generated via the modular system.
- Environmental detail is increased via terrain variety.
- Navigability (portals/stairs) is maintained across all generated structures.
</success_criteria>

<output>
After completion, create `.planning/phases/08-procedural-map-features/08-02-SUMMARY.md`
</output>
