---
phase: 08-procedural-map-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - map/map_generator_utils.py
  - services/map_service.py
autonomous: true
must_haves:
  truths:
    - "A new map utility module exists for drawing shapes."
    - "MapService can generate a house structure with walls and stairs."
  artifacts:
    - path: "map/map_generator_utils.py"
      provides: "Map generation primitives"
      exports: ["draw_rectangle", "place_door"]
    - path: "services/map_service.py"
      provides: "House generation logic"
      contains: "add_house_to_map"
  key_links:
    - from: "services/map_service.py"
      to: "map/map_generator_utils.py"
      via: "import"
---

<objective>
Implement the foundational utilities for procedural map generation and the core house generation logic.
This plan focuses on creating the tools (utils) and the generator function, setting the stage for the full village refactor.

Purpose: Modularize map creation to allow dynamic generation of buildings.
Output: New utility module and updated MapService with house generation capability.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@services/map_service.py
@map/tile.py
@map/map_layer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Map Generator Utilities</name>
  <files>map/map_generator_utils.py</files>
  <action>
    Create `map/map_generator_utils.py`.
    Implement `draw_rectangle(layer, x, y, w, h, tile_type, filled=False)`:
      - Iterates through the specified bounds on the given `MapLayer`.
      - Sets the tile's sprite (SpriteLayer.GROUND) to `tile_type` (e.g., '#').
      - Updates `transparent` property: False if `tile_type` is '#', True otherwise (or based on a param).
      - If `filled` is False, only draw the border.
    Implement `place_door(layer, x, y)`:
      - Sets the tile at (x, y) to be walkable (e.g., sprite '.') and transparent.
      - Can optionally take a sprite char (default '+') if we want a visual closed door, but ensure it's handled correctly in `Tile.walkable` or usage. For now, following requirements: "Place portal/door", so visually distinct is good, but make sure it allows passage if it's open, or relying on Portal entity.
      - Let's make `place_door` set sprite to '.' (open floor) or '+' (door) and ensure transparency is True.
  </action>
  <verify>
    Create a test script `tests/verify_map_utils.py` that:
    1. Creates a dummy MapLayer.
    2. Calls `draw_rectangle` to make a room.
    3. Calls `place_door` to make an opening.
    4. Asserts tiles at specific coordinates have expected sprites and transparency.
    Run `python3 tests/verify_map_utils.py`.
  </verify>
  <done>
    - `map/map_generator_utils.py` exists with both functions.
    - Tests pass confirming shape drawing and door placement.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Building Generator in MapService</name>
  <files>services/map_service.py</files>
  <action>
    Update `services/map_service.py`:
    1. Import `draw_rectangle`, `place_door` from `map.map_generator_utils`.
    2. Add method `add_house_to_map(self, world, map_container, start_x, start_y, w, h, num_layers)`.
       - Note: Added `world` to signature to allow Portal creation.
    3. Implementation details:
       - Loop through `num_layers`.
       - For each layer, call `draw_rectangle` to create outer walls (using '#' and container layers).
       - Ensure floors (interior) are filled with '.' (ground) if they were empty/None? `draw_rectangle` might need to handle filling the interior with floor tiles if `filled=True` or a separate pass.
       - Logic: Draw filled rectangle with '.' first (floor), then Draw hollow rectangle with '#' (walls).
       - Place stairs:
         - If layer < num_layers - 1: Place "Stairs Up" Portal at a fixed relative position (e.g., `start_x + w - 2`, `start_y + h - 2`).
         - If layer > 0: Place "Stairs Down" Portal at the same X,Y on this layer.
       - Place door:
         - On layer 0, choose a wall spot (e.g., `start_x + w//2`, `start_y + h - 1` for bottom center).
         - Call `place_door` at that spot.
         - (Optional) Create a "Leave House" Portal entity if destination is known? The requirement "Place portal/door on ground floor" implies the entity. Since we don't know the exterior destination yet (context dependent), just place the *visual* door and maybe a placeholder Portal or leave the linking for the caller?
         - DECISION: `add_house_to_map` will create the internal stairs Portals. It will place the visual door. The *connection* to the outside (Portal out) is best handled by `create_village_scenario` which knows about the Village map coordinates. However, if the requirement implies a fully functional house... let's stick to: visual door + internal stairs.
  </action>
  <verify>
    Create `tests/verify_building_gen.py`:
    1. Instantiate `MapService` and a dummy `world` (can be mocked or minimal implementation).
    2. Create a `MapContainer` with 2 layers.
    3. Call `map_service.add_house_to_map(world, container, 0, 0, 10, 10, 2)`.
    4. Verify tiles: (0,0) is wall, (5,5) is floor.
    5. Verify entities: Check `world` for entities with `Portal` component (Stairs Up/Down).
    Run `python3 tests/verify_building_gen.py`.
  </verify>
  <done>
    - `add_house_to_map` is implemented and uses the utils.
    - House walls are drawn on all layers.
    - Stairs entities are created between floors.
    - Door is visually placed on ground floor.
  </done>
</task>

</tasks>

<verification>
Run `python3 tests/verify_map_utils.py` and `python3 tests/verify_building_gen.py`.
</verification>

<success_criteria>
- Utilities allow drawing rectangles and doors on MapLayers.
- MapService can populates a MapContainer with a house structure (walls, floors, stairs).
</success_criteria>

<output>
After completion, create `.planning/phases/08-procedural-map-features/08-01-SUMMARY.md`
</output>
