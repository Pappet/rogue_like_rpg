---
phase: 11-investigation-preparation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - ecs/components.py
  - entities/entity_registry.py
  - services/resource_loader.py
  - entities/entity_factory.py
  - assets/data/entities.json
  - tests/verify_description.py
autonomous: true

must_haves:
  truths:
    - "Healthy orc returns base description text 'A generic orc'"
    - "Wounded orc (hp/max_hp <= 0.5) returns wounded description text 'A wounded orc'"
    - "Entity at exact threshold boundary returns wounded text"
    - "Entity with max_hp=0 returns base text without division error"
    - "Entity without description field in JSON has no Description component"
    - "Orc spawned via EntityFactory has Description component attached"
  artifacts:
    - path: "ecs/components.py"
      provides: "Description dataclass with get(stats) method"
      contains: "class Description"
    - path: "entities/entity_registry.py"
      provides: "EntityTemplate with description, wounded_text, wounded_threshold fields"
      contains: "description"
    - path: "services/resource_loader.py"
      provides: "Parsing of optional description fields from JSON"
      contains: "wounded_text"
    - path: "entities/entity_factory.py"
      provides: "Conditional Description component attachment"
      contains: "Description("
    - path: "assets/data/entities.json"
      provides: "Orc entry with description fields"
      contains: "wounded orc"
    - path: "tests/verify_description.py"
      provides: "Verification tests for Description component"
      min_lines: 50
  key_links:
    - from: "assets/data/entities.json"
      to: "entities/entity_registry.py"
      via: "ResourceLoader.load_entities() parses description fields into EntityTemplate"
      pattern: "description.*item\\.get"
    - from: "entities/entity_registry.py"
      to: "entities/entity_factory.py"
      via: "Factory reads template.description to decide component attachment"
      pattern: "if template\\.description"
    - from: "entities/entity_factory.py"
      to: "ecs/components.py"
      via: "Factory creates Description(base=, wounded_text=, wounded_threshold=)"
      pattern: "Description\\("
---

<objective>
Implement the Description ECS component with dynamic context-aware text (MECH-006).

Purpose: Enable entities to express state-dependent descriptions (e.g., "A generic orc" when healthy, "A wounded orc" when HP is low). This is the only new work for Phase 11 -- criteria 1-3 are already complete from phases 9-10.

Output: Description component, pipeline integration (template -> loader -> factory), updated orc JSON, passing TDD tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-investigation-preparation/11-RESEARCH.md
@ecs/components.py
@entities/entity_registry.py
@entities/entity_factory.py
@services/resource_loader.py
@assets/data/entities.json
@tests/verify_entity_factory.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED -- Write failing tests for Description component</name>
  <files>tests/verify_description.py, ecs/components.py</files>
  <action>
Create tests/verify_description.py following the pattern in tests/verify_entity_factory.py (sys.path insert, setup_registries helper, pytest).

Write these test cases:

1. test_description_get_returns_base_when_healthy: Create Description(base="A generic orc", wounded_text="A wounded orc", wounded_threshold=0.5). Create Stats(hp=10, max_hp=10, power=3, defense=0, mana=0, max_mana=0, perception=5, intelligence=5). Assert desc.get(stats) == "A generic orc".

2. test_description_get_returns_wounded_when_hp_low: Same Description. Stats with hp=4, max_hp=10 (40%, below 50% threshold). Assert desc.get(stats) == "A wounded orc".

3. test_description_get_at_exact_threshold: Same Description. Stats with hp=5, max_hp=10 (exactly 50%). Assert desc.get(stats) == "A wounded orc" (at-or-below threshold triggers wounded).

4. test_description_get_no_division_by_zero: Description with wounded_text set. Stats with hp=0, max_hp=0. Assert desc.get(stats) == "A generic orc" (base returned, no crash).

5. test_description_get_no_wounded_text: Description(base="A rock", wounded_text="", wounded_threshold=0.5). Stats with hp=1, max_hp=10. Assert desc.get(stats) == "A rock" (no wounded_text means always base).

6. test_orc_entity_has_description_component: Use setup_registries() + EntityFactory.create(world, "orc", 0, 0). Assert world.has_component(entity_id, Description). Get the Description component and assert desc.base == "A generic orc" and desc.wounded_text == "A wounded orc".

7. test_description_not_attached_without_field: This test verifies that an entity template with no description field does NOT get a Description component. Create a minimal EntityTemplate manually with description="" and register it. Create entity via factory. Assert NOT world.has_component(entity_id, Description). (This test can be deferred to GREEN phase if it requires factory changes to set up.)

After writing the test file, add a minimal stub to ecs/components.py so imports resolve but tests fail:

```python
@dataclass
class Description:
    base: str
    wounded_text: str = ""
    wounded_threshold: float = 0.5

    def get(self, stats) -> str:
        raise NotImplementedError("RED phase stub")
```

Run: python -m pytest tests/verify_description.py -v
Verify: Tests 1-5 FAIL (NotImplementedError). Test 6-7 FAIL (no pipeline yet).
Commit: test(11-01): add failing tests for Description component
  </action>
  <verify>python -m pytest tests/verify_description.py -v shows all tests FAILING (RED). Import succeeds (no ModuleNotFoundError).</verify>
  <done>All 6-7 test cases exist, properly import Description, and fail with expected errors.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN -- Implement Description component and pipeline integration</name>
  <files>ecs/components.py, entities/entity_registry.py, services/resource_loader.py, entities/entity_factory.py, assets/data/entities.json</files>
  <action>
1. ecs/components.py: Replace the NotImplementedError stub with the real get() method:
```python
@dataclass
class Description:
    base: str
    wounded_text: str = ""
    wounded_threshold: float = 0.5

    def get(self, stats) -> str:
        if self.wounded_text and stats.max_hp > 0:
            if stats.hp / stats.max_hp <= self.wounded_threshold:
                return self.wounded_text
        return self.base
```

2. entities/entity_registry.py: Add three optional fields to EntityTemplate after the existing blocker field:
```python
    description: str = ""
    wounded_text: str = ""
    wounded_threshold: float = 0.5
```

3. services/resource_loader.py: In load_entities(), after parsing ai and blocker, add:
```python
    description = item.get("description", "")
    wounded_text = item.get("wounded_text", "")
    wounded_threshold = float(item.get("wounded_threshold", 0.5))
```
Pass these three fields to the EntityTemplate constructor.

4. entities/entity_factory.py: Import Description from ecs.components. After the `if template.ai:` block, add:
```python
    if template.description:
        components.append(
            Description(
                base=template.description,
                wounded_text=template.wounded_text,
                wounded_threshold=template.wounded_threshold,
            )
        )
```

5. assets/data/entities.json: Add to the orc entry:
```json
    "description": "A generic orc",
    "wounded_text": "A wounded orc",
    "wounded_threshold": 0.5
```

Run: python -m pytest tests/verify_description.py tests/verify_entity_factory.py tests/verify_prefab_loading.py -v
Verify: ALL tests pass (GREEN). No regressions in existing tests.
Commit: feat(11-01): implement Description component with dynamic text (MECH-006)
  </action>
  <verify>python -m pytest tests/ -v shows ALL tests passing (Description tests + all prior tests). Zero failures, zero errors.</verify>
  <done>Description.get(stats) returns correct text for healthy, wounded, threshold boundary, and zero-max-hp cases. Orc entity created via EntityFactory has Description component with correct values. All prior tests still pass.</done>
</task>

</tasks>

<verification>
Run full test suite: python -m pytest tests/ -v
Expected: All tests pass including:
- tests/verify_description.py (6-7 tests)
- tests/verify_entity_factory.py (4 tests)
- tests/verify_prefab_loading.py (5 tests)

Manual spot check: Import Description in a Python shell, create instance, call get() with mock stats.
</verification>

<success_criteria>
1. Description component exists in ecs/components.py as a dataclass with get(stats) method.
2. Healthy entity (hp/max_hp > threshold) returns base text.
3. Wounded entity (hp/max_hp <= threshold) returns wounded_text.
4. Division-by-zero guarded when max_hp == 0.
5. EntityFactory attaches Description only when template.description is non-empty.
6. Orc in entities.json has description, wounded_text, and wounded_threshold fields.
7. All tests pass with zero regressions.
</success_criteria>

<output>
After completion, create `.planning/phases/11-investigation-preparation/11-01-SUMMARY.md`
</output>
