---
phase: 12-action-wiring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/party_service.py
  - ecs/components.py
  - ecs/systems/action_system.py
  - ecs/systems/render_system.py
  - ecs/systems/ui_system.py
  - tests/verify_action_wiring.py
autonomous: true

must_haves:
  truths:
    - "Player selects Investigate from action list and a cyan cursor appears on the map at player position"
    - "Arrow keys move the cursor while game remains in targeting mode (enemy turns do not fire)"
    - "Pressing Escape cancels investigation and returns to normal play with no turn consumed"
    - "Header text reads 'Investigating...' when investigation targeting is active"
    - "Investigation cursor is cyan; combat targeting cursor remains yellow"
  artifacts:
    - path: "services/party_service.py"
      provides: "Investigate Action with requires_targeting=True, targeting_mode='inspect', range=10"
      contains: "targeting_mode=\"inspect\""
    - path: "ecs/components.py"
      provides: "Description.get() accepts stats=None without crash"
      contains: "def get(self, stats=None)"
    - path: "ecs/systems/action_system.py"
      provides: "confirm_action skips end_player_turn for inspect mode"
      contains: "inspect"
    - path: "ecs/systems/render_system.py"
      provides: "Cyan cursor for inspect mode, yellow for combat"
      contains: "0, 255, 255"
    - path: "ecs/systems/ui_system.py"
      provides: "Header shows 'Investigating...' for inspect mode"
      contains: "Investigating..."
    - path: "tests/verify_action_wiring.py"
      provides: "Phase 12 verification tests"
  key_links:
    - from: "services/party_service.py"
      to: "ecs/systems/action_system.py"
      via: "Action.targeting_mode='inspect' flows into Targeting.mode via start_targeting()"
      pattern: "targeting_mode=\"inspect\""
    - from: "ecs/systems/action_system.py"
      to: "turn_system.end_player_turn"
      via: "confirm_action skips end_player_turn when mode is inspect"
      pattern: "mode != \"inspect\""
    - from: "ecs/systems/render_system.py"
      to: "Targeting.mode"
      via: "draw_targeting_ui reads mode for color selection"
      pattern: "targeting\\.mode.*inspect"
    - from: "ecs/systems/ui_system.py"
      to: "Targeting.mode"
      via: "draw_header reads Targeting component mode for header text"
      pattern: "targeting\\.mode.*inspect"
---

<objective>
Wire the Investigate action through the existing targeting system so the player can activate, navigate, and cancel an investigation cursor with distinct visual feedback.

Purpose: Enable the core investigation interaction loop (activate/move/cancel) that Phase 13 and 14 build upon.
Output: Five modified source files and one new test file verifying all Phase 12 success criteria.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-action-wiring/12-RESEARCH.md
@services/party_service.py
@ecs/components.py
@ecs/systems/action_system.py
@ecs/systems/render_system.py
@ecs/systems/ui_system.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire Investigate action through targeting system</name>
  <files>
    services/party_service.py
    ecs/components.py
    ecs/systems/action_system.py
    ecs/systems/render_system.py
    ecs/systems/ui_system.py
  </files>
  <action>
Five surgical edits to existing files. No new files, no new imports, no new components.

1. **services/party_service.py line 21** — Update the Investigate Action definition:
   Change `Action(name="Investigate")` to `Action(name="Investigate", range=10, requires_targeting=True, targeting_mode="inspect")`.
   This makes selecting Investigate enter targeting mode with inspect mode and range 10 (INV-01). Phase 13 will make range dynamic from perception stat.

2. **ecs/components.py line 104** — Guard Description.get() against stats=None:
   Change the method signature from `def get(self, stats) -> str:` to `def get(self, stats=None) -> str:`.
   Add a guard: `if stats is not None and self.wounded_text and stats.max_hp > 0:` (replacing the current `if self.wounded_text and stats.max_hp > 0:`).
   This prevents crashes when inspecting portals/corpses that lack a Stats component (needed for Phase 14, but guard placed now per project decision).

3. **ecs/systems/action_system.py lines 148-178** — In confirm_action(), skip end_player_turn for inspect mode (INV-03):
   BEFORE calling `self.cancel_targeting(entity)` on line 176, capture the mode: `mode = targeting.action.targeting_mode`.
   IMPORTANT: Read targeting_mode BEFORE cancel_targeting() because cancel_targeting() removes the Targeting component.
   After `self.cancel_targeting(entity)` (line 176), change the unconditional `self.turn_system.end_player_turn()` (line 177) to:
   ```python
   if mode != "inspect":
       self.turn_system.end_player_turn()
   ```
   This makes investigation a free action — pressing Enter during investigation returns to play without consuming a turn.

4. **ecs/systems/render_system.py lines 84-121** — In draw_targeting_ui(), parameterize cursor colors by mode (UI-03):
   At the top of draw_targeting_ui(), add color selection:
   ```python
   if targeting.mode == "inspect":
       range_color = (0, 255, 255, 50)
       cursor_color = (0, 255, 255)
   else:
       range_color = (255, 255, 0, 50)
       cursor_color = (255, 255, 0)
   ```
   Replace the hardcoded `(255, 255, 0, 50)` on line 109 with `range_color`.
   Replace the hardcoded `(255, 255, 0)` on line 121 with `cursor_color`.
   Combat targeting stays yellow; investigation targeting becomes cyan.

5. **ecs/systems/ui_system.py lines 44-46** — In draw_header(), show "Investigating..." for inspect mode (UI-02):
   Replace the TARGETING branch:
   ```python
   elif self.turn_system.current_state == GameStates.TARGETING:
       turn_str = "Targeting..."
       turn_color = (100, 255, 255)
   ```
   With mode-aware version:
   ```python
   elif self.turn_system.current_state == GameStates.TARGETING:
       try:
           targeting = esper.component_for_entity(self.player_entity, Targeting)
           if targeting.mode == "inspect":
               turn_str = "Investigating..."
           else:
               turn_str = "Targeting..."
       except KeyError:
           turn_str = "Targeting..."
       turn_color = (100, 255, 255)
   ```
   The Targeting import already exists on line 4 of ui_system.py — no new import needed.

Anti-patterns to avoid:
- Do NOT add a new GameStates.INSPECTING — reuse TARGETING with mode="inspect" per locked decision.
- Do NOT render description panel in RenderSystem — that belongs to UISystem per locked decision.
- Do NOT read targeting.action.targeting_mode AFTER calling cancel_targeting() — the component is removed.
  </action>
  <verify>
    Run `python -c "from services.party_service import PartyService; from ecs.components import Action; a = Action(name='Investigate', range=10, requires_targeting=True, targeting_mode='inspect'); print('Action OK:', a.requires_targeting, a.targeting_mode)"` to verify Action definition compiles.
    Run `python -c "from ecs.components import Description; d = Description(base='test'); print(d.get()); print(d.get(None))"` to verify Description.get(stats=None) does not crash.
    Run `python -c "import ast; ast.parse(open('ecs/systems/action_system.py').read()); ast.parse(open('ecs/systems/render_system.py').read()); ast.parse(open('ecs/systems/ui_system.py').read()); print('All files parse OK')"` to verify no syntax errors.
  </verify>
  <done>
    All five files modified with no syntax errors. Investigate Action has requires_targeting=True and targeting_mode="inspect". Description.get(None) returns base text without crash. confirm_action() skips end_player_turn for inspect mode. draw_targeting_ui() uses cyan for inspect, yellow for combat. draw_header() shows "Investigating..." for inspect mode.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create verification tests for Phase 12 wiring</name>
  <files>
    tests/verify_action_wiring.py
  </files>
  <action>
Create `tests/verify_action_wiring.py` following the established pattern from `tests/verify_description.py`.

Tests to implement (7 tests covering all 5 success criteria and both requirements):

1. **test_investigate_action_requires_targeting** — Import PartyService, create party, get ActionList, find the Investigate action, assert `requires_targeting is True` and `targeting_mode == "inspect"` and `range == 10`. Covers INV-01 / success criterion 1.

2. **test_investigate_action_cost_is_zero** — Same setup, assert Investigate action has `cost_mana == 0`. Ensures mana check in start_targeting() never blocks entry.

3. **test_description_get_accepts_none_stats** — Create a Description component, call `desc.get(None)`, assert it returns base text without raising. Create another with wounded_text, call `desc.get(None)`, assert base text returned. Covers the stats=None guard.

4. **test_description_get_still_works_with_stats** — Verify existing behavior is not broken: create Description with wounded_text, call get() with healthy Stats (returns base) and wounded Stats (returns wounded_text). Regression guard.

5. **test_confirm_action_skips_end_turn_for_inspect** — Unit test using esper directly:
   - `reset_world()` / `get_world()`
   - Create a player entity with Position, Stats, ActionList
   - Create a mock TurnSystem (or use the real one) that tracks whether end_player_turn was called
   - Create a mock map_container with a minimal tile grid where the target tile is visible
   - Instantiate ActionSystem with the mock map and turn system
   - Call `start_targeting(entity, investigate_action)` where investigate_action has targeting_mode="inspect"
   - Call `confirm_action(entity)`
   - Assert turn system's end_player_turn was NOT called
   - Covers INV-03 / success criterion 3.

6. **test_confirm_action_calls_end_turn_for_combat** — Same setup but with targeting_mode="auto" (combat action). Assert end_player_turn WAS called. Regression guard ensuring combat still consumes turns.

7. **test_render_system_cursor_colors** — Test that draw_targeting_ui selects correct colors:
   - Create a Targeting component with mode="inspect", verify the color selection logic produces cyan (0, 255, 255).
   - Create a Targeting component with mode="auto", verify yellow (255, 255, 0).
   - This can be a simple logic test by extracting the color selection into a helper or by checking the targeting.mode branching directly.

Use the sys.path pattern from verify_description.py (line 20). Use `from ecs.world import get_world, reset_world` for test isolation. Each test function should be independent (no shared mutable state between tests).

Run instructions in docstring: `python -m pytest tests/verify_action_wiring.py -v`
  </action>
  <verify>
    Run `python -m pytest tests/verify_action_wiring.py -v` — all tests must pass.
    Run `python -m pytest tests/verify_description.py -v` — existing tests must still pass (regression check).
  </verify>
  <done>
    All 7 tests in verify_action_wiring.py pass. All 7 tests in verify_description.py still pass. No regressions.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/verify_action_wiring.py tests/verify_description.py -v` — all 14 tests pass.
2. Manual smoke test (optional): Run the game, select Investigate from the action list with Enter. Verify cyan cursor appears. Move with arrow keys. Press Escape — returns to play, round counter unchanged. Select a combat action (Ranged) — verify yellow cursor and "Targeting..." header.
</verification>

<success_criteria>
- Investigate action enters targeting mode with cyan cursor at player position (SC-1, INV-01, UI-03)
- Arrow keys move cursor in targeting mode without triggering enemy turns (SC-2)
- Escape cancels investigation, returns to PLAYER_TURN, no turn consumed (SC-3, INV-04)
- Header reads "Investigating..." during inspect targeting (SC-4, UI-02)
- Combat targeting cursor remains yellow with "Targeting..." header (SC-5, regression)
- All automated tests pass with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/12-action-wiring/12-01-SUMMARY.md`
</output>
