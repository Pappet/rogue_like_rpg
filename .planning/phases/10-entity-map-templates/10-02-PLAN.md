---
phase: 10-entity-map-templates
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - assets/data/prefabs/cottage_interior.json
  - services/map_service.py
  - tests/verify_prefab_loading.py
autonomous: true

must_haves:
  truths:
    - "A map structure (house interior) can be loaded from an external JSON prefab file"
    - "Prefab stamping uses tile.set_type() to mutate existing tiles, preserving visibility state"
    - "Entity spawn points defined in prefab JSON are created via EntityFactory"
  artifacts:
    - path: "assets/data/prefabs/cottage_interior.json"
      provides: "At least one complete prefab file with tile grid and optional entity spawns"
      contains: '"tiles"'
    - path: "services/map_service.py"
      provides: "load_prefab() method on MapService"
      contains: "def load_prefab"
    - path: "tests/verify_prefab_loading.py"
      provides: "Verification tests for prefab loading and tile stamping"
  key_links:
    - from: "services/map_service.py"
      to: "assets/data/prefabs/"
      via: "load_prefab() reads JSON file and stamps tiles onto MapLayer"
      pattern: "set_type\\(type_id\\)"
    - from: "services/map_service.py"
      to: "entities/entity_factory.py"
      via: "load_prefab() spawns entities from prefab spawn list using EntityFactory.create()"
      pattern: "EntityFactory\\.create"
---

<objective>
Implement the map prefab loading system: JSON prefab file format, a loader method on MapService, and at least one sample prefab file. Prefabs define a 2D tile grid plus optional entity spawn points.

Purpose: Moves map structure definitions from hardcoded Python into external JSON files, enabling map designers to create and edit rooms without modifying Python code.
Output: Working MapService.load_prefab() that stamps tiles from JSON onto existing MapLayers, with optional entity spawning.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-entity-map-templates/10-RESEARCH.md
@.planning/phases/10-entity-map-templates/10-01-SUMMARY.md
@services/map_service.py
@map/map_generator_utils.py
@entities/entity_factory.py
@entities/entity_registry.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create prefab JSON file and implement MapService.load_prefab()</name>
  <files>
    assets/data/prefabs/cottage_interior.json
    services/map_service.py
  </files>
  <action>
1. Create directory `assets/data/prefabs/` and add `cottage_interior.json`:
   - A JSON object with keys: `"id"`, `"width"`, `"height"`, `"tiles"` (2D array of type_id strings), and optional `"entities"` (array of spawn objects).
   - The tile grid should define a small room (e.g. 8x6) with `wall_stone` border, `floor_stone` interior, and a `door_stone` entry.
   - Include at least one entity spawn: `{"template_id": "orc", "x": 3, "y": 3}`.
   - Example structure:
     ```json
     {
       "id": "cottage_interior",
       "width": 8,
       "height": 6,
       "tiles": [
         ["wall_stone", "wall_stone", "wall_stone", "wall_stone", "wall_stone", "wall_stone", "wall_stone", "wall_stone"],
         ["wall_stone", "floor_stone", "floor_stone", "floor_stone", "floor_stone", "floor_stone", "floor_stone", "wall_stone"],
         ["wall_stone", "floor_stone", "floor_stone", "floor_stone", "floor_stone", "floor_stone", "floor_stone", "wall_stone"],
         ["wall_stone", "floor_stone", "floor_stone", "floor_stone", "floor_stone", "floor_stone", "floor_stone", "wall_stone"],
         ["wall_stone", "floor_stone", "floor_stone", "floor_stone", "floor_stone", "floor_stone", "floor_stone", "wall_stone"],
         ["wall_stone", "wall_stone", "wall_stone", "door_stone", "wall_stone", "wall_stone", "wall_stone", "wall_stone"]
       ],
       "entities": [
         {"template_id": "orc", "x": 3, "y": 3}
       ]
     }
     ```

2. Add `load_prefab()` method to `MapService` in `services/map_service.py`:
   ```python
   def load_prefab(self, world, layer: MapLayer, filepath: str, ox: int = 0, oy: int = 0) -> None:
   ```
   - Import `json` and `os` at the top of the file (or inside the method).
   - Import `EntityFactory` from `entities.entity_factory`.
   - Raise `FileNotFoundError` if filepath doesn't exist.
   - Parse JSON. Extract `"tiles"` key (2D array of type_id strings).
   - Iterate over rows and columns: for each `type_id`, compute `tx = ox + col_idx`, `ty = oy + row_idx`. If within layer bounds (`0 <= ty < layer.height and 0 <= tx < layer.width`), call `layer.tiles[ty][tx].set_type(type_id)`.
   - CRITICAL: Use `set_type()` — do NOT create new `Tile` objects. This preserves per-instance visibility state.
   - Iterate over `"entities"` array (if present): for each spawn, call `EntityFactory.create(world, spawn["template_id"], ox + spawn["x"], oy + spawn["y"])`.
   - Do NOT modify `add_house_to_map()` or `create_village_scenario()` in this plan — those use the existing procedural approach and will be migrated incrementally in future phases.
  </action>
  <verify>
Run `python -c "import json; data = json.load(open('assets/data/prefabs/cottage_interior.json')); print(data['id'], len(data['tiles']), len(data['tiles'][0]))"` — should print "cottage_interior 6 8". Then verify method exists: `python -c "from services.map_service import MapService; ms = MapService(); assert hasattr(ms, 'load_prefab'), 'load_prefab not found'"`.
  </verify>
  <done>Prefab JSON file exists with valid tile grid and entity spawns. MapService.load_prefab() reads the file, stamps tiles via set_type(), and spawns entities via EntityFactory.</done>
</task>

<task type="auto">
  <name>Task 2: Add verification tests for prefab loading</name>
  <files>
    tests/verify_prefab_loading.py
  </files>
  <action>
Create `tests/verify_prefab_loading.py` with the following test cases. Each test must begin with `TileRegistry.clear()` + `EntityRegistry.clear()` + `ResourceLoader.load_tiles("assets/data/tile_types.json")` + `ResourceLoader.load_entities("assets/data/entities.json")` for isolation.

1. **test_load_prefab_stamps_tiles**: Create a 10x10 MapLayer filled with `floor_stone` tiles. Call `map_service.load_prefab(world, layer, "assets/data/prefabs/cottage_interior.json", ox=1, oy=1)`. Assert that `layer.tiles[1][1]` (offset 0,0 of prefab) has type matching `wall_stone` (check `tile.walkable == False`). Assert `layer.tiles[2][2]` (interior) has type matching `floor_stone` (check `tile.walkable == True`). Assert tiles outside the prefab area (e.g. `layer.tiles[0][0]`) are unchanged.

2. **test_load_prefab_preserves_visibility**: Create a 10x10 MapLayer. Set `layer.tiles[2][2].visibility_state = VisibilityState.VISIBLE`. Call `load_prefab()` with offset (0,0) so the prefab covers tile (2,2). After stamping, assert `layer.tiles[2][2].visibility_state == VisibilityState.VISIBLE` — proving set_type() was used, not Tile construction.

3. **test_load_prefab_spawns_entities**: Create a 10x10 MapLayer and a fresh esper world. Call `load_prefab()` with the cottage prefab (which has an orc spawn at x=3, y=3) at offset (0,0). Query the world for entities with `Position` and `Name` components. Assert at least one entity exists with `Name.name == "Orc"` and `Position.x == 3, Position.y == 3`.

4. **test_load_prefab_with_offset**: Call `load_prefab()` at offset (5, 5). Assert tiles at (5,5) are wall_stone and entities spawn at (5+3, 5+3) = (8, 8).

5. **test_load_prefab_file_not_found**: Assert `load_prefab(world, layer, "nonexistent.json")` raises `FileNotFoundError`.

Use the same testing patterns as other files in `tests/` (check `tests/verify_resource_loader.py` or `tests/verify_tile_refactor.py` for conventions — likely using `pytest` with plain functions or a simple class).
  </action>
  <verify>
Run `python -m pytest tests/verify_prefab_loading.py -v` — all 5 tests pass. Run `python -m pytest tests/ -v` to confirm no regressions.
  </verify>
  <done>All prefab loading tests pass. Tile stamping uses set_type() preserving visibility. Entity spawns work through EntityFactory. File-not-found error handling verified.</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/verify_prefab_loading.py -v` — all 5 tests pass.
2. `python -m pytest tests/ -v` — no regressions across all test files.
3. `assets/data/prefabs/cottage_interior.json` exists and is valid JSON.
4. `MapService.load_prefab()` correctly stamps tiles and spawns entities.
</verification>

<success_criteria>
- At least one prefab JSON file exists in assets/data/prefabs/
- MapService.load_prefab() reads prefab JSON and stamps tiles onto MapLayer via set_type()
- Entity spawn points in prefab are created via EntityFactory.create()
- Tile visibility state is preserved during prefab stamping
- All tests pass with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/10-entity-map-templates/10-02-SUMMARY.md`
</output>
