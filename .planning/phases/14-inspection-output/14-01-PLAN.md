---
phase: 14-inspection-output
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ecs/systems/action_system.py
  - tests/verify_inspection_output.py
autonomous: true

must_haves:
  truths:
    - "Confirming investigation on a VISIBLE tile prints the tile name (yellow) and base description in the message log"
    - "Confirming investigation on a SHROUDED tile prints only the tile name (no entities, no tile description)"
    - "All entities at the investigated position are listed in the message log"
    - "An entity below its HP wound threshold shows wounded flavor text instead of base description"
    - "Entities without a Stats component (portals, corpses) produce a description without crashing"
    - "The player entity is excluded from their own inspection output"
  artifacts:
    - path: "ecs/systems/action_system.py"
      provides: "Mode-aware visibility gate and inspection output dispatch in confirm_action()"
      contains: "dispatch_event.*log_message"
    - path: "tests/verify_inspection_output.py"
      provides: "Verification tests for all 5 success criteria"
      min_lines: 100
  key_links:
    - from: "ecs/systems/action_system.py"
      to: "map/tile_registry.py"
      via: "TileRegistry.get(tile._type_id) for tile name and description"
      pattern: "TileRegistry\\.get"
    - from: "ecs/systems/action_system.py"
      to: "ecs/components.py"
      via: "Description.get(stats) for HP-aware entity descriptions"
      pattern: "desc\\.get\\(stats\\)|desc_comp\\.get\\(stats\\)"
    - from: "ecs/systems/action_system.py"
      to: "esper dispatch"
      via: "esper.dispatch_event('log_message', ...) for message log output"
      pattern: "dispatch_event.*log_message"
---

<objective>
Wire inspection output in confirm_action() so that confirming investigation dispatches formatted tile and entity descriptions to the message log, with VISIBLE tiles showing full info and SHROUDED tiles showing tile name only.

Purpose: Complete the v1.1 Investigation System — the player can now inspect tiles and see meaningful, colored information about what they're looking at.
Output: Updated confirm_action() with inspection output logic, plus verification tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-inspection-output/14-RESEARCH.md
@ecs/systems/action_system.py
@ecs/components.py
@map/tile_registry.py
@map/tile.py
@tests/verify_range_movement.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement inspection output in confirm_action()</name>
  <files>ecs/systems/action_system.py</files>
  <action>
Modify `confirm_action()` in `ActionSystem` (lines 151-185) with two changes:

**Change 1 — Mode-aware visibility gate (replace lines 155-164):**

Replace the `is_visible` boolean check with a `tile_visibility` variable that captures the actual VisibilityState. The gate logic becomes:
- For inspect mode (`targeting.action.targeting_mode == "inspect"`): allow VISIBLE and SHROUDED (reject only UNEXPLORED).
- For all other modes: keep existing behavior (reject anything that is not VISIBLE).

Also capture the actual `tile` object from the layer for later use in output.

```python
tile_visibility = VisibilityState.UNEXPLORED
target_tile = None
for layer in self.map_container.layers:
    if 0 <= targeting.target_y < len(layer.tiles) and 0 <= targeting.target_x < len(layer.tiles[targeting.target_y]):
        t = layer.tiles[targeting.target_y][targeting.target_x]
        if t.visibility_state != VisibilityState.UNEXPLORED:
            target_tile = t
            tile_visibility = t.visibility_state
            break

if targeting.action.targeting_mode == "inspect":
    if tile_visibility == VisibilityState.UNEXPLORED:
        return False
else:
    if tile_visibility != VisibilityState.VISIBLE:
        return False
```

**Change 2 — Replace placeholder print with inspection output (replace line 177):**

After the mana deduction (line 174) and before `mode = targeting.action.targeting_mode` (line 179), add an inspect-mode output block. Only runs when `targeting.action.targeting_mode == "inspect"`:

1. Look up `TileType` via `TileRegistry.get(target_tile._type_id)` to get `tile_name` and `tile_desc`. Guard against `_type_id` being None (fallback to "Unknown tile" and empty description).
2. Dispatch tile name: `esper.dispatch_event("log_message", f"[color=yellow]{tile_name}[/color]")`
3. If VISIBLE and tile_desc is non-empty, dispatch tile description: `esper.dispatch_event("log_message", tile_desc)`
4. If VISIBLE, iterate all entities at the target position using `esper.get_components(Position)`:
   - Skip the investigating entity itself (`if ent == entity: continue`).
   - Get entity name via `esper.try_component(ent, Name)` — skip if None.
   - Get Description via `esper.try_component(ent, Description)`.
   - Get Stats via `esper.try_component(ent, Stats)` — may be None for portals/corpses.
   - If entity has Description: dispatch `f"[color=white]{name_comp.name}[/color]: {desc_comp.get(stats)}"`.
   - If entity has Name but no Description: dispatch `f"[color=white]{name_comp.name}[/color]"`.
5. For non-inspect modes, keep the existing `print()` placeholder (it will be replaced when combat execution is implemented later).

**Add import at the top of action_system.py:**
- Add `from map.tile_registry import TileRegistry` alongside existing imports.
- Add `Name, Description` to the existing component import line (they are not yet imported in this file).

IMPORTANT: Do NOT move or change the `mode = targeting.action.targeting_mode` / `cancel_targeting()` / `end_player_turn()` block (lines 179-182). The output dispatch must happen BEFORE that block.
  </action>
  <verify>
Run existing tests to confirm no regression:
```
python -m pytest tests/verify_action_wiring.py tests/verify_range_movement.py -v
```
All existing tests must pass.
  </verify>
  <done>
confirm_action() dispatches colored tile name + description + entity descriptions to the message log for VISIBLE tiles, dispatches tile name only for SHROUDED tiles, and rejects UNEXPLORED tiles. Combat mode visibility gate unchanged. All prior tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add verification tests for inspection output</name>
  <files>tests/verify_inspection_output.py</files>
  <action>
Create `tests/verify_inspection_output.py` following the pattern from `tests/verify_range_movement.py`.

**Test setup helpers (reuse patterns from verify_range_movement.py):**
- `make_stats()` helper with all Stats fields.
- `make_map_with_visibility()` helper that also accepts an optional `tile_type_ids` 2D list to set `tile._type_id` on specific tiles.
- `MockTurnSystem` class.
- A message capture mechanism: a list `captured_messages` and a handler registered with `esper.set_handler("log_message", handler)`. The handler appends each message text to the list. Clear the list in each test setup.
- Before tests, register a known tile type in `TileRegistry` with a name and base_description (e.g., `TileRegistry.register("stone_floor", TileType(name="Stone Floor", base_description="A cold, uneven stone floor."))` or equivalent). Check TileRegistry API for the exact registration method — it may use `_registry` dict directly or a `load()` method.

**Tests to implement (7 tests covering all 5 success criteria + regression):**

1. `test_visible_tile_shows_name_and_description` (TILE-01):
   - Set up a VISIBLE tile with a known `_type_id` pointing to a registered TileType.
   - Player at (2,2), target at (2,2) (self-tile). Start inspect targeting, confirm.
   - Assert captured messages contain the tile name with `[color=yellow]` tag and the tile description.

2. `test_shrouded_tile_shows_name_only` (TILE-02):
   - Set up a SHROUDED tile with a known `_type_id`.
   - Place an entity (with Name + Description) at the target position.
   - Start inspect targeting, move cursor to SHROUDED tile, confirm.
   - Assert captured messages contain the tile name but NOT the tile description and NOT the entity name/description.

3. `test_entity_listed_at_visible_tile` (ENT-01):
   - Place an entity with Name("Orc") and Description(base="A menacing orc.") at the target position on a VISIBLE tile.
   - Confirm inspection.
   - Assert captured messages contain "[color=white]Orc[/color]: A menacing orc."

4. `test_wounded_entity_shows_wounded_text` (ENT-02):
   - Place an entity with Name("Orc"), Description(base="A menacing orc.", wounded_text="The orc looks wounded.", wounded_threshold=0.5), and Stats with hp=3, max_hp=10 (below threshold).
   - Confirm inspection on a VISIBLE tile.
   - Assert captured messages contain "The orc looks wounded." (not "A menacing orc.").

5. `test_multiple_entities_all_listed` (ENT-03):
   - Place two entities (e.g., "Orc" and "Goblin") both with Name and Description at the same VISIBLE position.
   - Confirm inspection.
   - Assert captured messages contain both entity names.

6. `test_entity_without_stats_no_crash` (ENT-04):
   - Place an entity with Name("Mysterious Portal") and Description(base="A shimmering gateway.") but NO Stats component at a VISIBLE position.
   - Confirm inspection.
   - Assert captured messages contain "Mysterious Portal" and "A shimmering gateway." and no exception raised.

7. `test_player_excluded_from_own_inspection` (regression guard):
   - Player inspects their own tile (target == origin).
   - Assert captured messages do NOT contain the player's Name.

Run with: `python -m pytest tests/verify_inspection_output.py -v`
  </action>
  <verify>
```
python -m pytest tests/verify_inspection_output.py -v
```
All 7 tests must pass. Then run full test suite:
```
python -m pytest tests/verify_action_wiring.py tests/verify_range_movement.py tests/verify_inspection_output.py tests/verify_description.py -v
```
No regressions.
  </verify>
  <done>
7 tests pass covering: VISIBLE tile name+description output, SHROUDED tile name-only output, entity listing, wounded flavor text, multiple entities, Stats-less entities, and player self-exclusion. No regressions in existing test suites.
  </done>
</task>

</tasks>

<verification>
Run all Phase 12-14 verification tests together to confirm full integration:
```
python -m pytest tests/verify_action_wiring.py tests/verify_description.py tests/verify_range_movement.py tests/verify_inspection_output.py -v
```
All tests pass with zero failures.
</verification>

<success_criteria>
1. Confirming investigation on a VISIBLE tile dispatches tile name (yellow), tile description, and all entity descriptions to the message log.
2. Confirming investigation on a SHROUDED tile dispatches only the tile name (no description, no entities).
3. Multiple entities at the same position are all reported.
4. Wounded entities show wounded_text instead of base description.
5. Entities without Stats (portals, corpses) produce output without crash.
6. Player entity is excluded from their own inspection output.
7. All existing Phase 12 and 13 tests continue to pass (no regression).
</success_criteria>

<output>
After completion, create `.planning/phases/14-inspection-output/14-01-SUMMARY.md`
</output>
