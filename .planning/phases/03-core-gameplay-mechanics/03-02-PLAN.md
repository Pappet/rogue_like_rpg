---
phase: 03-core-gameplay-mechanics
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: [services/visibility_service.py, ecs/systems/visibility_system.py, map/tile.py, ecs/systems/render_system.py]
autonomous: true

must_haves:
  truths:
    - "Tiles outside Line of Sight are obscured (Shrouded or Unexplored)"
    - "Obstacles (walls) block visibility correctly using Shadowcasting"
    - "Explored areas remain visible but tinted (Shrouded) when out of sight"
  artifacts:
    - path: "services/visibility_service.py"
      provides: "Recursive Shadowcasting algorithm"
    - path: "ecs/systems/visibility_system.py"
      provides: "Visibility state updates for tiles"
---

<objective>
Implement a 4-state Fog of War and Line of Sight (LoS) using Recursive Shadowcasting.

Purpose: Add exploration mechanics and strategic depth through hidden information.
Output: Dynamic visibility updates based on player position and perception.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-core-gameplay-mechanics/03-01-SUMMARY.md
@.planning/phases/03-core-gameplay-mechanics/03-RESEARCH.md
@.planning/phases/03-core-gameplay-mechanics/CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Recursive Shadowcasting</name>
  <files>services/visibility_service.py</files>
  <action>
    - Create `services/visibility_service.py`.
    - Implement the Recursive Shadowcasting algorithm for calculating visible tiles from a center point.
    - The algorithm should take a `transparency_func` (to check if a tile blocks light) and return a set of visible coordinates.
  </action>
  <verify>Run a standalone test script for the visibility service to confirm it correctly identifies visible tiles around an obstacle.</verify>
  <done>Shadowcasting algorithm is implemented and verified.</done>
</task>

<task type="auto">
  <name>Task 2: Visibility System & 4-State FoW</name>
  <files>ecs/systems/visibility_system.py, map/tile.py, ecs/systems/render_system.py</files>
  <action>
    - Update `map/tile.py` to include a `visibility_state` (UNEXPLORED, VISIBLE, SHROUDED, FORGOTTEN).
    - Create `ecs/systems/visibility_system.py`:
        - Process entities with `Position`, `Stats` (Perception), and `LightSource`.
        - Calculate LoS for the player party using `VisibilityService`.
        - Update map tiles:
            - Currently visible -> VISIBLE.
            - Previously VISIBLE but now out of range -> SHROUDED.
            - Otherwise keep state.
    - Update `RenderSystem` to handle visibility:
        - UNEXPLORED: Render as black/nothing.
        - SHROUDED: Render with a grey tint.
        - VISIBLE: Render normally.
  </action>
  <verify>In-game, moving the player reveals tiles; tiles behind walls stay black; tiles out of range turn grey.</verify>
  <done>Visibility System and 4-state FoW rendering are functional.</done>
</task>

<task type="auto">
  <name>Task 3: Perception-based Sight Range</name>
  <files>ecs/systems/visibility_system.py</files>
  <action>
    - Modify `VisibilitySystem` to use the maximum `Perception` attribute of active party members to determine the sight radius.
    - Ensure `LightSource` component also contributes to visibility if present.
  </action>
  <verify>Increasing a hero's Perception stat in code increases the visible area around the party in-game.</verify>
  <done>Sight range is dynamically determined by party stats.</done>
</task>

</tasks>

<verification>
- [ ] Walls block LoS.
- [ ] Explored tiles turn "Shrouded" when moving away.
- [ ] Sight radius matches party Perception.
</verification>

<success_criteria>
A robust Fog of War system is implemented with accurate LoS and state-based tile rendering.
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-gameplay-mechanics/03-02-SUMMARY.md`
</output>
