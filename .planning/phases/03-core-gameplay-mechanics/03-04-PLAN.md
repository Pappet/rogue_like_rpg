---
phase: 03-core-gameplay-mechanics
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified: [ecs/systems/action_system.py, game_states.py, ecs/systems/ui_system.py]
autonomous: true

must_haves:
  truths:
    - "Selecting a ranged action enters Targeting Mode"
    - "Auto-targeting cycles through valid enemies in Line of Sight"
    - "Manual targeting allows selecting any tile within range"
    - "Actions consume Mana/Arrows and are unavailable if resources are low"
    - "Pressing ESC cancels targeting and returns to the Action List"
  artifacts:
    - path: "ecs/systems/action_system.py"
      provides: "Action execution and targeting logic"
---

<objective>
Implement the Action System with targeting modes and resource consumption.

Purpose: Enable complex player interactions like spells and ranged attacks with targeting.
Output: A state-driven action system that handles targeting, resources, and turn advancement.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-core-gameplay-mechanics/03-02-SUMMARY.md
@.planning/phases/03-core-gameplay-mechanics/03-03-SUMMARY.md
@.planning/phases/03-core-gameplay-mechanics/CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Targeting System & Modes</name>
  <files>ecs/systems/action_system.py, game_states.py</files>
  <action>
    - Create `ecs/systems/action_system.py`.
    - Implement a "Targeting Mode" with two subtypes:
        - **Auto-Targeting**: Automatically cycle through entities with `Renderable` components that are in VISIBLE tiles.
        - **Manual Targeting**: Allow the player to move a cursor freely within a certain range.
    - Implement visual feedback for targeting (e.g., a cursor sprite and path/range highlighting).
  </action>
  <verify>Selecting a ranged action allows cycling through visible enemies with a cursor.</verify>
  <done>Targeting system with auto and manual modes is implemented.</done>
</task>

<task type="auto">
  <name>Task 2: Resource Consumption and ESC Handling</name>
  <files>ecs/systems/action_system.py, ecs/systems/ui_system.py, game_states.py</files>
  <action>
    - Integrate resource costs (Mana, Arrows) into `ActionSystem`.
    - Check `Stats` and `Inventory` components before allowing an action.
    - Decrement resources upon successful action confirmation.
    - Implement ESC key logic:
        - In Targeting Mode: ESC returns to the Action Sidebar.
        - In Action Sidebar: ESC has no effect or closes sub-menus.
    - Ensure successful actions advance the turn (via `TurnSystem` logic in ECS).
  </action>
  <verify>Casting a spell consumes mana; spell is unavailable if mana is 0; ESC exits targeting.</verify>
  <done>Action execution, resource management, and navigation flow are complete.</done>
</task>

</tasks>

<verification>
- [ ] Auto-targeting cycles through enemies.
- [ ] Mana is consumed when casting.
- [ ] ESC returns to action list.
</verification>

<success_criteria>
The action system supports multiple targeting modes and correctly manages resources and turn flow.
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-gameplay-mechanics/03-04-SUMMARY.md`
</output>
