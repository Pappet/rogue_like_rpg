---
phase: 03-core-gameplay-mechanics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [main.py, game_states.py, services/party_service.py, services/turn_service.py, ecs/components.py, ecs/world.py, ecs/systems/render_system.py, ecs/systems/movement_system.py, ecs/systems/turn_system.py]
autonomous: true

must_haves:
  truths:
    - "Game engine successfully uses esper ECS for core loops"
    - "Entity data is migrated from standalone objects to components"
    - "Render, Movement, and Turn logic handled by ECS systems"
  artifacts:
    - path: "ecs/world.py"
      provides: "Central ECS world initialization"
    - path: "ecs/components.py"
      provides: "Definitions for Position, Renderable, Stats, Inventory, TurnOrder, LightSource"
    - path: "ecs/systems/turn_system.py"
      provides: "Turn management logic refactored from TurnService"
---

<objective>
Refactor the current object-oriented structure into an Entity Component System (ECS) using the `esper` library.

Purpose: Provide a flexible architecture for complex gameplay interactions.
Output: A functional game engine running on ECS with basic movement, rendering, and turn management.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-gameplay-mechanics/03-RESEARCH.md
@.planning/phases/03-core-gameplay-mechanics/CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install esper and define core components</name>
  <files>ecs/components.py, ecs/world.py</files>
  <action>
    - Install the `esper` library using pip.
    - Create `ecs/components.py` with the following components (requested in CONTEXT.md):
        - `Position(x, y)`
        - `Renderable(sprite, layer, color=(255, 255, 255))`
        - `Stats(hp, max_hp, mana, max_mana, perception, intelligence)`
        - `Inventory(items=[])`
        - `TurnOrder(priority)`
        - `LightSource(radius)`
    - Create `ecs/world.py` to initialize a global `esper.World` instance.
  </action>
  <verify>Run a script that imports `esper` and creates a world with entities and components without error.</verify>
  <done>Core ECS components and world initialization are established.</done>
</task>

<task type="auto">
  <name>Task 2: Implement core ECS systems (Render, Movement, Turn)</name>
  <files>ecs/systems/render_system.py, ecs/systems/movement_system.py, ecs/systems/turn_system.py, game_states.py, services/turn_service.py</files>
  <action>
    - Create `ecs/systems/render_system.py`: Refactor logic from `RenderService` into a system that processes `Position` and `Renderable` components. It should respect layers and use the camera.
    - Create `ecs/systems/movement_system.py`: Implement logic for moving entities based on input or events, handling basic tile-based collisions.
    - Create `ecs/systems/turn_system.py`: Refactor logic from `TurnService` into a system that manages turn order based on `TurnOrder` components and global round counter.
    - Update `game_states.py` (`Game` class) to:
        - Initialize the `esper.World`.
        - Add `RenderSystem`, `MovementSystem`, and `TurnSystem` to the world.
        - Process the world during `update` and `draw`.
  </action>
  <verify>The game runs; player can move; turns advance using the new ECS systems.</verify>
  <done>Render, Movement, and Turn systems are integrated into the game loop.</done>
</task>

<task type="auto">
  <name>Task 3: Migrate entities to ECS</name>
  <files>services/party_service.py, main.py</files>
  <action>
    - Update `PartyService.create_initial_party` to create ECS entities for the player and each hero.
    - Assign appropriate components (`Position`, `Renderable`, `Stats`, `Inventory`, `TurnOrder`) to these entities.
    - Remove or refactor old `Player` and `Hero` classes if they are no longer needed as standalone objects.
    - Ensure `main.py` correctly passes the world state between components.
  </action>
  <verify>Player can move on the map and is rendered correctly, with stats visible in debug if possible.</verify>
  <done>All game entities are managed by the ECS world.</done>
</task>

</tasks>

<verification>
- [ ] `esper` is installed.
- [ ] Game runs without crashing.
- [ ] Player movement works as before (now via ECS).
- [ ] Rendering works as before (now via ECS).
- [ ] Turn management works via `TurnSystem`.
</verification>

<success_criteria>
The game is successfully refactored to use `esper` ECS for its core loop (rendering, movement, and turn management).
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-gameplay-mechanics/03-01-SUMMARY.md`
</output>