---
phase: 03-core-gameplay-mechanics
plan: 05
type: execute
wave: 3
depends_on: ["03-02"]
files_modified: [ecs/systems/visibility_system.py, map/map_container.py, services/map_service.py]
autonomous: true

must_haves:
  truths:
    - "Leaving a Map Container triggers the Forgotten state for explored tiles"
    - "The number of tiles remembered is influenced by the party's Intelligence"
    - "Forgotten tiles are rendered with a unique 'vague' sprite"
  artifacts:
    - path: "ecs/systems/visibility_system.py"
      provides: "Memory logic implementation"
---

<objective>
Implement the "Forgotten" state logic for map memory, triggered by map transitions.

Purpose: Simulate the party's fading memory of areas explored in the past.
Output: Tiles transitioning to FORGOTTEN state based on time and intelligence.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-core-gameplay-mechanics/03-02-SUMMARY.md
@.planning/phases/03-core-gameplay-mechanics/CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Intelligence-based Memory Logic</name>
  <files>ecs/systems/visibility_system.py, map/tile.py</files>
  <action>
    - Update `VisibilitySystem` to track "time since last seen" for SHROUDED tiles.
    - Implement a formula to transition SHROUDED tiles to FORGOTTEN:
        - Threshold = Intelligence * factor.
        - If (Rounds since seen) > Threshold, tile becomes FORGOTTEN.
    - Update `RenderSystem` to use a special "Forgotten" sprite (e.g., a faint outline or different character) for FORGOTTEN tiles.
  </action>
  <verify>After many turns, previously explored but far-away tiles change their visual representation to "Forgotten".</verify>
  <done>Memory-based "Forgotten" logic is implemented.</done>
</task>

<task type="auto">
  <name>Task 2: Map Transition Triggers</name>
  <files>map/map_container.py, services/map_service.py, ecs/systems/visibility_system.py</files>
  <action>
    - Modify `MapService` or the map transition logic to trigger a "Mass Forgetting" event when leaving a `MapContainer`.
    - All SHROUDED tiles in the current container should be evaluated or forcefully moved to FORGOTTEN (or based on Intelligence).
  </action>
  <verify>Switching maps and returning shows previously explored areas in the "Forgotten" state.</verify>
  <done>Map transitions correctly trigger memory loss logic.</done>
</task>

</tasks>

<verification>
- [ ] Tiles become FORGOTTEN after a period of time.
- [ ] Intelligence affects memory duration.
- [ ] Map transitions trigger FORGOTTEN state.
</verification>

<success_criteria>
The memory system adds a layer of realism and challenge by causing tiles to be "forgotten" over time and during map transitions.
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-gameplay-mechanics/03-05-SUMMARY.md`
</output>