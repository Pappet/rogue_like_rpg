---
phase: 17-wander-behavior
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ecs/systems/ai_system.py
  - tests/verify_wander_behavior.py
autonomous: true

must_haves:
  truths:
    - "An NPC in WANDER state moves to an adjacent cardinal tile on each enemy turn"
    - "An NPC never moves onto a tile that is not walkable (walls, blocking entities)"
    - "An NPC that has no walkable adjacent tiles takes no move action (skips turn without error)"
    - "Two NPCs that would move to the same tile in one turn: only one succeeds — no two NPCs stack on the same tile"
  artifacts:
    - path: "ecs/systems/ai_system.py"
      provides: "_wander(), _is_walkable(), _get_blocker_at() methods; updated _dispatch() and process() signatures"
      contains: "def _wander"
    - path: "tests/verify_wander_behavior.py"
      provides: "Verification tests for WNDR-01 through WNDR-04"
      exports: ["test_npc_wander_moves_to_adjacent_cardinal_tile", "test_npc_wander_never_moves_to_unwalkable_tile", "test_npc_skips_turn_when_all_adjacent_blocked", "test_two_npcs_do_not_stack_on_same_tile", "test_npc_wander_blocked_by_entity_blocker"]
  key_links:
    - from: "ecs/systems/ai_system.py _dispatch()"
      to: "ecs/systems/ai_system.py _wander()"
      via: "match/case AIState.WANDER branch"
      pattern: "case AIState\\.WANDER.*_wander"
    - from: "ecs/systems/ai_system.py process()"
      to: "ecs/systems/ai_system.py _dispatch()"
      via: "passes map_container and claimed_tiles through"
      pattern: "_dispatch\\(ent, behavior, pos, map_container, claimed_tiles\\)"
    - from: "ecs/systems/ai_system.py _wander()"
      to: "map/map_container.py get_tile()"
      via: "_is_walkable helper"
      pattern: "map_container\\.get_tile"
---

<objective>
Implement WANDER behavior in AISystem so AI entities in WANDER state move randomly to adjacent cardinal tiles each enemy turn, respecting walkability, entity blockers, and tile reservation.

Purpose: This makes the game world feel alive — NPCs wander independently instead of standing still during enemy turns.
Output: Working wander behavior in ai_system.py with full verification test suite.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-wander-behavior/17-RESEARCH.md
@.planning/phases/16-aisystem-skeleton-and-turn-wiring/16-01-SUMMARY.md
@ecs/systems/ai_system.py
@ecs/systems/movement_system.py
@ecs/components.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement wander behavior in AISystem</name>
  <files>ecs/systems/ai_system.py</files>
  <action>
Modify the existing AISystem in ecs/systems/ai_system.py to add wander behavior:

1. Add imports: `import random` and `from ecs.components import Blocker` (Blocker is needed for _get_blocker_at).

2. Add module-level constant: `CARDINAL_DIRS = [(0, -1), (0, 1), (-1, 0), (1, 0)]`

3. Modify `process()`: Create `claimed_tiles = set()` before the entity loop. Pass `map_container` and `claimed_tiles` to `_dispatch()`:
   ```python
   self._dispatch(ent, behavior, pos, map_container, claimed_tiles)
   ```

4. Update `_dispatch()` signature to accept `map_container` and `claimed_tiles`:
   ```python
   def _dispatch(self, ent, behavior, pos, map_container, claimed_tiles):
   ```
   Replace the WANDER `pass` stub with: `self._wander(ent, pos, map_container, claimed_tiles)`

5. Add `_wander(self, ent, pos, map_container, claimed_tiles)` method:
   - Copy `CARDINAL_DIRS`, shuffle with `random.shuffle(dirs)`.
   - For each (dx, dy): compute (nx, ny) = (pos.x+dx, pos.y+dy).
   - Skip if `(nx, ny) in claimed_tiles` (WNDR-04).
   - Skip if `not self._is_walkable(nx, ny, pos.layer, map_container)` (WNDR-02).
   - Skip if `self._get_blocker_at(nx, ny, pos.layer)` (WNDR-02).
   - If valid: `claimed_tiles.add((nx, ny))`, `pos.x = nx`, `pos.y = ny`, return.
   - If loop exhausts all 4 directions: return silently (WNDR-03).

6. Add `_is_walkable(self, x, y, layer_idx, map_container)` — copied from MovementSystem pattern:
   ```python
   tile = map_container.get_tile(x, y, layer_idx)
   return tile.walkable if tile else False
   ```

7. Add `_get_blocker_at(self, x, y, layer_idx)` — copied from MovementSystem pattern:
   ```python
   for ent, (pos, blocker) in esper.get_components(Position, Blocker):
       if pos.x == x and pos.y == y and pos.layer == layer_idx:
           return ent
   return None
   ```

Important: Use direct `pos.x`/`pos.y` mutation, NOT MovementRequest — MovementSystem runs before AISystem in the frame (confirmed in research). Do NOT import from MovementSystem — inline the helper methods as private methods on AISystem.
  </action>
  <verify>python -c "from ecs.systems.ai_system import AISystem; a = AISystem(); assert hasattr(a, '_wander'); assert hasattr(a, '_is_walkable'); assert hasattr(a, '_get_blocker_at'); print('OK')"</verify>
  <done>AISystem has _wander(), _is_walkable(), _get_blocker_at() methods. _dispatch() routes WANDER state to _wander(). process() creates claimed_tiles set and passes it through _dispatch().</done>
</task>

<task type="auto">
  <name>Task 2: Add verification tests for wander behavior</name>
  <files>tests/verify_wander_behavior.py</files>
  <action>
Create tests/verify_wander_behavior.py with 5 tests covering all 4 requirements. Follow the exact patterns from tests/verify_ai_system.py (reset_world, TurnSystem, esper entity creation).

Important: Call `ResourceLoader.load_tiles()` before creating any `Tile(type_id=...)` objects — TileRegistry raises ValueError if tiles are not loaded.

Helper function `make_walkable_map(width=5, height=5)`: Creates a MapContainer with a single MapLayer. Floor interior surrounded by wall border. Uses `Tile(type_id="floor_stone")` and `Tile(type_id="wall_stone")`.

Tests:

1. `test_npc_wander_moves_to_adjacent_cardinal_tile` (WNDR-01):
   - Place NPC at (2,2) on a 5x5 walkable map, WANDER state.
   - Run ai_sys.process(). Assert Manhattan distance from (2,2) is exactly 1.

2. `test_npc_wander_never_moves_to_unwalkable_tile` (WNDR-02):
   - 3x3 map: center floor, walls on N/E/W, floor on S row.
   - NPC at (1,1). Run process(). Assert pos is (1,2) — only valid direction is south.

3. `test_npc_skips_turn_when_all_adjacent_blocked` (WNDR-03):
   - 3x3 map: center floor surrounded entirely by walls.
   - NPC at (1,1). Run process(). Assert pos is still (1,1). Assert turn state is PLAYER_TURN. Must not raise.

4. `test_two_npcs_do_not_stack_on_same_tile` (WNDR-04):
   - 5x5 walkable map. Two NPCs with Blocker at (1,2) and (3,2).
   - Run process(). Assert pos1 != pos2.

5. `test_npc_wander_blocked_by_entity_blocker` (WNDR-02 entity blockers):
   - 5x5 walkable map. Place 4 Blocker entities at all cardinal neighbors of (2,2).
   - NPC at (2,2) with WANDER state. Run process(). Assert pos is still (2,2). Assert turn ends.

Use these imports:
```python
import esper
import pytest
from ecs.world import reset_world
from ecs.components import AI, AIBehaviorState, AIState, Alignment, Position, Blocker, Corpse
from ecs.systems.ai_system import AISystem
from ecs.systems.turn_system import TurnSystem
from map.map_container import MapContainer
from map.map_layer import MapLayer
from map.tile import Tile
from services.resource_loader import ResourceLoader
from config import GameStates
```

See the research file (17-RESEARCH.md "Verification test patterns") for complete test code reference.
  </action>
  <verify>cd /home/peter/Projekte/rogue_like_rpg && python -m pytest tests/verify_wander_behavior.py -v</verify>
  <done>All 5 tests pass: WNDR-01 (cardinal movement), WNDR-02 (walkability), WNDR-03 (skip when blocked), WNDR-04 (no stacking), WNDR-02 (entity blockers). Existing test suite still passes (python -m pytest tests/ passes with no regressions).</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/verify_wander_behavior.py -v` — all 5 tests pass
2. `python -m pytest tests/verify_ai_system.py -v` — Phase 16 tests still pass (no regressions)
3. `python -m pytest tests/ -v` — full test suite passes
4. Manual spot-check: `python -c "from ecs.systems.ai_system import AISystem, CARDINAL_DIRS; print(CARDINAL_DIRS)"` prints 4 cardinal tuples
</verification>

<success_criteria>
- AISystem._wander() moves NPC to random cardinal walkable tile via direct pos mutation
- AISystem._is_walkable() and _get_blocker_at() are private methods (not imported from MovementSystem)
- claimed_tiles set created per-turn in process(), passed through _dispatch() to _wander()
- _dispatch() signature updated to accept map_container and claimed_tiles
- All 5 wander verification tests pass
- All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/17-wander-behavior/17-01-SUMMARY.md`
</output>
