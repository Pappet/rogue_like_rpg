---
phase: 15-ai-component-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ecs/components.py
  - entities/entity_registry.py
  - services/resource_loader.py
  - assets/data/entities.json
  - entities/entity_factory.py
  - ecs/systems/death_system.py
  - tests/verify_entity_factory.py
autonomous: true

must_haves:
  truths:
    - "AIState enum has IDLE, WANDER, CHASE, TALK as named values importable from ecs/components.py"
    - "Alignment enum has HOSTILE, NEUTRAL, FRIENDLY as named values importable from ecs/components.py"
    - "An orc spawned via EntityFactory has AIBehaviorState with state=WANDER and alignment=HOSTILE"
    - "TALK is assignable to AIBehaviorState.state without error"
    - "Invalid default_state or alignment in JSON raises ValueError at load time"
    - "A dead entity does not retain AIBehaviorState, ChaseData, or WanderData components"
  artifacts:
    - path: "ecs/components.py"
      provides: "AIState enum, Alignment enum, AIBehaviorState dataclass, ChaseData dataclass, WanderData dataclass"
      contains: "class AIState"
    - path: "entities/entity_registry.py"
      provides: "EntityTemplate with default_state and alignment fields"
      contains: "default_state"
    - path: "services/resource_loader.py"
      provides: "Validation of default_state and alignment from JSON"
      contains: "AIState"
    - path: "assets/data/entities.json"
      provides: "Orc template with default_state and alignment fields"
      contains: "default_state"
    - path: "entities/entity_factory.py"
      provides: "AIBehaviorState attachment for AI entities"
      contains: "AIBehaviorState"
    - path: "ecs/systems/death_system.py"
      provides: "Cleanup of AI behavior components on death"
      contains: "AIBehaviorState"
  key_links:
    - from: "assets/data/entities.json"
      to: "services/resource_loader.py"
      via: "JSON fields parsed into EntityTemplate"
      pattern: "item\\.get\\(\"default_state\""
    - from: "entities/entity_factory.py"
      to: "ecs/components.py"
      via: "AIState/Alignment enum conversion and AIBehaviorState creation"
      pattern: "AIBehaviorState\\(state=AIState"
    - from: "ecs/systems/death_system.py"
      to: "ecs/components.py"
      via: "Component removal on death"
      pattern: "AIBehaviorState.*ChaseData.*WanderData"
---

<objective>
Add AIState enum, Alignment enum, and AI behavior ECS components (AIBehaviorState, ChaseData, WanderData) to the codebase. Wire the full data pipeline: JSON template fields -> ResourceLoader validation -> EntityTemplate storage -> EntityFactory component attachment -> DeathSystem cleanup.

Purpose: Every downstream AI system (Phases 16-18) depends on these data structures and the guarantee that AI entities carry typed behavior state from creation.
Output: Six modified source files, one modified JSON file, updated tests — all passing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-ai-component-foundation/15-RESEARCH.md
@ecs/components.py
@entities/entity_registry.py
@entities/entity_factory.py
@services/resource_loader.py
@ecs/systems/death_system.py
@assets/data/entities.json
@tests/verify_entity_factory.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define enums, components, template fields, and JSON pipeline</name>
  <files>
    ecs/components.py
    entities/entity_registry.py
    services/resource_loader.py
    assets/data/entities.json
  </files>
  <action>
**ecs/components.py** — Add at the top of the file (after existing imports, before Position):

1. Import `Enum` from `enum` module.
2. Add `AIState(str, Enum)` with values: IDLE="idle", WANDER="wander", CHASE="chase", TALK="talk".
3. Add `Alignment(str, Enum)` with values: HOSTILE="hostile", NEUTRAL="neutral", FRIENDLY="friendly".
4. Add three new dataclass components at the bottom of the file (after Description):
   - `AIBehaviorState` with fields: `state: AIState`, `alignment: Alignment`
   - `ChaseData` with fields: `last_known_x: int`, `last_known_y: int`, `turns_without_sight: int = 0`
   - `WanderData` with `pass` body and a docstring: "Stub component for wander state. Fields added when wander behavior is implemented."

**entities/entity_registry.py** — Add two new fields to the `EntityTemplate` dataclass:
- `default_state: str = "wander"` — raw string, converted to AIState in EntityFactory
- `alignment: str = "hostile"` — raw string, converted to Alignment in EntityFactory
Place these after the existing `blocker` field, before `description`.

**services/resource_loader.py** — In `load_entities()`, after the existing `blocker` parsing (around line 138):
1. Import `AIState` and `Alignment` from `ecs.components` at the top of the file.
2. Parse `default_state` with: `raw_state = item.get("default_state", "wander")`, then validate with try/except `AIState(raw_state)` raising `ValueError` with entity id and valid values list on failure.
3. Parse `alignment` with: `raw_alignment = item.get("alignment", "hostile")`, then validate with try/except `Alignment(raw_alignment)` raising `ValueError` with entity id and valid values list on failure.
4. Pass `default_state=raw_state` and `alignment=raw_alignment` to the `EntityTemplate()` constructor.

**assets/data/entities.json** — Add two fields to the orc entry:
- `"default_state": "wander"` (after `"ai": true`)
- `"alignment": "hostile"` (after `"default_state"`)
  </action>
  <verify>
Run `python -c "from ecs.components import AIState, Alignment, AIBehaviorState, ChaseData, WanderData; print(AIState.TALK, Alignment.NEUTRAL); s = AIBehaviorState(state=AIState.WANDER, alignment=Alignment.HOSTILE); print(s)"` — should print enum values and dataclass repr without error.

Run `python -c "from services.resource_loader import ResourceLoader; from entities.entity_registry import EntityRegistry; ResourceLoader.load_tiles('assets/data/tile_types.json'); ResourceLoader.load_entities('assets/data/entities.json'); t = EntityRegistry.get('orc'); print(t.default_state, t.alignment)"` — should print `wander hostile`.
  </verify>
  <done>
AIState and Alignment enums are importable from ecs/components.py with all specified values. AIBehaviorState, ChaseData, WanderData dataclasses exist. EntityTemplate has default_state and alignment string fields. ResourceLoader validates these fields from JSON and raises ValueError on invalid values. entities.json orc entry includes default_state and alignment.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire EntityFactory attachment and DeathSystem cleanup, update tests</name>
  <files>
    entities/entity_factory.py
    ecs/systems/death_system.py
    tests/verify_entity_factory.py
  </files>
  <action>
**entities/entity_factory.py** —
1. Update the import line to include: `AIBehaviorState, AIState, Alignment` from `ecs.components`.
2. In the `create()` method, inside the existing `if template.ai:` block (after `components.append(AI())`), add:
   ```
   components.append(AIBehaviorState(
       state=AIState(template.default_state),
       alignment=Alignment(template.alignment),
   ))
   ```
   This converts the raw template strings to enum values at entity creation time, matching the existing pattern where `SpriteLayer[template.sprite_layer]` conversion happens in the factory.

**ecs/systems/death_system.py** —
1. Update the import line to include: `AIBehaviorState, ChaseData, WanderData` from `ecs.components`.
2. Extend the component removal list on line 29 from `[Blocker, AI, Stats]` to `[Blocker, AI, Stats, AIBehaviorState, ChaseData, WanderData]`. The existing `has_component` guard already handles components that may not be present, so ChaseData/WanderData (which won't be attached until later phases) are safely skipped.

**tests/verify_entity_factory.py** —
1. Update imports to include `AIBehaviorState, AIState, Alignment` from `ecs.components`.
2. In `test_entity_factory_create()`, after the existing AI component assertion, add assertions:
   - `assert world.has_component(entity_id, AIBehaviorState)` with message "Orc entity should have AIBehaviorState component"
   - Get the AIBehaviorState component and assert `behavior.state == AIState.WANDER`
   - Assert `behavior.alignment == Alignment.HOSTILE`
3. Add a new test `test_ai_state_talk_assignable()`:
   - Create an orc entity via EntityFactory
   - Get its AIBehaviorState component
   - Assign `behavior.state = AIState.TALK`
   - Assert `behavior.state == AIState.TALK` — proves TALK is a valid, assignable state
4. Add a new test `test_invalid_state_raises()`:
   - Register a bad template manually with `default_state="invalid_state"` via direct `EntityRegistry.register()` call
   - Attempt `EntityFactory.create()` with that template id
   - Assert it raises `ValueError` (the AIState constructor will reject "invalid_state")
  </action>
  <verify>
Run `python -m pytest tests/verify_entity_factory.py -v` — all tests pass including the new AIBehaviorState, TALK assignability, and invalid state tests.

Run `python -m pytest tests/ -v` — full test suite passes with no regressions.
  </verify>
  <done>
EntityFactory attaches AIBehaviorState(state=WANDER, alignment=HOSTILE) to orc entities. DeathSystem removes AIBehaviorState, ChaseData, WanderData on entity death. Tests verify: orc has correct AIBehaviorState, TALK is assignable, invalid states raise ValueError. Full test suite passes.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from ecs.components import AIState, Alignment; assert AIState.TALK == 'talk'; assert Alignment.NEUTRAL == 'neutral'"` — enums work as string enums
2. `python -m pytest tests/verify_entity_factory.py -v` — all entity factory tests pass
3. `python -m pytest tests/ -v` — full test suite passes, no regressions
4. Manual spot check: `python -c "from ecs.components import AIBehaviorState, AIState, Alignment; b = AIBehaviorState(AIState.IDLE, Alignment.FRIENDLY); b.state = AIState.TALK; print(b)"` — state mutation works
</verification>

<success_criteria>
- AIState enum with IDLE, WANDER, CHASE, TALK importable from ecs/components.py
- Alignment enum with HOSTILE, NEUTRAL, FRIENDLY importable from ecs/components.py
- AIBehaviorState, ChaseData, WanderData dataclasses importable from ecs/components.py
- Orc entity created via EntityFactory has AIBehaviorState(state=WANDER, alignment=HOSTILE)
- TALK is assignable to AIBehaviorState.state without error
- Invalid default_state/alignment in JSON raises ValueError at ResourceLoader load time
- DeathSystem removes AIBehaviorState, ChaseData, WanderData on entity death
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-ai-component-foundation/15-01-SUMMARY.md`
</output>
