---
phase: 24
plan: 02
wave: 2
depends_on: [24-01]
files_modified: [ecs/components.py, game_states.py]
autonomous: true
must_haves:
  truths:
    - "Pressing G in GAME state picks up an item at the player's position if under weight capacity."
    - "Pressing D in INVENTORY state drops the selected item at the player's position."
    - "Pickup is rejected with a message log entry if the player's weight limit is exceeded."
    - "Dropped items use SpriteLayer.ITEMS (3) to render on the ground."
  artifacts:
    - path: "game_states.py"
      provides: "handle_player_input (K_g handling)"
  key_links:
    - "Inventory -> Portable (weight check during pickup)"
---

# Phase 24-02: Pickup and Drop Logic

**Goal:** Implement the logic for moving item entities between the map and the player's inventory, including weight capacity checks and logging.

## Requirements Covered
- **INV-01**: Player can pick up items at their position with the G key
- **INV-02**: Pickup is rejected with a log message when over weight capacity
- **INV-05**: Player can drop items from inventory with the D key, restoring them to the map

## Architecture
- **Weight Calculation:** Sum the `weight` from the `Portable` component of all items in `Inventory.items`.
- **Capacity:** Store `max_carry_weight` in the `Stats` component.
- **Entity Lifecycle:** Pickup removes `Position` from the item; Drop adds `Position` back with `SpriteLayer.ITEMS`.

<tasks>

<task type="auto">
<files>
<file>ecs/components.py</file>
</files>
<action>
Add `max_carry_weight: float = 20.0` to the `Stats` dataclass in `ecs/components.py`.
</action>
<verify>
Check if `Stats` objects have the `max_carry_weight` field.
</verify>
<done>
`Stats` component updated.
</done>
</task>

<task type="auto">
<files>
<file>game_states.py</file>
</files>
<action>
1. Implement pickup logic in `Game.handle_player_input` for `K_g`:
    - Find items at player's (x, y).
    - Perform weight check.
    - If successful, remove `Position` from item, add to `Inventory.items`, and log "You pick up the [item name]."
    - If over capacity, log "Too heavy to carry."
2. Implement drop logic in `InventoryState.get_event` for `K_d`:
    - Remove selected item from `Inventory.items`.
    - Add `Position(x, y, layer)` to item entity using player's current position and map layer.
    - Ensure item's `Renderable.layer` is set to `SpriteLayer.ITEMS.value`.
    - Log "You drop the [item name]."
</action>
<verify>
Perform pickup and drop in-game. Verify items appear/disappear from map and inventory list. Check message log.
</verify>
<done>
Pickup and drop logic implemented and integrated.
</done>
</task>

<task type="tdd">
<files>
<file>tests/verify_inventory_logic.py</file>
</files>
<action>
Write a test script to verify:
- Item pickup (entity loses Position, enters Inventory).
- Item drop (entity gains Position, leaves Inventory).
- Weight limit enforcement (pickup fails if total weight > max_carry_weight).
</action>
<verify>
Run `python3 tests/verify_inventory_logic.py`.
</verify>
<done>
Inventory logic verified with automated tests.
</done>
</task>

</tasks>
