---
phase: 24
plan: 03
wave: 3
depends_on: [23, 24-02]
files_modified: [ecs/components.py, ecs/systems/death_system.py, entities/entity_factory.py, assets/data/entities.json, game_states.py]
autonomous: true
must_haves:
  truths:
    - "Monsters with a LootTable component drop items upon death."
    - "Loot items scatter to adjacent tiles if the death tile is blocked by a wall."
  artifacts:
    - path: "ecs/systems/death_system.py"
      provides: "loot drop logic in on_entity_died, set_map method"
  key_links:
    - "LootTable -> ItemFactory (creation of dropped items)"
    - "Game.startup -> DeathSystem.set_map"
---

# Phase 24-03: Loot Drops

**Goal:** Implement contextual loot drops for monsters using a `LootTable` component and `DeathSystem` integration with spatial scattering.

## Requirements Covered
- **CONS-03**: Monsters have contextual loot tables
- **CONS-04**: Loot items spawn at monster position on death via entity_died event

## Architecture
- **Component:** `LootTable` contains a list of `(template_id, chance)` pairs.
- **System Integration:** `DeathSystem.on_entity_died` iterates through the `LootTable` and rolls for drops.
- **Spatial Logic:** `DeathSystem` needs a reference to `MapContainer` (via `set_map`) to check walkability for loot scattering.

<tasks>

<task type="auto">
<files>
<file>ecs/components.py</file>
</files>
<action>
Add `LootTable` component to `ecs/components.py`.
```python
@dataclass
class LootTable:
    entries: List[Tuple[str, float]] = field(default_factory=list)
```
</action>
<verify>
`LootTable` component is available in the ECS.
</verify>
<done>
`LootTable` component added.
</done>
</task>

<task type="auto">
<files>
<file>ecs/systems/death_system.py</file>
<file>entities/entity_factory.py</file>
<file>assets/data/entities.json</file>
<file>game_states.py</file>
</files>
<action>
1. Add `set_map(self, map_container)` method to `DeathSystem`.
2. Update `Game.startup` to call `death_system.set_map(self.map_container)` and update it during `transition_map`.
3. Update `DeathSystem.on_entity_died` to process `LootTable` components and spawn items using `ItemFactory`.
4. Implement loot scattering logic in `on_entity_died` (check 8 neighbors if death tile is blocked).
5. Update `EntityFactory` to parse `loot_table` from `entities.json` and attach the component.
6. Add sample loot tables to `entities.json`.
</action>
<verify>
Kill a monster in-game or via test script and verify item spawn.
</verify>
<done>
Loot system implemented and monster data updated.
</done>
</task>

<task type="tdd">
<files>
<file>tests/verify_loot_system.py</file>
</files>
<action>
Write a test script to verify:
- Monster with 100% drop chance always drops the item.
- Loot scattering works when the death tile is blocked (simulated).
</action>
<verify>
Run `python3 tests/verify_loot_system.py`.
</verify>
<done>
Loot system verified with automated tests.
</done>
</task>

</tasks>
