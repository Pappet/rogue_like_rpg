---
phase: 29-pathfinding-service
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [ecs/components.py, services/pathfinding_service.py]
autonomous: true
---

<objective>
Install the `pathfinding` library, define the `PathData` component for storing routes, and implement the `PathfindingService` to provide A* navigation.

Purpose: Establishing the foundation for NPCs to navigate purposefully to destinations instead of using simple random or greedy moves.
Output: A functional pathfinding service and a data component to hold its results.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-pathfinding-service/29-RESEARCH.md
@ecs/components.py
@map/map_container.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Setup and PathData Component</name>
  <files>ecs/components.py</files>
  <action>
    1. Install the `pathfinding` library using `pip install pathfinding`.
    2. Add the `PathData` component to `ecs/components.py`.
    - Use `@dataclass` and include:
      - `path: List[Tuple[int, int]]`: A list of coordinates representing the route (skipping the current position).
      - `destination: Tuple[int, int]`: The target coordinates (used to detect if the target has moved).
    - Ensure necessary imports (List, Tuple) are present.
  </action>
  <verify>
    Run `python3 -c "from ecs.components import PathData; print(PathData([], (0,0)))"`
    Run `pip show pathfinding`
  </verify>
  <done>
    `pathfinding` is installed and `PathData` component is defined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement PathfindingService</name>
  <files>services/pathfinding_service.py</files>
  <action>
    Implement the `PathfindingService` in `services/pathfinding_service.py` as a wrapper for the `pathfinding` library.
    
    Requirements:
    - Use `pathfinding.core.grid.Grid` to build a matrix from `MapContainer` walkability.
    - Matrix values: 1 for walkable, 0 for blocked.
    - Integrate `esper` entity blockers: Iterate all entities with `Position` and `Blocker` components. Set matrix cell to 0 if blocked.
    - **Exception**: Explicitly set the `destination` tile as walkable (1) even if it contains a blocker (allowing pathing TO a target).
    - Use `pathfinding.finder.a_star.AStarFinder` with `diagonal_movement=DiagonalMovement.never` for cardinal-only movement.
    - Return a list of `(x, y)` tuples, excluding the starting position.
  </action>
  <verify>
    Check for syntax errors and correct imports. A full functional test will be performed in Plan 03.
  </verify>
  <done>
    `PathfindingService` is implemented and integrates with both the map and entity blockers.
  </done>
</task>

</tasks>

<verification>
Check `ecs/components.py` for the new `PathData` class.
Check `services/pathfinding_service.py` for the `PathfindingService` implementation.
</verification>

<success_criteria>
1. `pathfinding` library is available in the environment.
2. `PathData` component exists and is importable.
3. `PathfindingService.get_path` can compute a list of coordinates on a grid.
</success_criteria>

<output>
After completion, create `.planning/phases/29-pathfinding-service/29-01-SUMMARY.md`
</output>
