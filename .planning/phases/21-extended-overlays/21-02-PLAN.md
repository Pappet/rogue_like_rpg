---
phase: 21-extended-overlays
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - ecs/systems/debug_render_system.py
autonomous: true
must_haves:
  truths:
    - "A line connects the chasing NPC to its last known target position"
    - "AI labels show the number of turns without sight (T:X)"
  artifacts:
    - path: "ecs/systems/debug_render_system.py"
      provides: "_render_chase_vectors implementation"
  key_links:
    - from: "DebugRenderSystem"
      to: "ChaseData.turns_without_sight"
      via: "component access"
---

<objective>
Enhance chase visualization with vector lines and turns-without-sight counters.
Purpose: Help developers understand AI pathing intentions and timing.
Output: Vector lines for pursuit and numerical counters for detection memory.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/21-extended-overlays/21-01-SUMMARY.md
@ecs/systems/debug_render_system.py
@ecs/components.py
</context>

<tasks>

<task type="auto">
  <name>Implement Chase Vector Vectors</name>
  <files>ecs/systems/debug_render_system.py</files>
  <action>
    1. Update `_render_chase_targets` (or rename to `_render_chase_vectors`):
       - For each entity with `Position`, `ChaseData`, and `AIBehaviorState` in `CHASE` state:
       - Calculate NPC screen center: `(pos.x * TILE_SIZE - camera.x + TILE_SIZE//2, pos.y * TILE_SIZE - camera.y + TILE_SIZE//2)`
       - Calculate target screen center: `(chase.last_known_x * TILE_SIZE - camera.x + TILE_SIZE//2, chase.last_known_y * TILE_SIZE - camera.y + TILE_SIZE//2)`
       - Draw a line using `pygame.draw.line` with `DEBUG_CHASE_COLOR`.
       - Draw a circle or arrow-head at the target position using `pygame.draw.circle`.
       - Optimization: Cull if both points are off-screen.
  </action>
  <verify>
    Visual check: Hostile NPC in CHASE state should have a line pointing to its target.
  </verify>
  <done>
    Chase vectors are visually represented as lines.
  </done>
</task>

<task type="auto">
  <name>Enhance AI Labels with Sight Counter</name>
  <files>ecs/systems/debug_render_system.py</files>
  <action>
    Update `_render_ai_labels`:
    - Fetch `ChaseData` component if it exists for the entity.
    - If `ChaseData` exists, append `T:{chase.turns_without_sight}` to the label text (e.g., "C T:3").
    - If `turns_without_sight > 0`, consider changing label color to a "faded" version or adding the counter.
    - Ensure label is readable against background (draw a small dark rect behind text if needed).
  </action>
  <verify>
    Visual check: AI labels now show state and turn counter.
  </verify>
  <done>
    AI labels provide real-time feedback on NPC memory.
  </done>
</task>

</tasks>

<verification>
Manual verification:
1. Trigger a chase by letting an NPC see the player.
2. Move out of sight.
3. Observe the line pointing to your last position.
4. Observe the 'T:X' counter increasing each turn you are hidden.
</verification>

<success_criteria>
- Chase lines accurately connect NPC to target.
- AI labels correctly report `turns_without_sight`.
- Visualization is clear and doesn't crash if components are missing.
</success_criteria>

<output>
After completion, create `.planning/phases/21-extended-overlays/21-02-SUMMARY.md`
</output>
