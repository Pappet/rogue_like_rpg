---
phase: 21-extended-overlays
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - config.py
  - game_states.py
  - ecs/systems/debug_render_system.py
autonomous: true
must_haves:
  truths:
    - "Pressing F3 toggles master debug overlay"
    - "Pressing F4 toggles player FOV overlay (when master is on)"
    - "Pressing F5 toggles NPC FOV overlay (when master is on)"
    - "Pressing F6 toggles Chase overlay (when master is on)"
    - "Pressing F7 toggles AI Labels overlay (when master is on)"
  artifacts:
    - path: "game_states.py"
      provides: "Input handling for F3-F7"
    - path: "ecs/systems/debug_render_system.py"
      provides: "Flag-aware rendering methods"
  key_links:
    - from: "Game.handle_player_input"
      to: "self.persist['debug_flags']"
      via: "dictionary update"
    - from: "Game.draw"
      to: "DebugRenderSystem.process"
      via: "passing flags argument"
---

<objective>
Implement granular control for debug overlays using a flag dictionary instead of a single boolean.
Purpose: Allow developers to toggle specific debug information (FOV, Chase, Labels) independently to reduce visual clutter.
Output: Updated input handling and rendering system that respects individual flags.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/21-extended-overlays/21-RESEARCH.md
@config.py
@game_states.py
@ecs/systems/debug_render_system.py
</context>

<tasks>

<task type="auto">
  <name>Update Configuration</name>
  <files>config.py</files>
  <action>
    Add new debug colors to `config.py`:
    - `DEBUG_NPC_FOV_COLOR` (e.g., (255, 0, 0, 30))
    - `DEBUG_ARROW_COLOR` (e.g., (255, 255, 0))
    - `DEBUG_TEXT_BG_COLOR` (e.g., (0, 0, 0, 150))
  </action>
  <verify>
    grep "DEBUG_NPC_FOV_COLOR" config.py
  </verify>
  <done>
    New color constants are defined.
  </done>
</task>

<task type="auto">
  <name>Refactor Debug Input Handling</name>
  <files>game_states.py</files>
  <action>
    1. In `Game.startup`:
       - Initialize `self.persist["debug_flags"]` if missing.
       - Structure: `{ "master": False, "player_fov": True, "npc_fov": False, "chase": True, "labels": True }`
       - Remove reliance on `self.persist["debug_enabled"]` (migrate if exists, or just overwrite).
    2. In `Game.handle_player_input`:
       - F3: Toggle `debug_flags["master"]`.
       - F4: Toggle `debug_flags["player_fov"]`.
       - F5: Toggle `debug_flags["npc_fov"]`.
       - F6: Toggle `debug_flags["chase"]`.
       - F7: Toggle `debug_flags["labels"]`.
       - Print current flag state to console for confirmation.
    3. In `Game.draw`:
       - Pass `self.persist["debug_flags"]` to `self.debug_render_system.process(surface, self.persist["debug_flags"])`.
       - Only call `process` if `debug_flags["master"]` is True.
  </action>
  <verify>
    Check `game_states.py` for F3-F7 key handling and `debug_flags` initialization.
  </verify>
  <done>
    Input handling supports multiple toggle keys and passes flags to render system.
  </done>
</task>

<task type="auto">
  <name>Update DebugRenderSystem to use Flags</name>
  <files>ecs/systems/debug_render_system.py</files>
  <action>
    1. Update `process` method signature to accept `flags`.
    2. In `process`, check flags before calling render methods:
       - `_render_fov_overlay` (Player FOV) -> check `flags.get("player_fov", True)`
       - `_render_chase_targets` -> check `flags.get("chase", True)`
       - `_render_ai_labels` -> check `flags.get("labels", True)`
    3. Add placeholder method `_render_npc_fov` (checked by `npc_fov`) to prevent errors if flag is set.
  </action>
  <verify>
    grep "def process(self, surface, flags):" ecs/systems/debug_render_system.py
  </verify>
  <done>
    DebugRenderSystem respects the passed flags dictionary.
  </done>
</task>

</tasks>

<verification>
Manual verification required:
1. Run game.
2. Press F3 -> Overlay appears (Master ON).
3. Press F4 -> Player FOV toggles.
4. Press F5-F7 -> Check console output (functionality is stubs or existing).
</verification>

<success_criteria>
- Game runs without errors.
- F3 toggles the debug overlay system.
- F4-F7 keys toggle individual flags in the persistence dictionary.
- DebugRenderSystem only renders enabled layers.
</success_criteria>

<output>
After completion, create `.planning/phases/21-extended-overlays/21-01-SUMMARY.md`
</output>
