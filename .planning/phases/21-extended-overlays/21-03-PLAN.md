---
phase: 21-extended-overlays
plan: 03
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - ecs/systems/debug_render_system.py
autonomous: true
must_haves:
  truths:
    - "NPC field of view is visualized as a tinted area on the map"
    - "Only NPCs within the camera viewport have their FOV computed"
  artifacts:
    - path: "ecs/systems/debug_render_system.py"
      provides: "_render_npc_fov implementation"
  key_links:
    - from: "DebugRenderSystem"
      to: "VisibilityService.compute_visibility"
      via: "static method call"
---

<objective>
Implement NPC Field of View (FOV) visualization.
Purpose: Visually confirm why an NPC can or cannot see the player.
Output: Red-tinted overlay tiles representing individual NPC sight ranges.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/21-extended-overlays/21-01-SUMMARY.md
@ecs/systems/debug_render_system.py
@services/visibility_service.py
</context>

<tasks>

<task type="auto">
  <name>Implement NPC FOV Rendering</name>
  <files>ecs/systems/debug_render_system.py</files>
  <action>
    1. Import `VisibilityService` in `ecs/systems/debug_render_system.py`.
    2. Implement `_render_npc_fov(self)`:
       - Iterate over all entities with `Position`, `Stats` (for perception), and `AIBehaviorState`.
       - Optimization: Only process entities within the `self.camera` viewport.
       - Define a `transparency_func(x, y)` that returns `True` if the tile at `(x, y, layer)` is transparent.
         - Handle `None` tiles as non-transparent.
       - Call `VisibilityService.compute_visibility((pos.x, pos.y), stats.perception, transparency_func)`.
       - For each visible tile:
         - Calculate screen coordinates relative to camera.
         - Draw a semi-transparent rect using `DEBUG_NPC_FOV_COLOR` from `config.py`.
         - Use a separate small Surface with alpha if `pygame.draw.rect` doesn't support alpha on the main overlay (which is `SRCALPHA` anyway, so it should work).
    3. Ensure this method is called in `process` when `flags.get("npc_fov")` is True.
  </action>
  <verify>
    Visual check: Hostile NPCs show their vision cones when the overlay is active.
  </verify>
  <done>
    NPC vision cones are rendered in real-time.
  </done>
</task>

</tasks>

<verification>
Manual verification:
1. Turn on Master Debug (F3) and NPC FOV (F5).
2. Approach an NPC.
3. Observe its vision cone (red tinted tiles).
4. Verify that vision is blocked by walls.
</verification>

<success_criteria>
- NPC FOV is accurately calculated using shadowcasting.
- Performance remains acceptable with a few NPCs on screen (culling is active).
- Vision cones respond correctly to environment changes (e.g., walls).
</success_criteria>

<output>
After completion, create `.planning/phases/21-extended-overlays/21-03-SUMMARY.md`
</output>
