---
phase: 19-debug-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ecs/systems/debug_render_system.py
  - game_states.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Pressing F3 toggles debug mode (observable via console/log)"
    - "Debug state persists between Game and WorldMap states"
    - "DebugRenderSystem is NOT registered with esper"
    - "Debug drawing uses a pre-allocated overlay surface"
  artifacts:
    - path: "ecs/systems/debug_render_system.py"
      provides: "DebugRenderSystem class"
      contains: "pygame.SRCALPHA"
    - path: "game_states.py"
      provides: "Debug wiring"
      contains: "self.persist.get("debug_enabled")"
  key_links:
    - from: "game_states.py"
      to: "ecs/systems/debug_render_system.py"
      via: "Explicit call in Game.draw()"
      pattern: "self\.debug_render_system\.process"
---

<objective>
Implement the DebugRenderSystem and wire it into the game loop with a toggle hotkey.

Purpose: Foundation for visual debugging tools (FOV, AI, Chase).
Output: A toggleable debug mode that renders an overlay (currently empty) without performance impact when disabled.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-debug-infrastructure/19-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DebugRenderSystem</name>
  <files>ecs/systems/debug_render_system.py</files>
  <action>
    Create `DebugRenderSystem` class in `ecs/systems/debug_render_system.py`.
    
    Requirements:
    - Initialize with `camera` and `map_container`.
    - Create `self.overlay` as a `pygame.SRCALPHA` surface with camera dimensions.
    - Create `self.font` (SysFont "monospace", size 12).
    - Implement `process(self, surface)`:
      1. Clear `self.overlay` with `fill((0,0,0,0))`.
      2. (Placeholder) Draw a small text "DEBUG MODE" at (10, 10) on the overlay to verify visibility.
      3. Blit `self.overlay` to `surface` at `(camera.offset_x, camera.offset_y)`.
      
    Reference `ecs/systems/render_system.py` for camera/surface handling patterns.
  </action>
  <verify>
    Check file exists and imports pygame.
  </verify>
  <done>
    `DebugRenderSystem` class exists with overlay and process method.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Debug System into Game Loop</name>
  <files>game_states.py</files>
  <action>
    Modify `Game` class in `game_states.py`:
    
    1. Import `DebugRenderSystem` from `ecs.systems.debug_render_system`.
    2. In `startup(self, persistent)`:
       - Initialize `persist["debug_enabled"]` to `False` if not present.
       - Initialize `self.debug_render_system = DebugRenderSystem(self.camera, self.map_container)`.
       - Do NOT add to `esper`.
    3. In `handle_player_input(self, event)`:
       - Add `pygame.K_F3` check.
       - Toggle `self.persist["debug_enabled"]`.
       - Print "Debug mode: [True/False]" to console/stdout.
    4. In `draw(self, surface)`:
       - Inside the viewport clip region (after `render_system.process`), check `if self.persist.get("debug_enabled"):`.
       - If true, call `self.debug_render_system.process(surface)`.
  </action>
  <verify>
    Run game, press F3. Expect "Debug mode: True" in console and "DEBUG MODE" text on screen.
  </verify>
  <done>
    F3 toggles debug mode, text appears when enabled, no crash.
  </done>
</task>

</tasks>

<verification>
Manual Verification:
1. Run `python main.py`.
2. Press F3. Console should say "Debug mode: True".
3. Screen should show "DEBUG MODE" text (if implemented in Task 1).
4. Press F3 again. Console should say "Debug mode: False". Text should disappear.
5. Move player (ensure no lag/crash).
6. Press 'M' to go to map, then 'M' back. Debug state should persist.
</verification>

<success_criteria>
- [ ] DebugRenderSystem exists in own file
- [ ] F3 toggles debug state
- [ ] Debug state persists across state transitions
- [ ] Overlay is only drawn when debug is enabled
</success_criteria>

<output>
After completion, create `.planning/phases/19-debug-infrastructure/19-01-SUMMARY.md`
</output>
