---
phase: 05-nested-world-architecture
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - tests/verify_phase_05.py
autonomous: true
must_haves:
  truths:
    - "Verification script runs without error"
    - "Player successfully moves from City to House"
    - "Player successfully moves from House to City (Layer 2)"
    - "Entities in City are preserved when returning"
  artifacts:
    - path: "tests/verify_phase_05.py"
      provides: "Automated verification of nested world logic"
  key_links: []
---

<objective>
Create a comprehensive test scenario to verify the Nested World architecture. This acts as the acceptance test for the phase.

Purpose: Prove that portals, layers, and persistence work as intended in a realistic scenario.
Output: A passing verification script.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/05-nested-world-architecture/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create Verification Script</name>
  <files>tests/verify_phase_05.py</files>
  <action>
    Create a python script that mocks the Game environment (or uses the actual classes headless):
    1. Initialize `MapService`.
    2. Create Map "City":
       - Size 20x20.
       - 3 Layers (Ground, Roof, Balcony).
       - Add a generic Entity (e.g., "City NPC") at (10, 10).
       - Add Portal at (5, 5, 0) -> Target: "House", (2, 2, 0).
    3. Create Map "House":
       - Size 10x10.
       - 1 Layer.
       - Add Portal at (2, 2, 0) -> Target: "City", (5, 5, 2).
    4. Initialize `Game` state (headless if possible, or mocked).
       - Set Player at City (5, 5, 0).
    5. Trigger "Enter Portal":
       - Verify Player moves to House (2, 2).
       - Verify "City NPC" is NOT in ECS (frozen).
    6. Trigger "Enter Portal" (in House):
       - Verify Player moves to City (5, 5, 2).
       - Verify "City NPC" IS in ECS (thawed).
    
    *Implementation Note:* You may need to mock `pygame` if the classes are tightly coupled to it. Alternatively, construct the `World`, `MapService`, and `ActionSystem` directly without the full `Game` loop overhead, manually invoking the transition logic.
  </action>
  <verify>
    Run `python3 tests/verify_phase_05.py` and ensure it prints "SUCCESS".
  </verify>
  <done>
    Verification script confirms all requirements of Phase 5.
  </done>
</task>

</tasks>

<verification>
Execute the script.
</verification>

<success_criteria>
- The script passes.
- It explicitly checks: Layer transitions, Coordinate updates, Entity persistence.
</success_criteria>

<output>
After completion, create `.planning/phases/05-nested-world-architecture/05-03-SUMMARY.md`
</output>
