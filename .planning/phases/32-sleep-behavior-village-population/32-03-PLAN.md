---
phase: 32-sleep-behavior-village-population
plan: 03
type: execute
wave: 1
depends_on: [32-02]
files_modified: [ecs/systems/schedule_system.py, assets/data/schedules.json, assets/data/entities.json, services/map_service.py]
autonomous: true

must_haves:
  truths:
    - "Guards and Shopkeepers exist in the Village scenario"
    - "NPCs have three distinct routine states (WORK, SOCIALIZE, SLEEP)"
    - "NPCs are neutral and do not attack the player on sight"
    - "NPCs transition through states when world time changes"
  artifacts:
    - path: "assets/data/entities.json"
      provides: "Guard and Shopkeeper templates"
    - path: "assets/data/schedules.json"
      provides: "NPC daily routines"
    - path: "services/map_service.py"
      provides: "NPC spawning in village scenario"
  key_links:
    - from: "services/map_service.py"
      to: "entities/entity_factory.py"
      via: "NPC creation during map generation"
---

<objective>
Populate the village scenario with neutral NPCs (Guards, Shopkeepers, Villagers) following multi-state daily routines.

Purpose: Bring the village to life with persistent NPCs that have jobs, social lives, and sleep cycles.
Output: A populated village with NPCs that move between work locations, social spots, and their homes.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@ecs/systems/schedule_system.py
@assets/data/entities.json
@assets/data/schedules.json
@services/map_service.py
@entities/entity_factory.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Data Definitions and System Robustness</name>
  <files>ecs/systems/schedule_system.py, assets/data/schedules.json, assets/data/entities.json</files>
  <action>
    1. Update `ecs/systems/schedule_system.py`:
       - In `process()`, convert `current_entry.activity` to uppercase before checking against `SLEEP` and using it as a key in `ACTIVITY_TO_STATE`.
       - Example: `activity_key = current_entry.activity.upper()`.
    2. Update `assets/data/schedules.json`:
       - Add `guard_routine`:
         - 00:00 - 06:00: `SLEEP` (target_meta: "home")
         - 06:00 - 18:00: `WORK` (target_pos: [10, 10] - exterior patrol post)
         - 18:00 - 22:00: `SOCIALIZE` (target_pos: [20, 10] - near tavern)
         - 22:00 - 00:00: `SLEEP` (target_meta: "home")
       - Add `shopkeeper_routine`:
         - 00:00 - 07:00: `SLEEP` (target_meta: "home")
         - 07:00 - 19:00: `WORK` (target_pos: [5, 5] - inside shop/tavern)
         - 19:00 - 22:00: `SOCIALIZE` (target_pos: [20, 10] - near tavern)
         - 22:00 - 00:00: `SLEEP` (target_meta: "home")
       - Update `villager_routine` to include a `SOCIALIZE` state.
       - Ensure ALL activity names in the JSON are uppercase for consistency.
    3. Update `assets/data/entities.json`:
       - Add `guard`: Neutral, sprite "G", color [100, 100, 255], `schedule_id`: "guard_routine", `home_pos`: [35, 35].
       - Add `shopkeeper`: Neutral, sprite "S", color [255, 255, 100], `schedule_id`: "shopkeeper_routine", `home_pos`: [2, 2].
  </action>
  <verify>
    Check JSON syntax for both files.
    Verify `ScheduleSystem` change via a small test or code inspection.
  </verify>
  <done>
    NPC templates and routines are defined. ScheduleSystem is case-insensitive.
  </done>
</task>

<task type="auto">
  <name>Task 2: Populate Village Scenario</name>
  <files>services/map_service.py</files>
  <action>
    Update `MapService.create_village_scenario`:
    1. Import `EntityFactory`.
    2. Before `village_container.freeze(world)`:
       - Spawn 2 `guard` entities at their home positions [35, 35] and [5, 35] in the "Village" map.
       - Spawn 2 `villager` entities at [10, 10] and [12, 12].
    3. Inside the house creation loop, before `h_container.freeze(world)`:
       - For "Shop": Spawn a `shopkeeper` at [5, 5].
       - For "Tavern": Spawn a `shopkeeper` at [7, 7].
       - For "Cottage": Spawn a `villager` at [4, 4].
    4. Ensure all spawned NPCs are on Layer 0 of their respective maps.
  </action>
  <verify>
    Check that `EntityFactory.create` is called with the correct template IDs.
    Ensure spawning occurs before `freeze()` to persist them in the containers.
  </verify>
  <done>
    NPCs are spawned in the exterior and house interiors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verification of Village Population</name>
  <files>tests/verify_village_population.py</files>
  <action>
    Create `tests/verify_village_population.py`:
    1. Initialize ECS world and `MapService`.
    2. Run `create_village_scenario`.
    3. Verify entities exist in the "Village" map (thaw it and count entities).
    4. Verify entities exist in "Shop" and "Tavern" containers (check `frozen_entities`).
    5. Check that NPCs have `AIBehaviorState` with `Alignment.NEUTRAL`.
    6. Check that NPCs have `Schedule` and `Activity` components.
    7. Mock `WorldClockService` and run `ScheduleSystem` to verify activity changes for a `guard` at different hours.
  </action>
  <verify>
    Run `python tests/verify_village_population.py`
  </verify>
  <done>
    Village population and routines are verified via automated tests.
  </done>
</task>

</tasks>

<verification>
- NPCs exist in the village and house interiors.
- NPCs are neutral and have multi-state routines.
- ScheduleSystem correctly drives NPC behavior across map transitions.
</verification>

<success_criteria>
- `guard` and `shopkeeper` templates added to `entities.json`.
- `guard_routine` and `shopkeeper_routine` added to `schedules.json` with 3+ states.
- `MapService` spawns NPCs in the village and interiors.
- NPCs follow their schedules based on world time.
- `tests/verify_village_population.py` passes.
</success_criteria>

<output>
After completion, create `.planning/phases/32-sleep-behavior-village-population/32-03-SUMMARY.md`
</output>
