---
phase: 09-data-driven-core
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified: ["map/tile.py", "map/map_generator_utils.py", "services/map_service.py", "tests/verify_tile_refactor.py"]
autonomous: true

must_haves:
  truths:
    - "Tile objects are initialized using type_id from registry."
    - "Map generation uses string IDs instead of character literals."
    - "Game continues to function identically (visuals, collision)."
  artifacts:
    - path: "map/tile.py"
      provides: "Tile class using TileRegistry"
    - path: "map/map_generator_utils.py"
      provides: "Updated draw_rectangle using type_ids"
    - path: "tests/verify_tile_refactor.py"
      provides: "Verification of new Tile behavior"
  key_links:
    - from: "map/tile.py"
      to: "map/tile_registry.py"
      via: "TileRegistry.get(type_id)"
    - from: "map/map_generator_utils.py"
      to: "map/tile.py"
      via: "Tile(type_id=...)"
---

<objective>
Refactor the core Tile class and map generation logic to use the new data-driven registry.

Purpose: Remove hardcoded tile properties and character checks from the codebase.
Output: Fully refactored map generation pipeline using JSON definitions.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-data-driven-core/09-RESEARCH.md
@.planning/phases/09-data-driven-core/09-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Tile class to use Registry</name>
  <files>map/tile.py</files>
  <action>
    Refactor `map/tile.py`:
    - Update `__init__` signature to accept `type_id: str` (and keep `transparent`/`sprites` as optional overrides or remove if bold).
    - If `type_id` is provided, fetch `TileType` from `TileRegistry`.
    - Initialize `self.transparent`, `self.walkable`, `self.sprites` (copy!), `self.color` from `TileType`.
    - Retain instance-specific state: `visibility_state`, `rounds_since_seen`.
    - Ensure `Tile.walkable` property logic is consistent with registry data (or removed if registry handles it directly).
  </action>
  <verify>
    Run `python3 tests/verify_resource_loader.py` (ensure registry still works).
    Create temporary test `tests/verify_tile_refactor.py` checking `Tile(type_id='floor_stone').walkable` is True.
  </verify>
  <done>
    `Tile` class instantiates from registry ID.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor Map Generation Utils</name>
  <files>map/map_generator_utils.py</files>
  <action>
    Update `map/map_generator_utils.py`:
    - Update `draw_rectangle` to accept `type_id` (str) instead of character.
    - Inside `draw_rectangle`, use `tile.set_type(type_id)` or replace the tile object with `Tile(type_id=type_id)`.
    - Update `place_door` to use `type_id="door_wood"` (or similar) instead of modifying sprites manually.
    - Ensure `Tile` has necessary methods/properties to support this.
  </action>
  <verify>
    Check for syntax errors.
  </verify>
  <done>
    `draw_rectangle` uses string IDs.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Map Service and Verify</name>
  <files>services/map_service.py, tests/verify_tile_refactor.py</files>
  <action>
    1. Update `services/map_service.py`:
       - Replace calls to `draw_rectangle(..., '.', ...)` with `draw_rectangle(..., 'floor_stone', ...)`.
       - Replace calls to `draw_rectangle(..., '#', ...)` with `draw_rectangle(..., 'wall_stone', ...)`.
       - Update `create_village_scenario` and `add_house_to_map` to use appropriate IDs.
    2. Enhance `tests/verify_tile_refactor.py`:
       - Verify that generated maps contain tiles with correct properties (walkable, transparent).
       - Ensure `Tile.walkable` returns correct values for walls vs floors.
       - Run existing tests `tests/verify_map_service.py` to ensure no regression.
  </action>
  <verify>
    Run `python3 tests/verify_tile_refactor.py`
    Run `python3 tests/verify_map_service.py`
  </verify>
  <done>
    Map generation works with new registry IDs and passes tests.
  </done>
</task>

</tasks>

<verification>
Run all tests to ensure the refactor didn't break existing functionality:
`python3 -m unittest discover tests`
</verification>

<success_criteria>
- `Tile` class depends on `TileRegistry`.
- `MapService` generates maps using "wall_stone" and "floor_stone".
- Unit tests pass confirming tile behavior matches expectations.
</success_criteria>

<output>
After completion, create `.planning/phases/09-data-driven-core/09-02-SUMMARY.md`
</output>
