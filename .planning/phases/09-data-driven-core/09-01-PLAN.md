---
phase: 09-data-driven-core
plan: 01
type: execute
wave: 1
depends_on: ["08-02"]
files_modified: ["assets/data/tile_types.json", "map/tile_registry.py", "services/resource_loader.py", "tests/verify_resource_loader.py"]
autonomous: true

must_haves:
  truths:
    - "Tile definitions can be loaded from a JSON file into a registry."
    - "ResourceLoader correctly maps JSON strings to SpriteLayer enums."
    - "TileRegistry provides access to TileType flyweights by ID."
  artifacts:
    - path: "assets/data/tile_types.json"
      provides: "Tile definitions (id, name, walkable, transparent, sprites, color)"
    - path: "map/tile_registry.py"
      provides: "TileType dataclass and TileRegistry container"
    - path: "services/resource_loader.py"
      provides: "Mechanism to parse JSON into TileRegistry"
  key_links:
    - from: "services/resource_loader.py"
      to: "assets/data/tile_types.json"
      via: "json.load()"
    - from: "services/resource_loader.py"
      to: "map/tile_registry.py"
      via: "TileRegistry.register()"
---

<objective>
Establish the data-driven infrastructure by creating the Tile Registry and Resource Loader.

Purpose: Separate tile properties from code to allow content-driven design.
Output: Working JSON-to-Registry pipeline with verification.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-data-driven-core/09-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tile_types.json and TileRegistry</name>
  <files>
    - assets/data/tile_types.json
    - map/tile_registry.py
  </files>
  <action>
    1. Create `assets/data/tile_types.json` with initial entries for:
       - `floor_stone` ('.', walkable=True, transparent=True)
       - `wall_stone` ('#', walkable=False, transparent=False)
       - `door_stone` ('.', walkable=True, transparent=True) - will be refined later
       - `roof_thatch` ('#', walkable=True, transparent=False, occludes_below=True)
    2. Create `map/tile_registry.py`:
       - Define `TileType` dataclass with fields: id, name, walkable, transparent, sprites (Dict[SpriteLayer, str]), color, occludes_below.
       - Implement `TileRegistry` class with `_registry` dict and `register(tile_type)`, `get(type_id)` methods.
  </action>
  <verify>
    - Check if files exist.
    - Run `python3 -c "from map.tile_registry import TileRegistry; print(TileRegistry._registry)"` (should be empty but valid).
  </verify>
  <done>
    `assets/data/tile_types.json` exists and `TileRegistry` is defined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement ResourceLoader</name>
  <files>services/resource_loader.py</files>
  <action>
    Implement `ResourceLoader.load_tiles(filepath)`:
    - Load JSON from file.
    - Parse each entry into a `TileType` object.
    - Convert sprite layer names (strings) to `SpriteLayer` enum keys.
    - Register each `TileType` in `TileRegistry`.
    - Handle missing files or malformed JSON gracefully with helpful errors.
  </action>
  <verify>
    - Verify `services/resource_loader.py` exists.
    - Check for `json` import and mapping logic.
  </verify>
  <done>
    `ResourceLoader` can populate `TileRegistry` from a JSON file.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify Loading pipeline</name>
  <files>tests/verify_resource_loader.py</files>
  <action>
    Create `tests/verify_resource_loader.py`:
    - Call `ResourceLoader.load_tiles("assets/data/tile_types.json")`.
    - Assert `TileRegistry.get("floor_stone")` returns correct properties.
    - Assert `TileRegistry.get("wall_stone")` returns correct properties.
    - Verify SpriteLayer keys are Enums, not strings.
  </action>
  <verify>
    Run `python3 tests/verify_resource_loader.py`
  </verify>
  <done>
    Full loading pipeline is verified working.
  </done>
</task>

</tasks>

<verification>
Run `python3 tests/verify_resource_loader.py` to ensure infrastructure is ready for the refactor.
</verification>

<success_criteria>
- `assets/data/tile_types.json` contains at least 4 tile types.
- `TileRegistry` successfully populates from JSON.
- `tests/verify_resource_loader.py` passes.
</success_criteria>

<output>
After completion, create `.planning/phases/09-data-driven-core/09-01-SUMMARY.md`
</output>
