---
phase: 36-feedback-information-hierarchy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [ecs/components.py, ecs/systems/fct_system.py, ecs/systems/render_system.py, game_states.py, ecs/systems/combat_system.py]
autonomous: true
must_haves:
  truths:
    - "Damage numbers float above entities when they take hits"
    - "FCT fades out and disappears after its TTL expires"
    - "FCT moves upwards smoothly over time"
  artifacts:
    - path: "ecs/systems/fct_system.py"
      provides: "FCT lifecycle management"
    - path: "ecs/components.py"
      contains: "class FCT"
---

<objective>
Implement the Floating Combat Text (FCT) infrastructure and logic.
Purpose: Provide immediate, dynamic visual feedback for combat events on the map.
Output: FCT component, FCTUpdateSystem, and combat integration.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-feedback-information-hierarchy/RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define FCT Component and System</name>
  <files>ecs/components.py, ecs/systems/fct_system.py</files>
  <action>
    1. Add FCT component to ecs/components.py:
       - Fields: text (str), color (Tuple[int, int, int]), vx (float), vy (float), ttl (float), max_ttl (float), offset_x (float = 0), offset_y (float = 0).
    2. Create ecs/systems/fct_system.py:
       - Implement FCTSystem(esper.Processor).
       - In process(dt), iterate over entities with FCT.
       - Update offsets: offset_x += vx * dt * 60, offset_y += vy * dt * 60.
       - Update TTL: ttl -= dt.
       - If ttl <= 0, delete the entity from the world.
  </action>
  <verify>FCT component exists and FCTSystem logic is implemented in the codebase.</verify>
  <done>FCT infrastructure is ready for integration.</done>
</task>

<task type="auto">
  <name>Task 2: Implement FCT Rendering and Integration</name>
  <files>ecs/systems/render_system.py, game_states.py, ecs/systems/combat_system.py</files>
  <action>
    1. Update RenderSystem.process in ecs/systems/render_system.py:
       - Iterate over entities with Position and FCT.
       - Calculate screen position: (pos.x * TILE_SIZE + offset_x, pos.y * TILE_SIZE + offset_y) adjusted by camera.
       - Calculate alpha: int(255 * max(0, ttl / max_ttl)).
       - Render the text using a small font (e.g., 16-20px) with the calculated alpha.
    2. Integrate FCTSystem in game_states.py:
       - In Game.startup, instantiate FCTSystem and add it to esper processors.
       - In Game.update(dt), update call to esper.process(dt) to ensure dt is passed to systems.
    3. Hook CombatSystem in ecs/systems/combat_system.py:
       - Import FCT and Position.
       - Create a helper _spawn_fct(self, target_entity, text, color) or call it directly.
       - Spawn an FCT entity when damage is dealt or an attack occurs.
       - Use random horizontal jitter (vx = random.uniform(-0.5, 0.5)) and upward velocity (vy = -1.5).
       - Set max_ttl and ttl to 1.0 (1 second).
  </action>
  <verify>Run the game, hit an enemy, and observe damage numbers floating upwards and fading.</verify>
  <done>FCT is visible and functional in combat.</done>
</task>

</tasks>

<success_criteria>
1. Damage numbers appear above entities upon taking damage.
2. Numbers float upwards and fade out over ~1 second.
3. Multiple hits result in jittered numbers (no perfect clumping).
</success_criteria>

<output>
After completion, create `.planning/phases/36-feedback-information-hierarchy/36-01-SUMMARY.md`
</output>
