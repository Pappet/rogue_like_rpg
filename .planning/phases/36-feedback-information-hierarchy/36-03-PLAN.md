---
phase: 36-feedback-information-hierarchy
plan: 03
type: execute
wave: 3
depends_on: [36-02]
files_modified: [config.py, game_states.py, services/input_manager.py, ui/windows/tooltip.py, ecs/systems/render_system.py]
autonomous: false
must_haves:
  truths:
    - "Examine mode allows moving a cursor to tiles and seeing what's there"
    - "Tooltips show detailed name, stats, and description for entities"
    - "Examine mode captures input and blocks player movement"
  artifacts:
    - path: "ui/windows/tooltip.py"
      provides: "TooltipWindow implementation"
---

<objective>
Implement an "Examine" mode for detailed entity and item inspection.
Purpose: Provide transparency for map objects and enemies, reducing guesswork.
Output: EXAMINE state, TooltipWindow, and examine cursor logic.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-feedback-information-hierarchy/RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Examine State and Input</name>
  <files>config.py, services/input_manager.py, game_states.py</files>
  <action>
    1. Add EXAMINE to GameStates enum in config.py.
    2. Update InputManager in services/input_manager.py:
       - Add EXAMINE_ITEM to InputCommand.
       - Add 'x' key mapping for EXAMINE_ITEM to PLAYER_TURN state.
       - Add EXAMINE state mappings (arrows, ESC, RETURN).
    3. Update Game class in game_states.py:
       - Implement handle_examine_input(command).
       - Logic for triggering examine mode (similar to targeting but mode='inspect').
       - Manage examine cursor position.
       - Transition to GameStates.EXAMINE and ensure movement is blocked.
  </action>
  <verify>Pressing 'x' enters examine mode. ESC exits. Arrows move the cursor.</verify>
  <done>Examine state and basic navigation are functional.</done>
</task>

<task type="auto">
  <name>Task 2: Tooltip UI and Inspection Logic</name>
  <files>ui/windows/tooltip.py, game_states.py, ecs/systems/render_system.py</files>
  <action>
    1. Create ui/windows/tooltip.py:
       - TooltipWindow inherits from UIWindow (ui/windows/base.py).
       - Takes an entity ID (or list of entities).
       - Fetches Name, Stats, Description, Portable components.
       - Renders a multi-line box with health bars, stats, and description text.
       - Use UI_COLOR_BG_SIDEBAR for the tooltip background and draw borders.
    2. Update Game.draw and Game.update in game_states.py:
       - In EXAMINE mode, update and draw the TooltipWindow using the UIStack.
       - Update the tooltip content (re-instantiate or update the window) whenever the cursor moves.
       - Handle cases where multiple entities are on the same tile (list them or cycle).
    3. Update RenderSystem in ecs/systems/render_system.py:
       - Ensure draw_targeting_ui supports "inspect" mode properly (color: Cyan).
  </action>
  <verify>Entering examine mode and moving cursor over an NPC/Item shows a detailed tooltip window.</verify>
  <done>Examine mode tooltips are fully functional.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Examine Mode and Tooltips</what-built>
  <how-to-verify>
    1. Enter the game.
    2. Press 'x' to enter Examine mode.
    3. Move the cursor over yourself (player), a monster, or an item on the ground.
    4. Confirm that a tooltip appears with the entity's details (Name, HP/Stats, Description).
    5. Confirm that the tooltip disappears/exits when pressing ESC.
    6. Confirm that movement is impossible while in examine mode.
  </how-to-verify>
  <resume-signal>approved</resume-signal>
</task>

</tasks>

<success_criteria>
1. Player can toggle "Examine" mode with the 'x' key.
2. Examination cursor moves independently of the player.
3. Hovering over entities displays a tooltip with name, health, and description.
4. Hovering over items displays a tooltip with name and weight.
</success_criteria>

<output>
After completion, create `.planning/phases/36-feedback-information-hierarchy/36-03-SUMMARY.md`
</output>
