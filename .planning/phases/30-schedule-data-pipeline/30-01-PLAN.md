---
phase: 30-schedule-data-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [entities/schedule_registry.py, ecs/components.py, entities/entity_registry.py]
autonomous: true

must_haves:
  truths:
    - "ScheduleEntry and ScheduleTemplate dataclasses exist"
    - "ScheduleRegistry singleton exists and can store/retrieve templates"
    - "EntityTemplate supports optional schedule_id"
    - "Schedule component exists for ECS entities"
  artifacts:
    - path: "entities/schedule_registry.py"
      provides: "Schedule data structures and registry"
    - path: "ecs/components.py"
      provides: "Schedule component"
    - path: "entities/entity_registry.py"
      provides: "Updated EntityTemplate"
  key_links:
    - from: "entities/entity_registry.py"
      to: "entities/schedule_registry.py"
      via: "ID reference"
---

<objective>
Establish the data structures and registry for NPC schedules. This provides the foundation for loading schedule data from JSON files and associating them with entity templates.

Purpose: Decouple schedule definitions from hardcoded logic, allowing for data-driven NPC routines.
Output: ScheduleRegistry, Schedule component, and updated EntityTemplate.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@entities/entity_registry.py
@ecs/components.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Schedule Registry</name>
  <files>entities/schedule_registry.py</files>
  <action>
    Create a new file `entities/schedule_registry.py`.
    Implement `ScheduleEntry` dataclass with fields:
    - `start`: int (0-23)
    - `end`: int (0-23)
    - `activity`: str
    - `target_pos`: Optional[Tuple[int, int]]
    - `target_meta`: Optional[str]

    Implement `ScheduleTemplate` dataclass with fields:
    - `id`: str
    - `name`: str
    - `entries`: List[ScheduleEntry]

    Implement `ScheduleRegistry` class with:
    - `_registry`: Dict[str, ScheduleTemplate]
    - `register(template: ScheduleTemplate)`
    - `get(template_id: str) -> Optional[ScheduleTemplate]`
    - `clear()`
    - `all_ids()`
  </action>
  <verify>Check file existence and verify classes are defined via `grep` or temporary python script.</verify>
  <done>ScheduleRegistry and related dataclasses are implemented and ready for use.</done>
</task>

<task type="auto">
  <name>Task 2: Update Components and EntityTemplate</name>
  <files>ecs/components.py, entities/entity_registry.py</files>
  <action>
    1. In `ecs/components.py`:
       Add `Schedule` dataclass component:
       ```python
       @dataclass
       class Schedule:
           schedule_id: str
       ```
    2. In `entities/entity_registry.py`:
       Add `schedule_id: Optional[str] = None` to `EntityTemplate` dataclass.
  </action>
  <verify>Verify `Schedule` component exists in `ecs/components.py` and `EntityTemplate` has `schedule_id` field.</verify>
  <done>ECS components and EntityTemplate are updated to support schedule associations.</done>
</task>

</tasks>

<verification>
Ensure all files are saved and types are correctly imported where needed.
Run a quick test script to verify registry registration and retrieval.
</verification>

<success_criteria>
1. `entities/schedule_registry.py` defines the necessary data structures.
2. `ScheduleRegistry` can store and retrieve `ScheduleTemplate` objects.
3. `EntityTemplate` includes a `schedule_id` field.
4. `Schedule` component is available for ECS entities.
</success_criteria>

<output>
After completion, create `.planning/phases/30-schedule-data-pipeline/30-01-SUMMARY.md`
</output>
