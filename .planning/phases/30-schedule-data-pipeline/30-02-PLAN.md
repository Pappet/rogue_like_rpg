---
phase: 30-schedule-data-pipeline
plan: 02
type: execute
wave: 2
depends_on: [30-01]
files_modified: [services/resource_loader.py, main.py, assets/data/schedules.json, assets/data/entities.json, entities/entity_factory.py]
autonomous: true

must_haves:
  truths:
    - "ResourceLoader can load schedules from JSON"
    - "EntityTemplate loads schedule_id from entities.json"
    - "Game startup loads schedule data before entities"
    - "EntityFactory attaches Schedule component to entities with schedule_id"
  artifacts:
    - path: "assets/data/schedules.json"
      provides: "Schedule data"
    - path: "services/resource_loader.py"
      provides: "Data loading logic for schedules"
    - path: "entities/entity_factory.py"
      provides: "Schedule component attachment"
  key_links:
    - from: "main.py"
      to: "services/resource_loader.py"
      via: "ResourceLoader.load_schedules call"
---

<objective>
Implement the loading of schedule data from JSON and integrate it into the game startup and entity creation process.

Purpose: Complete the data pipeline from JSON file to ECS entity.
Output: load_schedules implementation, schedules.json file, and updated main.py/entity_factory.py.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-schedule-data-pipeline/30-01-SUMMARY.md
@services/resource_loader.py
@main.py
@entities/entity_factory.py
@assets/data/entities.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Schedule Loading</name>
  <files>services/resource_loader.py, entities/entity_factory.py</files>
  <action>
    1. In `services/resource_loader.py`:
       - Import `ScheduleRegistry` and `ScheduleTemplate`, `ScheduleEntry`.
       - Implement `load_schedules(filepath: str)` static method. It should:
         - Read the JSON array from `filepath`.
         - For each item, validate required fields (`id`, `name`, `entries`).
         - Parse `entries` into `ScheduleEntry` objects (handling optional `target_pos` and `target_meta`).
         - Register the `ScheduleTemplate` in `ScheduleRegistry`.
       - Update `load_entities(filepath: str)`:
         - Parse `schedule_id` from the entity JSON (using `item.get("schedule_id")`).
         - Pass `schedule_id` to `EntityTemplate` constructor.
    2. In `entities/entity_factory.py`:
       - Import `Schedule` from `ecs.components`.
       - In `create()`, if `template.schedule_id` is truthy, append `Schedule(template.schedule_id)` to the `components` list.
  </action>
  <verify>Verify `load_schedules` exists and `load_entities` includes `schedule_id`. Verify `EntityFactory` attaches `Schedule` component.</verify>
  <done>Resource loading and factory logic are updated to handle schedules.</done>
</task>

<task type="auto">
  <name>Task 2: Create Data and Update Main</name>
  <files>assets/data/schedules.json, main.py, assets/data/entities.json</files>
  <action>
    1. Create `assets/data/schedules.json` with a sample routine:
       ```json
       [
         {
           "id": "villager_routine",
           "name": "Standard Villager Day",
           "entries": [
             { "start": 0, "end": 6, "activity": "sleep", "target_meta": "home" },
             { "start": 6, "end": 22, "activity": "work", "target_pos": [15, 15] },
             { "start": 22, "end": 24, "activity": "sleep", "target_meta": "home" }
           ]
         }
       ]
       ```
    2. In `main.py`:
       - In `GameController.__init__`, call `ResourceLoader.load_schedules("assets/data/schedules.json")` before `load_entities`.
    3. In `assets/data/entities.json`:
       - Add `"schedule_id": "villager_routine"` to an entity (e.g., orc for testing, or add a new test entity).
  </action>
  <verify>Verify files exist and `main.py` has the new call. Run game to ensure no crashes during startup.</verify>
  <done>Schedule data is defined and loaded during game startup.</done>
</task>

</tasks>

<verification>
Start the game and ensure it loads without errors.
Check the console for any warning messages from ResourceLoader.
</verification>

<success_criteria>
1. `ResourceLoader.load_schedules` correctly populates `ScheduleRegistry`.
2. `ResourceLoader.load_entities` correctly associates `schedule_id` with entity templates.
3. `assets/data/schedules.json` contains valid schedule data.
4. `main.py` successfully loads schedule data on startup.
5. Entities created from templates with `schedule_id` have a `Schedule` component.
</success_criteria>

<output>
After completion, create `.planning/phases/30-schedule-data-pipeline/30-02-SUMMARY.md`
</output>
