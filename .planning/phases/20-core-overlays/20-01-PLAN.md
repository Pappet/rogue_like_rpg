---
wave: 1
depends_on: 19
autonomous: true
files_modified:
- ecs/systems/debug_render_system.py
- config.py
---

# Plan 20-01: Implement Core Debug Overlays

This plan implements the visual components of the debug system: FOV visualization, AI state labels, and chase target markers.

## Tasks

- [x] **Define Debug Configuration**
  - <!-- file: config.py -->
  - Add `DEBUG_FOV_COLOR = (0, 255, 0, 50)`
  - Add `DEBUG_CHASE_COLOR = (255, 165, 0)`
  - Add `DEBUG_LABEL_COLOR = (255, 255, 255)`
  - Add `DEBUG_FONT_SIZE = 12`

- [x] **Extend DebugRenderSystem with FOV Overlay**
  - <!-- file: ecs/systems/debug_render_system.py -->
  - Add `_render_fov_overlay(self, game_map, camera)` method.
  - In `process`, call this method before entity overlays.
  - Iterate `game_map.visible` tiles.
  - Draw a semi-transparent green rectangle (`(0, 255, 0, 50)`) on `self.overlay_surface` for each visible tile.
  - Ensure coordinates are adjusted by `camera.x, camera.y`.
  - **Constraint:** Use `pygame.draw.rect` on the pre-allocated alpha surface.

- [x] **Implement AI State Labels**
  - <!-- file: ecs/systems/debug_render_system.py -->
  - Add `_render_ai_labels(self, world, camera)` method.
  - Query entities with `AIBehaviorState`, `Position`.
  - For each entity:
    - Get current state name (e.g., "Wander", "Chase").
    - Map to short code: W (Wander), C (Chase), I (Idle), T (Tech/Other).
    - Render text using `self.font` (White, size 12-14).
    - Blit text at `(screen_x, screen_y - 10)` (above sprite).
  - Call in `process`.

- [x] **Implement Chase Target Markers**
  - <!-- file: ecs/systems/debug_render_system.py -->
  - Add `_render_chase_targets(self, world, camera)` method.
  - Query entities with `ChaseData` (and `AIBehaviorState` to confirm state is CHASE).
  - For each chasing entity:
    - Get `last_known_x`, `last_known_y` from component.
    - Draw an orange outline rectangle (`(255, 165, 0)`, width 2) at that tile location (camera adjusted).
  - Call in `process`.

- [x] **Verify Z-Order and Clipping**
  - <!-- file: ecs/systems/debug_render_system.py -->
  - Ensure `process` calls:
    1. `overlay_surface.fill((0,0,0,0))`
    2. `_render_fov_overlay` (bottom)
    3. `_render_chase_targets`
    4. `_render_ai_labels` (top)
    5. `display_surface.blit(overlay_surface)`
  - Confirm `main.py` clips the viewport before calling `debug_render_system.process`.

## Verification

### Automated Tests
- None (Visual features are hard to unit test without screenshot diffing).
- Use manual verification steps below.

### Manual Verification
1. **FOV Overlay:**
   - Run game, enable debug (F1/F3).
   - Verify green tint appears on visible floor tiles.
   - Walk around; tint should update instantly.
   - Verify tint does NOT appear on non-visible (explored or unseen) tiles.

2. **AI Labels:**
   - Spawn monsters.
   - Enable debug.
   - Observe "W" above wandering monsters.
   - Provoke a monster -> label changes to "C".
   - Break line of sight -> label remains "C" (until state changes).

3. **Chase Targets:**
   - Get chased by a monster.
   - Break line of sight (move around corner).
   - Observe orange box at your *last visible position*.
   - Move again (while hidden) -> orange box stays.
   - Let monster see you -> orange box jumps to your new position.

4. **Performance & Clipping:**
   - Toggle debug on/off rapidly. Frame rate should be stable.
   - Move camera near edge of map/ui. Debug visuals should NOT draw over the UI sidebar or log.
