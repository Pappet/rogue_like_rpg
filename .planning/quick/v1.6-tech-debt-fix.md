---
phase: tech-debt
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [config.py, ui/message_log.py, ui/windows/inventory.py, ui/windows/character.py]
autonomous: true
---

<objective>
Address technical debt identified in the v1.6 Audit by fixing input leaks and centralizing magic numbers/colors into config.py.
</objective>

<execution_context>
@/home/peter/.gemini/get-shit-done/workflows/execute-plan.md
@/home/peter/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@config.py
@ui/message_log.py
@ui/windows/inventory.py
@ui/windows/character.py
</context>

<tasks>

<task type="auto">
  <name>Centralize UI Constants in config.py</name>
  <files>config.py</files>
  <action>
    Add generic color constants and UI window specific colors to config.py.
    
    1. Define generic colors (COLOR_WHITE, COLOR_RED, COLOR_YELLOW, etc.) to be used across the UI.
    2. Define UI_COLOR_WINDOW_BG, UI_COLOR_WINDOW_BORDER, UI_COLOR_WINDOW_SEPARATOR.
    3. Define UI_COLOR_WINDOW_TITLE, UI_COLOR_WINDOW_TEXT, UI_COLOR_WINDOW_TEXT_DIM, UI_COLOR_WINDOW_SELECTED.
    4. Define UI_COLOR_WINDOW_HIGHLIGHT, UI_COLOR_WINDOW_HINT, UI_COLOR_WINDOW_ERROR.
    5. Define UI_COLOR_LOG_BG and UI_COLOR_LOG_BORDER.
    
    Ensure existing LOG_COLORS and other UI constants are preserved or integrated.
  </action>
  <verify>Check config.py for the new constants.</verify>
  <done>Constants are defined in config.py.</done>
</task>

<task type="auto">
  <name>Refactor Message Log and Windows to use Constants</name>
  <files>ui/message_log.py, ui/windows/inventory.py, ui/windows/character.py</files>
  <action>
    1. Update ui/message_log.py:
       - Import constants from config.py.
       - Remove local color definitions.
       - Update COLOR_MAP to use config constants.
       - Use UI_COLOR_LOG_BG and UI_COLOR_LOG_BORDER in draw().
    2. Update ui/windows/inventory.py:
       - Import UI_COLOR_WINDOW_* constants from config.py.
       - Replace magic tuples in draw() with these constants.
       - Use UI_MARGIN or similar constants for spacing where applicable.
    3. Update ui/windows/character.py:
       - Import UI_COLOR_WINDOW_* constants from config.py.
       - Replace magic tuples in draw() with these constants.
  </action>
  <verify>Run the game and verify that UI rendering is identical to before.</verify>
  <done>UI code no longer uses magic tuples for colors.</done>
</task>

<task type="auto">
  <name>Fix Input Leak in CharacterWindow</name>
  <files>ui/windows/character.py</files>
  <action>
    Modify CharacterWindow.handle_event to consume all KEYDOWN events.
    Currently, if a key is not 'C' or a mapped command (CANCEL/OPEN_INVENTORY), it returns False, allowing the event to reach the game world.
    
    Update handle_event to:
    1. Check for close conditions ('C' key, CANCEL command, OPEN_INVENTORY command).
    2. Set wants_to_close = True if close condition met.
    3. Return True for ALL pygame.KEYDOWN events to prevent input leakage.
  </action>
  <verify>
    1. Open Character Sheet.
    2. Press movement keys (W/A/S/D).
    3. Verify the player does NOT move in the background.
    4. Verify 'C' or ESC still closes the window.
  </verify>
  <done>Keyboard events no longer leak to the game world when Character Sheet is open.</done>
</task>

</tasks>

<verification>
Check for any remaining magic numbers in the modified files.
Verify input blocking in both Inventory and Character windows (Inventory already seemed to return True mostly, but check it too).
</verification>

<success_criteria>
1. ui/windows/character.py returns True for all KEYDOWN events.
2. Magic color tuples are replaced by constants from config.py in the specified files.
3. UI continues to function as expected.
</success_criteria>

<output>
After completion, create `.planning/phases/tech-debt/tech-debt-01-SUMMARY.md` (or relevant summary in .planning/quick/).
</output>
